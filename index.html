<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Alianza Estratégica | Estudio IA + Agencia Creativa</title>
    <!-- Librería para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #0f172a;
            --primary-blue: #3b82f6;
            --primary-blue-dark: #2563eb;
            --accent-green: #10b981;
            --accent-gold: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --white: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            color: var(--gray-700);
            line-height: 1.6;
            min-height: 100vh;
            padding: 1.5rem;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #1e3a5f 50%, var(--primary-blue) 100%);
            color: var(--white);
            padding: 2.5rem;
            border-radius: var(--radius-xl);
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        header h1 {
            font-size: 2.25rem;
            margin-bottom: 0.5rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            position: relative;
        }

        header p {
            opacity: 0.85;
            font-size: 1.1rem;
            font-weight: 500;
            position: relative;
        }

        /* Menú de navegación lateral */
        .nav-menu {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-menu-inner {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
            box-shadow: var(--shadow-lg);
            padding: 0.75rem 0.5rem;
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: thin;
            transition: all var(--transition-base);
            opacity: 0.3;
            transform: translateX(-75%);
            border: 1px solid var(--gray-200);
            border-left: none;
        }

        .nav-menu-inner:hover,
        .nav-menu.expanded .nav-menu-inner {
            opacity: 1;
            transform: translateX(0);
        }

        .nav-menu-inner::-webkit-scrollbar {
            width: 3px;
        }

        .nav-menu-inner::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .nav-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .nav-group-label {
            font-size: 0.55rem;
            font-weight: 700;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gray-500);
            text-decoration: none;
            white-space: nowrap;
            transition: all var(--transition-fast);
        }

        .nav-item:hover {
            background: var(--gray-100);
            color: var(--primary-blue);
            transform: scale(1.1);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .nav-actions {
            display: none;
        }

        .nav-toggle {
            display: none;
        }

        /* Botones flotantes expandir/colapsar */
        .floating-actions {
            position: fixed;
            bottom: 2rem;
            left: 1rem;
            z-index: 101;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .floating-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: var(--shadow-lg), 0 0 0 1px rgba(0,0,0,0.05);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all var(--transition-fast);
            color: var(--gray-600);
            position: relative;
        }

        .floating-btn:hover {
            transform: scale(1.15);
            box-shadow: var(--shadow-xl), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .floating-btn.expand {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
        }

        .floating-btn.expand:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: var(--shadow-xl), 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .floating-btn.collapse {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #d97706;
        }

        .floating-btn.collapse:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: var(--shadow-xl), 0 0 20px rgba(245, 158, 11, 0.4);
        }

        .floating-btn[title]:hover::after {
            content: attr(title);
            position: absolute;
            left: 56px;
            background: var(--primary-dark);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: var(--shadow-md);
        }

        @media (max-width: 768px) {
            .nav-menu-inner {
                max-height: 50vh;
                font-size: 0.6rem;
            }

            .floating-actions {
                bottom: 1rem;
                left: 0.5rem;
            }

            .floating-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            border: 1px solid var(--gray-100);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 1.5rem;
            bottom: 1.5rem;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-blue) 0%, var(--accent-green) 100%);
            border-radius: 0 4px 4px 0;
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--gray-200);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card.collapsed:hover {
            transform: none;
        }

        .card.collapsed::before {
            opacity: 0;
        }

        /* Header colapsable */
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin: -1.75rem -1.75rem 1.5rem -1.75rem;
            padding: 1.25rem 1.75rem;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            transition: all var(--transition-fast);
            border-bottom: 1px solid transparent;
        }

        .card-header:hover {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        }

        .card.collapsed .card-header {
            margin-bottom: -1.75rem;
            border-radius: var(--radius-xl);
            border-bottom: none;
        }

        .card-header h2 {
            font-size: 1.15rem;
            margin: 0;
            color: var(--primary-dark);
            border-bottom: none;
            padding-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
        }

        .card-toggle {
            background: var(--gray-100);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            color: var(--gray-500);
        }

        .card-toggle:hover {
            background: var(--primary-blue);
            color: white;
        }

        .card-toggle:hover {
            background: var(--gray-100);
            color: var(--primary-blue);
        }

        .card.collapsed .card-toggle {
            transform: rotate(-90deg);
        }

        /* Contenido colapsable */
        .card-content {
            transition: all 0.3s ease;
        }

        .card.collapsed .card-content {
            display: none;
        }

        /* Resumen colapsado */
        .card-summary {
            display: none;
            margin: 1rem -1.75rem -1.75rem -1.75rem;
            padding: 1rem 1.75rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            font-size: 0.85rem;
            color: var(--gray-700);
            border-top: 1px solid var(--gray-200);
        }

        .card.collapsed .card-summary {
            display: block;
        }

        .card-summary-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .card-summary-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.6rem 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            transition: all var(--transition-fast);
        }

        .card-summary-item:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .card-summary-item .label {
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        .card-summary-item .value {
            font-weight: 600;
            color: var(--primary-dark);
        }

        /* Cards sin header colapsable (mantener estilo original) */
        .card:not(.collapsible) h2 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--primary-dark);
            border-bottom: 3px solid var(--primary-blue);
            padding-bottom: 0.5rem;
        }

        .card.collapsible h2 {
            border-bottom: none;
            padding-bottom: 0;
        }

        .form-group {
            margin-bottom: 1.75rem;
        }

        label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            letter-spacing: 0.01em;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--gray-200) 0%, var(--gray-300) 100%);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            background: var(--white);
            color: var(--gray-700);
        }

        input[type="text"]:hover,
        input[type="number"]:hover,
        select:hover {
            border-color: var(--gray-300);
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .value-display {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%);
            color: var(--white);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            color: var(--white);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-700);
            color: var(--white);
            border-color: var(--gray-700);
        }

        .projects-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .projects-table th,
        .projects-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-100);
        }

        .projects-table tr:last-child td {
            border-bottom: none;
        }

        .projects-table tr:hover td {
            background: var(--gray-50);
        }

        .projects-table th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--primary-dark);
        }

        .projects-table tbody tr:hover {
            background: var(--gray-50);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-interno {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-cliente {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-new {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 0.5rem;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Estilos del módulo de licencias */
        .cost-section.licenses {
            border-color: #fcd34d;
            background: linear-gradient(135deg, #fff 0%, #fffbeb 100%);
        }

        .license-form-container {
            background: var(--white);
            border-radius: var(--radius-md);
            padding: 1rem;
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }

        .license-form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.75rem;
            align-items: end;
        }

        .license-form-grid .form-group {
            margin-bottom: 0;
        }

        .license-form-grid .form-group label {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
            display: block;
        }

        .license-form-grid input,
        .license-form-grid select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .license-form-grid input:focus,
        .license-form-grid select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .license-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed var(--gray-200);
        }

        .license-presets span {
            font-size: 0.8rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .preset-license-btn {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fcd34d;
            padding: 0.35rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #92400e;
            font-weight: 500;
        }

        .preset-license-btn:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #d97706;
            transform: translateY(-1px);
        }

        .license-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .license-projection-container {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: var(--radius-md);
            border: 1px solid #fcd34d;
        }

        .license-projection-container h4 {
            margin-bottom: 1rem;
            color: #92400e;
            font-size: 1rem;
        }

        .license-projection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .license-results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .license-form-grid {
                grid-template-columns: 1fr 1fr;
            }
            .license-form-grid .form-group:first-child {
                grid-column: span 2;
            }
            .license-summary-grid,
            .license-projection-grid,
            .license-results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .license-form-grid {
                grid-template-columns: 1fr;
            }
            .license-form-grid .form-group:first-child {
                grid-column: span 1;
            }
            .license-summary-grid,
            .license-projection-grid,
            .license-results-grid {
                grid-template-columns: 1fr;
            }
        }

        #licensesTable .btn-delete {
            background: #fee2e2;
            border: none;
            color: #dc2626;
            width: 30px;
            height: 30px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        #licensesTable .btn-delete:hover {
            background: #dc2626;
            color: white;
            transform: scale(1.05);
        }

        #licensesTable input[type="number"] {
            width: 70px;
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            text-align: center;
        }

        #licensesTable input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15);
        }

        #licensesTable td {
            vertical-align: middle;
        }

        #licensesTable .positive {
            color: var(--accent-green);
        }

        #licensesTable .negative {
            color: var(--accent-red);
        }

        .license-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .license-type-badge.one-time {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .license-type-badge.monthly {
            background: #d1fae5;
            color: #047857;
        }

        .license-type-badge.annual {
            background: #fef3c7;
            color: #92400e;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.25rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 1.75rem;
            border-radius: var(--radius-xl);
            text-align: center;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.25);
        }

        .summary-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.15) 0%, transparent 60%);
        }

        .summary-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.35);
        }

        .summary-item.green {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
        }

        .summary-item.green:hover {
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
        }

        .summary-item.gold {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.25);
        }

        .summary-item.gold:hover {
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.35);
        }

        .summary-item h3 {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.025em;
            position: relative;
        }

        .summary-item .amount {
            font-size: 2.25rem;
            font-weight: 800;
            position: relative;
            letter-spacing: -0.025em;
        }

        .chart-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border-radius: var(--radius-xl);
            border: 1px solid var(--gray-200);
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 250px;
            gap: 1rem;
            margin-top: 1rem;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(180deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            border-radius: 0.5rem 0.5rem 0 0;
            position: relative;
            min-height: 20px;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }

        .chart-bar.green {
            background: linear-gradient(180deg, var(--accent-green) 0%, #059669 100%);
        }

        .chart-bar.gold {
            background: linear-gradient(180deg, var(--accent-gold) 0%, #d97706 100%);
        }

        .chart-bar-label {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chart-bar-value {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 700;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .scenario-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }

            .summary-item .amount {
                font-size: 1.5rem;
            }

            .projects-table {
                font-size: 0.85rem;
            }

            .chart-bars {
                height: 200px;
            }
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .input-group input,
        .input-group select {
            flex: 1;
        }

        .equity-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 640px) {
            .equity-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-box {
            background: #eff6ff;
            border-left: 4px solid var(--primary-blue);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .retainer-details {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid var(--primary-blue);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-top: 1rem;
        }

        .retainer-details h4 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .hours-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .hours-stat {
            text-align: center;
            background: var(--white);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .hours-stat .number {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .hours-stat .label {
            font-size: 0.8rem;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .hours-stat.highlight {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
        }

        .hours-stat.highlight .number,
        .hours-stat.highlight .label {
            color: var(--white);
        }

        .hours-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--white);
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }

        .hours-scale-item {
            text-align: center;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .hours-scale-item.active {
            opacity: 1;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .toggle-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .toggle-btn {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            background: var(--white);
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: var(--white);
        }

        .toggle-btn:hover:not(.active) {
            border-color: var(--primary-blue);
        }

        @media (max-width: 640px) {
            .hours-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos mejorados para Equity */
        .equity-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .equity-section {
                grid-template-columns: 1fr;
            }
        }

        .equity-company {
            background: var(--gray-50);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid var(--gray-200);
        }

        .equity-company.studio {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .equity-company.agency {
            border-color: var(--accent-green);
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }

        .equity-company h4 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .equity-company.studio h4 {
            color: var(--primary-blue);
        }

        .equity-company.agency h4 {
            color: #059669;
        }

        .equity-inputs {
            display: grid;
            gap: 1rem;
        }

        .equity-result {
            background: var(--white);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .equity-result-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .equity-result-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .equity-result-row.profit {
            color: var(--accent-green);
        }

        .equity-result-row .label {
            color: var(--gray-700);
        }

        .equity-result-row .value {
            font-weight: 600;
        }

        .equity-config {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--gray-200);
        }

        .equity-config h4 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .equity-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .equity-summary-card {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #d97706 100%);
            color: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .equity-summary-card.total {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
        }

        .equity-summary-card h5 {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .equity-summary-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .arrow-icon {
            display: inline-block;
            margin: 0 0.5rem;
        }

        .scenario-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .scenario-tag.sale {
            background: #fef3c7;
            color: #92400e;
        }

        /* Vesting Breakdown */
        .vesting-breakdown {
            margin-top: 1.5rem;
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid var(--gray-200);
        }

        .vesting-breakdown h5 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .vesting-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .vesting-stat {
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid var(--gray-200);
        }

        .vesting-stat.highlight {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: var(--accent-green);
        }

        .vesting-stat .number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .vesting-stat.highlight .number {
            color: #059669;
        }

        .vesting-stat .label {
            font-size: 0.8rem;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .vesting-timeline {
            margin-top: 1rem;
        }

        .vesting-timeline h6 {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .timeline-bar {
            height: 24px;
            background: var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
        }

        .timeline-cliff {
            background: #fecaca;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: #991b1b;
        }

        .timeline-vesting {
            background: linear-gradient(90deg, var(--accent-green) 0%, #34d399 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
        }

        .timeline-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-700);
        }

        .vesting-table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .vesting-table th,
        .vesting-table td {
            padding: 0.5rem;
            text-align: right;
            border-bottom: 1px solid var(--gray-200);
        }

        .vesting-table th {
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
        }

        .vesting-table th:first-child {
            text-align: left;
        }

        .vesting-table td:first-child {
            text-align: left;
        }

        .vesting-table tr:last-child {
            font-weight: 700;
            background: var(--gray-50);
        }

        /* Proyección Temporal */
        .projection-container {
            margin-top: 1.5rem;
        }

        .projection-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .projection-controls label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .projection-chart {
            position: relative;
            height: 350px;
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
        }

        .chart-area {
            display: flex;
            align-items: flex-end;
            height: 250px;
            gap: 2px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--gray-300);
            border-left: 2px solid var(--gray-300);
            position: relative;
        }

        .chart-bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            min-width: 20px;
            position: relative;
        }

        .chart-bar-stack {
            width: 100%;
            max-width: 40px;
            height: 200px;
            display: flex;
            flex-direction: column-reverse;
        }

        .chart-segment {
            width: 100%;
            transition: all 0.3s ease;
            position: relative;
        }

        .chart-segment:hover {
            opacity: 0.8;
            transform: scaleX(1.1);
        }

        .chart-segment.retainer {
            background: linear-gradient(180deg, var(--primary-blue) 0%, #1d4ed8 100%);
        }

        .chart-segment.ip {
            background: linear-gradient(180deg, var(--accent-green) 0%, #059669 100%);
        }

        .chart-segment.finder {
            background: linear-gradient(180deg, var(--accent-gold) 0%, #d97706 100%);
        }

        .chart-segment.equity {
            background: linear-gradient(180deg, #8b5cf6 0%, #6d28d9 100%);
        }

        .chart-x-label {
            position: absolute;
            bottom: -25px;
            font-size: 0.7rem;
            color: var(--gray-700);
            text-align: center;
            width: 100%;
        }

        .chart-y-axis {
            position: absolute;
            left: -50px;
            top: 0;
            bottom: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--gray-700);
        }

        .chart-legend {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.retainer { background: var(--primary-blue); }
        .legend-color.ip { background: var(--accent-green); }
        .legend-color.finder { background: var(--accent-gold); }
        .legend-color.equity { background: #8b5cf6; }

        .projection-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .projection-stat {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .projection-stat .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .projection-stat .label {
            font-size: 0.8rem;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .cumulative-line {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            height: calc(100% - 30px);
            pointer-events: none;
        }

        .cumulative-line svg {
            width: 100%;
            height: 100%;
        }

        .cumulative-line path {
            fill: none;
            stroke: #ef4444;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .tooltip {
            position: absolute;
            background: var(--primary-dark);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
            white-space: nowrap;
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Comparador de Escenarios */
        .comparator-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .comparator-controls .btn {
            flex: 1;
            min-width: 150px;
        }

        .scenarios-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .scenario-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .scenario-card.empty {
            border-style: dashed;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            cursor: pointer;
        }

        .scenario-card.empty:hover {
            border-color: var(--primary-blue);
            background: var(--gray-50);
        }

        .scenario-card.slot-a {
            border-color: var(--primary-blue);
        }

        .scenario-card.slot-b {
            border-color: var(--accent-green);
        }

        .scenario-card.slot-c {
            border-color: var(--accent-gold);
        }

        .scenario-header {
            padding: 1rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scenario-header.slot-a {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        }

        .scenario-header.slot-b {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
        }

        .scenario-header.slot-c {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #d97706 100%);
        }

        .scenario-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .scenario-header .delete-scenario {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scenario-header .delete-scenario:hover {
            background: rgba(255,255,255,0.4);
        }

        .scenario-body {
            padding: 1rem;
        }

        .scenario-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }

        .scenario-metric:last-child {
            border-bottom: none;
        }

        .scenario-metric .label {
            color: var(--gray-700);
        }

        .scenario-metric .value {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .scenario-metric.highlight {
            background: #fef3c7;
            margin: 0 -1rem;
            padding: 0.5rem 1rem;
        }

        .scenario-metric.best .value {
            color: var(--accent-green);
        }

        .scenario-metric.worst .value {
            color: #ef4444;
        }

        .scenario-total {
            background: var(--gray-50);
            margin: 0.5rem -1rem -1rem -1rem;
            padding: 1rem;
            text-align: center;
        }

        .scenario-total .amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .scenario-total .label {
            font-size: 0.8rem;
            color: var(--gray-700);
        }

        .empty-slot-content {
            text-align: center;
            color: var(--gray-700);
        }

        .empty-slot-content .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .comparison-insights {
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 0.75rem;
            border: 2px solid var(--primary-blue);
        }

        .comparison-insights h4 {
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
        }

        .insight-item .icon {
            font-size: 1.25rem;
        }

        .insight-item .text {
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .insight-item .text strong {
            color: var(--primary-dark);
        }

        /* Calculadora de Gastos y Utilidad */
        .cost-calculator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .cost-calculator {
                grid-template-columns: 1fr;
            }
        }

        /* Selector de proyectos multi-proyecto */
        .project-selector-container {
            grid-column: 1 / -1;
            margin-bottom: 1rem;
        }

        .project-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .project-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 150px;
        }

        .project-tab:hover {
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-sm);
        }

        .project-tab.active {
            border-color: var(--primary-blue);
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .project-tab-name {
            border: none;
            background: transparent;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            width: 100px;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
        }

        .project-tab-name:focus {
            outline: none;
            background: white;
            box-shadow: inset 0 0 0 1px var(--primary-blue);
        }

        .project-tab.active .project-tab-name {
            color: var(--primary-dark);
        }

        .project-tab-total {
            font-size: 0.75rem;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .project-tab.active .project-tab-total {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary-blue-dark);
        }

        .project-tab-delete {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            line-height: 1;
        }

        .project-tab-delete:hover {
            color: var(--accent-red);
            background: #fee2e2;
        }

        .add-project-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px dashed var(--accent-green);
            border-radius: var(--radius-lg);
            color: var(--accent-green);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .add-project-btn:hover {
            background: linear-gradient(135deg, var(--accent-green) 0%, #059669 100%);
            border-style: solid;
            color: white;
        }

        .projects-summary {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
        }

        .projects-summary .summary-label {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 500;
        }

        .projects-summary .summary-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-dark);
            background: white;
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }

        .cost-section {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid var(--gray-200);
        }

        .cost-section.expenses {
            border-color: #fecaca;
            background: linear-gradient(135deg, #fff 0%, #fef2f2 100%);
        }

        .cost-section.revenue {
            border-color: #bbf7d0;
            background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
        }

        .cost-section h4 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cost-category {
            margin-bottom: 1.25rem;
        }

        .cost-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .cost-category-header h5 {
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .cost-category-total {
            font-weight: 700;
            color: var(--primary-blue);
        }

        .cost-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }

        .cost-item input[type="text"] {
            flex: 2;
            padding: 0.5rem;
            font-size: 0.85rem;
        }

        .cost-item input[type="number"] {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.85rem;
            text-align: right;
        }

        .cost-item .remove-cost {
            background: #fee2e2;
            border: none;
            color: #dc2626;
            width: 26px;
            height: 26px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .cost-item .remove-cost:hover {
            background: #fecaca;
        }

        .add-cost-btn {
            background: var(--gray-100);
            border: 2px dashed var(--gray-300);
            color: var(--gray-700);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            width: 100%;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .add-cost-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: #eff6ff;
        }

        .profit-summary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            color: white;
        }

        .profit-summary h4 {
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .profit-row {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            font-size: 0.95rem;
        }

        .profit-row:last-child {
            border-bottom: none;
        }

        .profit-row.total {
            font-size: 1.2rem;
            font-weight: 700;
            padding-top: 1rem;
            margin-top: 0.5rem;
            border-top: 2px solid rgba(255,255,255,0.3);
        }

        .profit-row .value.positive {
            color: #86efac;
        }

        .profit-row .value.negative {
            color: #fca5a5;
        }

        .margin-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
        }

        .margin-bar {
            flex: 1;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .margin-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .margin-fill.low {
            background: linear-gradient(90deg, #ef4444 0%, #f97316 100%);
        }

        .margin-fill.medium {
            background: linear-gradient(90deg, #f59e0b 0%, #eab308 100%);
        }

        .margin-fill.high {
            background: linear-gradient(90deg, #22c55e 0%, #34d399 100%);
        }

        .margin-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .margin-percent {
            font-size: 1.75rem;
            font-weight: 700;
            min-width: 80px;
            text-align: right;
        }

        .preset-costs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .preset-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
            min-width: 60px;
        }

        .preset-cost-btn {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            padding: 0.3rem 0.6rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-cost-btn:hover {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .utility-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .utility-card {
            background: rgba(255,255,255,0.15);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .utility-card .number {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .utility-card .label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        /* Calculadora de Break-Even */
        .breakeven-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 900px) {
            .breakeven-container {
                grid-template-columns: 1fr;
            }
        }

        .breakeven-inputs {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 2px solid var(--gray-200);
        }

        .breakeven-inputs h4 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .breakeven-results {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            border-radius: 0.75rem;
            padding: 1.5rem;
            color: white;
        }

        .breakeven-results h4 {
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .breakeven-metric {
            background: rgba(255,255,255,0.1);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .breakeven-metric:last-child {
            margin-bottom: 0;
        }

        .breakeven-metric .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .breakeven-metric .value {
            font-size: 2rem;
            font-weight: 700;
        }

        .breakeven-metric .label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .breakeven-metric.success {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid rgba(16, 185, 129, 0.5);
        }

        .breakeven-metric.warning {
            background: rgba(245, 158, 11, 0.3);
            border: 2px solid rgba(245, 158, 11, 0.5);
        }

        .breakeven-metric.danger {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }

        .breakeven-chart {
            margin-top: 1.5rem;
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.25rem;
        }

        .breakeven-chart h4 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .breakeven-timeline {
            position: relative;
            height: 60px;
            background: var(--gray-100);
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .breakeven-progress {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #22c55e 100%);
            border-radius: 0.5rem;
            position: relative;
            transition: width 0.5s ease;
        }

        .breakeven-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-dark);
            transform: translateX(-50%);
        }

        .breakeven-marker::after {
            content: attr(data-label);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            color: var(--primary-dark);
        }

        .breakeven-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-700);
        }

        .breakeven-insight {
            margin-top: 1rem;
            padding: 1rem;
            background: #eff6ff;
            border-radius: 0.5rem;
            border-left: 4px solid var(--primary-blue);
            font-size: 0.9rem;
        }

        .breakeven-insight.positive {
            background: #f0fdf4;
            border-left-color: var(--accent-green);
        }

        .breakeven-insight.negative {
            background: #fef2f2;
            border-left-color: #ef4444;
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-with-unit input {
            flex: 1;
        }

        .input-with-unit .unit {
            font-size: 0.85rem;
            color: var(--gray-700);
            min-width: 60px;
        }

        /* Configuraciones Guardadas */
        .storage-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .storage-controls input {
            flex: 1;
            min-width: 200px;
        }

        .saved-configs-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .saved-config-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.75rem;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
        }

        .saved-config-item:hover {
            border-color: var(--primary-blue);
            background: var(--white);
        }

        .saved-config-item .config-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            border-radius: 0.5rem;
        }

        .saved-config-item .config-info {
            flex: 1;
        }

        .saved-config-item .config-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-dark);
        }

        .saved-config-item .config-date {
            font-size: 0.8rem;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .saved-config-item .config-preview {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .saved-config-item .config-preview span {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            background: var(--white);
            border-radius: 0.25rem;
            border: 1px solid var(--gray-200);
        }

        .saved-config-item .config-actions {
            display: flex;
            gap: 0.5rem;
        }

        .saved-config-item .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-config-item .btn-load {
            background: var(--accent-green);
            color: white;
        }

        .saved-config-item .btn-load:hover {
            background: #059669;
        }

        .saved-config-item .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .saved-config-item .btn-delete:hover {
            background: #dc2626;
            color: white;
        }

        .empty-storage {
            text-align: center;
            padding: 3rem;
            color: var(--gray-700);
        }

        .empty-storage .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .storage-info {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: #eff6ff;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .storage-info.warning {
            background: #fef3c7;
        }

        /* Sección de Exportación PDF */
        .export-section {
            background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .export-section h2 {
            color: white;
            border-bottom-color: rgba(255,255,255,0.3);
            margin-bottom: 1rem;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .export-btn .icon {
            font-size: 1.5rem;
        }

        .export-btn.primary {
            background: white;
            color: var(--primary-dark);
            border-color: white;
        }

        .export-btn.primary:hover {
            background: var(--gray-100);
        }

        .pdf-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 0.75rem;
        }

        .pdf-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pdf-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .pdf-option label {
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .export-progress {
            display: none;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
        }

        .export-progress.active {
            display: flex;
        }

        .export-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos específicos para el PDF exportado */
        .pdf-content {
            display: none;
        }

        .pdf-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .pdf-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .pdf-header .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .pdf-header .date {
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .pdf-section {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            page-break-inside: avoid;
        }

        .pdf-section h3 {
            color: var(--primary-dark);
            font-size: 1.2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-blue);
        }

        .pdf-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .pdf-metric {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .pdf-metric .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .pdf-metric .label {
            font-size: 0.85rem;
            color: var(--gray-700);
            margin-top: 0.25rem;
        }

        .pdf-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .pdf-table th,
        .pdf-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .pdf-table th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--primary-dark);
        }

        .pdf-footer {
            text-align: center;
            padding: 1rem;
            color: var(--gray-700);
            font-size: 0.85rem;
            margin-top: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Resumen Ejecutivo Copiable */
        .summary-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid var(--accent-green);
        }

        .summary-section h2 {
            color: var(--accent-green);
            border-bottom-color: var(--accent-green);
        }

        .summary-format-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .format-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .format-btn:hover {
            border-color: var(--accent-green);
        }

        .format-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        .summary-preview {
            background: white;
            border-radius: 0.75rem;
            padding: 1.25rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
        }

        .summary-preview .summary-header {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .summary-preview .summary-section-title {
            font-weight: 600;
            color: var(--primary-blue);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .summary-preview .highlight {
            background: #fef3c7;
            padding: 0.1rem 0.25rem;
            border-radius: 0.25rem;
        }

        .summary-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .copy-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--accent-green);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .copy-btn.copied {
            background: #065f46;
        }

        .copy-btn .icon {
            font-size: 1.2rem;
        }

        .summary-tip {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: var(--gray-700);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .summary-tip .icon {
            flex-shrink: 0;
        }

        /* Cláusulas Sugeridas */
        .clauses-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--accent-gold);
        }

        .clauses-section h2 {
            color: #b45309;
            border-bottom-color: var(--accent-gold);
        }

        .clauses-categories {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(180, 83, 9, 0.3);
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            color: #92400e;
        }

        .category-tab:hover {
            border-color: var(--accent-gold);
            background: #fffbeb;
        }

        .category-tab.active {
            background: var(--accent-gold);
            color: white;
            border-color: var(--accent-gold);
        }

        .clauses-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .clause-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
        }

        .clause-item:hover {
            border-color: var(--accent-gold);
        }

        .clause-item.selected {
            border-color: var(--accent-green);
            background: #f0fdf4;
        }

        .clause-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .clause-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .clause-content {
            flex: 1;
        }

        .clause-title {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clause-title .tag {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .clause-title .tag.essential {
            background: #fee2e2;
            color: #dc2626;
        }

        .clause-title .tag.recommended {
            background: #dbeafe;
            color: #2563eb;
        }

        .clause-title .tag.optional {
            background: #f3f4f6;
            color: #6b7280;
        }

        .clause-description {
            font-size: 0.85rem;
            color: var(--gray-700);
            line-height: 1.5;
        }

        .clause-preview {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #fffbeb;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-style: italic;
            color: #92400e;
            display: none;
        }

        .clause-item.selected .clause-preview {
            display: block;
        }

        .clauses-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .clauses-counter {
            font-size: 0.9rem;
            color: var(--gray-700);
            margin-left: auto;
        }

        .clauses-output {
            margin-top: 1rem;
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            display: none;
        }

        .clauses-output.visible {
            display: block;
        }

        .clauses-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .clauses-output-content {
            font-family: Georgia, serif;
            font-size: 0.9rem;
            line-height: 1.8;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: #fafafa;
            border-radius: 0.5rem;
            white-space: pre-wrap;
        }

        /* Checklist de Negociación */
        .checklist-section {
            background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
            border: 2px solid #8b5cf6;
        }

        .checklist-section h2 {
            color: #6d28d9;
            border-bottom-color: #8b5cf6;
        }

        .checklist-progress {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .checklist-progress-bar {
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .checklist-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6d28d9);
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .checklist-progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--gray-700);
        }

        .checklist-progress-text .percentage {
            font-weight: 700;
            color: #6d28d9;
        }

        .checklist-groups {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .checklist-group {
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .checklist-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checklist-group-header:hover {
            background: #f3f4f6;
        }

        .checklist-group-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .checklist-group-title .icon {
            font-size: 1.2rem;
        }

        .checklist-group-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            background: #ede9fe;
            color: #6d28d9;
        }

        .checklist-group-items {
            padding: 0.5rem;
            display: none;
        }

        .checklist-group.expanded .checklist-group-items {
            display: block;
        }

        .checklist-group-header .expand-icon {
            transition: transform 0.2s;
        }

        .checklist-group.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            cursor: pointer;
        }

        .checklist-item:hover {
            background: #f9fafb;
        }

        .checklist-item.completed {
            background: #f0fdf4;
        }

        .checklist-item.completed .checklist-item-text {
            text-decoration: line-through;
            color: #6b7280;
        }

        .checklist-item-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
            font-size: 14px;
            color: transparent;
        }

        .checklist-item.completed .checklist-item-checkbox {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .checklist-item-content {
            flex: 1;
        }

        .checklist-item-text {
            font-weight: 500;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
        }

        .checklist-item-hint {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .checklist-item-note {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #fffbeb;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }

        .checklist-item-note input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 0.8rem;
            outline: none;
        }

        .checklist-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .checklist-summary {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            display: none;
        }

        .checklist-summary.visible {
            display: block;
        }

        .checklist-summary h4 {
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }

        .checklist-summary-content {
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Sección de Riesgos */
        .risks-section {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }

        .risks-section h2 {
            color: #dc2626;
            border-bottom-color: #ef4444;
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .risk-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            border-left: 4px solid #e5e7eb;
            transition: all 0.2s;
        }

        .risk-card.low {
            border-left-color: #10b981;
        }

        .risk-card.medium {
            border-left-color: #f59e0b;
        }

        .risk-card.high {
            border-left-color: #ef4444;
        }

        .risk-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .risk-card-title {
            font-weight: 700;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .risk-level {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        .risk-level.low {
            background: #d1fae5;
            color: #065f46;
        }

        .risk-level.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-level.high {
            background: #fee2e2;
            color: #dc2626;
        }

        .risk-description {
            font-size: 0.85rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .risk-mitigation {
            background: #f0fdf4;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-size: 0.85rem;
        }

        .risk-mitigation-title {
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .risk-mitigation-text {
            color: #047857;
            line-height: 1.5;
        }

        .risk-assessment {
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .risk-assessment label {
            font-size: 0.8rem;
            color: var(--gray-700);
        }

        .risk-assessment select {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #d1d5db;
            font-size: 0.8rem;
        }

        .risks-summary {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .risks-summary h4 {
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }

        .risks-stats {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .risk-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .risk-stat-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .risk-stat-dot.high { background: #ef4444; }
        .risk-stat-dot.medium { background: #f59e0b; }
        .risk-stat-dot.low { background: #10b981; }

        .risk-overall {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .risk-overall.low {
            background: #d1fae5;
            color: #065f46;
        }

        .risk-overall.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-overall.high {
            background: #fee2e2;
            color: #dc2626;
        }

        .risk-overall-label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .risk-overall-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Alertas Inteligentes */
        .alerts-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        @media (max-width: 600px) {
            .alerts-container {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
        }

        .alert-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #e5e7eb;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, white);
        }

        .alert-item.error {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, white);
        }

        .alert-item.success {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4, white);
        }

        .alert-item.info {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff, white);
        }

        .alert-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .alert-message {
            font-size: 0.85rem;
            color: var(--gray-700);
            line-height: 1.4;
        }

        .alert-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
            padding: 0.25rem;
        }

        .alert-close:hover {
            opacity: 1;
        }

        .alert-action {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e5e7eb;
        }

        .alert-action button {
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
        }

        .alerts-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .alerts-toggle:hover {
            transform: scale(1.1);
        }

        .alerts-toggle .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alerts-toggle.no-alerts .badge {
            background: #10b981;
        }

        .alerts-panel {
            display: none;
        }

        .alerts-panel.visible {
            display: flex;
            flex-direction: column;
        }

        .alerts-panel-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-blue));
            color: white;
            padding: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alerts-panel-header h4 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alerts-panel-body {
            background: #f9fafb;
            border-radius: 0 0 0.75rem 0.75rem;
            padding: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }

        .no-alerts-message {
            text-align: center;
            padding: 2rem;
            color: var(--gray-700);
        }

        .no-alerts-message .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        /* Indicadores de Salud del Deal */
        .deal-health-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
        }

        .deal-health-section h2 {
            color: #059669;
            border-bottom-color: #10b981;
        }

        .health-score-container {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .health-score-main {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .health-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .health-score-circle::before {
            content: '';
            position: absolute;
            inset: 8px;
            border-radius: 50%;
            background: white;
        }

        .health-score-circle.excellent {
            background: conic-gradient(#10b981 0deg, #10b981 calc(var(--score) * 3.6deg), #e5e7eb calc(var(--score) * 3.6deg));
        }

        .health-score-circle.good {
            background: conic-gradient(#3b82f6 0deg, #3b82f6 calc(var(--score) * 3.6deg), #e5e7eb calc(var(--score) * 3.6deg));
        }

        .health-score-circle.fair {
            background: conic-gradient(#f59e0b 0deg, #f59e0b calc(var(--score) * 3.6deg), #e5e7eb calc(var(--score) * 3.6deg));
        }

        .health-score-circle.poor {
            background: conic-gradient(#ef4444 0deg, #ef4444 calc(var(--score) * 3.6deg), #e5e7eb calc(var(--score) * 3.6deg));
        }

        .health-score-value {
            position: relative;
            z-index: 1;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .health-score-label {
            position: relative;
            z-index: 1;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .health-score-inner {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .health-score-number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            color: var(--primary-dark);
        }

        .health-score-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .health-score-verdict {
            font-size: 1.25rem;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            display: inline-block;
        }

        .health-score-verdict.excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .health-score-verdict.good {
            background: #dbeafe;
            color: #1e40af;
        }

        .health-score-verdict.fair {
            background: #fef3c7;
            color: #92400e;
        }

        .health-score-verdict.poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .health-metrics {
            flex: 2;
            min-width: 300px;
        }

        .health-metric-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .health-metric-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .health-metric-info {
            flex: 1;
        }

        .health-metric-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary-dark);
        }

        .health-metric-desc {
            font-size: 0.8rem;
            color: var(--gray-700);
        }

        .health-metric-bar {
            width: 120px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .health-metric-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .health-metric-fill.excellent { background: #10b981; }
        .health-metric-fill.good { background: #3b82f6; }
        .health-metric-fill.fair { background: #f59e0b; }
        .health-metric-fill.poor { background: #ef4444; }

        .health-metric-score {
            font-weight: 700;
            font-size: 0.9rem;
            width: 35px;
            text-align: right;
        }

        .health-perspectives {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .perspective-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
        }

        .perspective-card h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            color: var(--primary-dark);
        }

        .perspective-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
        }

        .perspective-item:last-child {
            border-bottom: none;
        }

        .perspective-item .label {
            color: var(--gray-700);
        }

        .perspective-item .value {
            font-weight: 600;
        }

        .perspective-item .value.positive {
            color: #059669;
        }

        .perspective-item .value.negative {
            color: #dc2626;
        }

        .perspective-item .value.neutral {
            color: var(--primary-blue);
        }

        .health-recommendation {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 0.75rem;
            border-left: 4px solid #10b981;
        }

        .health-recommendation h4 {
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }

        .health-recommendation ul {
            margin: 0;
            padding-left: 1.25rem;
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .health-recommendation li {
            margin-bottom: 0.25rem;
        }

        /* Estilos adicionales para JS */
        .metric-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary-dark);
        }

        .metric-weight {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .metric-bar-container {
            width: 120px;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .metric-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .metric-bar.excellent { background: #10b981; }
        .metric-bar.good { background: #3b82f6; }
        .metric-bar.fair { background: #f59e0b; }
        .metric-bar.poor { background: #ef4444; }

        .metric-score {
            font-weight: 700;
            font-size: 0.9rem;
            width: 35px;
            text-align: right;
        }

        .metric-score.excellent { color: #059669; }
        .metric-score.good { color: #2563eb; }
        .metric-score.fair { color: #d97706; }
        .metric-score.poor { color: #dc2626; }

        .perspective-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .perspective-icon {
            font-size: 1.5rem;
        }

        .perspective-title {
            font-weight: 600;
            color: var(--primary-dark);
        }

        .perspective-score {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: 0.5rem 0;
        }

        .perspective-score.excellent { color: #059669; }
        .perspective-score.good { color: #2563eb; }
        .perspective-score.fair { color: #d97706; }
        .perspective-score.poor { color: #dc2626; }

        .perspective-points {
            font-size: 0.9rem;
        }

        .perspective-points .point {
            padding: 0.4rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .perspective-points .point:last-child {
            border-bottom: none;
        }

        .perspective-points .point.positive {
            color: #059669;
        }

        .perspective-points .point.negative {
            color: #dc2626;
        }

        .perspective-points .point.neutral {
            color: var(--gray-600);
        }

        .perspective-card.studio {
            border-color: #a78bfa;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .perspective-card.agency {
            border-color: #60a5fa;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f9fafb;
        }

        .recommendation-item.high {
            background: #fef2f2;
            border-left: 3px solid #ef4444;
        }

        .recommendation-item.medium {
            background: #fffbeb;
            border-left: 3px solid #f59e0b;
        }

        .recommendation-item.low {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .recommendation-item.success {
            background: #ecfdf5;
            border-left: 3px solid #10b981;
        }

        .rec-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .rec-text {
            font-size: 0.9rem;
            color: var(--gray-700);
            line-height: 1.4;
        }

        .health-main {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .health-score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 180px;
        }

        .health-score-verdict {
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 0.75rem;
        }

        .health-score-verdict.excellent { color: #059669; }
        .health-score-verdict.good { color: #2563eb; }
        .health-score-verdict.fair { color: #d97706; }
        .health-score-verdict.poor { color: #dc2626; }

        .health-score-sublabel {
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        /* Estilos de impresión */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                max-width: none;
            }

            .card {
                box-shadow: none;
                border: 1px solid var(--gray-200);
                page-break-inside: avoid;
            }

            .export-section,
            .no-print,
            button,
            input[type="range"],
            .storage-controls,
            .saved-configs-list,
            .comparator-controls,
            .scenario-buttons {
                display: none !important;
            }

            header {
                background: var(--primary-dark) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard de Alianza Estratégica</h1>
            <p>Simulador financiero: Estudio de Desarrollo de IA + Agencia de Creatividad</p>
        </header>

        <!-- MENÚ DE NAVEGACIÓN LATERAL -->
        <nav class="nav-menu no-print" id="navMenu">
            <div class="nav-menu-inner">
                <div class="nav-group">
                    <span class="nav-group-label">Config</span>
                    <a href="#seccion-config" class="nav-item active" data-section="seccion-config">⚙️</a>
                    <a href="#seccion-proyectos" class="nav-item" data-section="seccion-proyectos">📁</a>
                    <a href="#seccion-licencias" class="nav-item" data-section="seccion-licencias">🎫</a>
                    <a href="#seccion-gastos" class="nav-item" data-section="seccion-gastos">💸</a>
                    <a href="#seccion-breakeven" class="nav-item" data-section="seccion-breakeven">📊</a>
                    <a href="#seccion-referidos" class="nav-item" data-section="seccion-referidos">🤝</a>
                    <a href="#seccion-equity" class="nav-item" data-section="seccion-equity">📈</a>
                </div>
                <div class="nav-group">
                    <span class="nav-group-label">Análisis</span>
                    <a href="#seccion-resumen" class="nav-item" data-section="seccion-resumen">📋</a>
                    <a href="#seccion-proyeccion" class="nav-item" data-section="seccion-proyeccion">📆</a>
                    <a href="#seccion-comparador" class="nav-item" data-section="seccion-comparador">⚖️</a>
                    <a href="#seccion-guardados" class="nav-item" data-section="seccion-guardados">💾</a>
                    <a href="#seccion-escenarios" class="nav-item" data-section="seccion-escenarios">🎯</a>
                </div>
                <div class="nav-group">
                    <span class="nav-group-label">Eval</span>
                    <a href="#seccion-salud" class="nav-item" data-section="seccion-salud">💚</a>
                    <a href="#seccion-riesgos" class="nav-item" data-section="seccion-riesgos">⚠️</a>
                </div>
                <div class="nav-group">
                    <span class="nav-group-label">Docs</span>
                    <a href="#seccion-checklist" class="nav-item" data-section="seccion-checklist">✅</a>
                    <a href="#seccion-clausulas" class="nav-item" data-section="seccion-clausulas">📜</a>
                    <a href="#seccion-copiable" class="nav-item" data-section="seccion-copiable">📝</a>
                    <a href="#seccion-exportar" class="nav-item" data-section="seccion-exportar">📄</a>
                </div>
            </div>
        </nav>

        <!-- BOTONES FLOTANTES EXPANDIR/COLAPSAR -->
        <div class="floating-actions no-print">
            <button class="floating-btn expand" onclick="expandAllSections()" title="Expandir todo">
                ⬇️
            </button>
            <button class="floating-btn collapse" onclick="collapseAllSections()" title="Colapsar todo">
                ⬆️
            </button>
        </div>

        <!-- CONFIGURACIÓN BASE -->
        <div class="card" id="seccion-config">
            <h2>1. Configuración Base del Acuerdo</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="retainer">Iguala Mensual Base (Retainer Fee)</label>
                    <input type="range" id="retainer" min="5000" max="100000" step="2500" value="25000">
                    <div class="value-display" id="retainerValue">$25,000 MXN/mes</div>
                </div>
                <div class="form-group">
                    <label for="ipSplit">Porcentaje de Propiedad Intelectual (%)</label>
                    <input type="range" id="ipSplit" min="0" max="100" step="5" value="50">
                    <div class="value-display" id="ipSplitValue">50% / 50%</div>
                </div>
                <div class="form-group">
                    <label for="duration">Duración del Contrato (meses)</label>
                    <select id="duration">
                        <option value="12">12 meses</option>
                        <option value="24" selected>24 meses</option>
                        <option value="36">36 meses</option>
                    </select>
                </div>
            </div>

            <!-- DETALLES DEL RETAINER -->
            <div class="retainer-details">
                <h4>Condiciones del Retainer - ¿Qué incluye?</h4>

                <label style="margin-bottom: 0.75rem;">Tipo de medición:</label>
                <div class="toggle-container">
                    <button class="toggle-btn active" id="toggleHours" onclick="setRetainerType('hours')">
                        Horas de trabajo
                    </button>
                    <button class="toggle-btn" id="toggleProjects" onclick="setRetainerType('projects')">
                        Proyectos/Entregables
                    </button>
                </div>

                <div class="hours-grid">
                    <div class="hours-stat">
                        <div class="number" id="includedUnits">50</div>
                        <div class="label" id="unitsLabel">horas incluidas/mes</div>
                    </div>
                    <div class="hours-stat highlight">
                        <div class="number" id="ratePerUnit">$100</div>
                        <div class="label" id="rateLabel">tarifa por hora</div>
                    </div>
                    <div class="hours-stat">
                        <div class="number" id="extraRate">$120</div>
                        <div class="label" id="extraRateLabel">hora extra (+20%)</div>
                    </div>
                </div>

                <div class="hours-scale" id="hoursScale">
                    <div class="hours-scale-item" data-value="5000">
                        <div>$5K</div>
                        <div>10h</div>
                    </div>
                    <div class="hours-scale-item" data-value="15000">
                        <div>$15K</div>
                        <div>30h</div>
                    </div>
                    <div class="hours-scale-item active" data-value="25000">
                        <div>$25K</div>
                        <div>50h</div>
                    </div>
                    <div class="hours-scale-item" data-value="40000">
                        <div>$40K</div>
                        <div>80h</div>
                    </div>
                    <div class="hours-scale-item" data-value="60000">
                        <div>$60K</div>
                        <div>120h</div>
                    </div>
                    <div class="hours-scale-item" data-value="100000">
                        <div>$100K</div>
                        <div>200h</div>
                    </div>
                </div>

                <div class="info-box" style="margin-top: 1rem;" id="retainerInfo">
                    Con una iguala de <strong>$25,000 MXN/mes</strong> se incluyen <strong>50 horas</strong> de desarrollo.
                    Las horas adicionales se cobran a <strong>$600/hora</strong> (+20% sobre tarifa base de $500).
                </div>
            </div>
        </div>

        <!-- SIMULADOR DE PROYECTOS -->
        <div class="card" id="seccion-proyectos">
            <h2>2. Simulador de Proyectos</h2>
            <div class="input-group">
                <input type="text" id="projectName" placeholder="Nombre del proyecto">
                <input type="number" id="projectValue" placeholder="Valor MXN" min="0">
                <select id="projectType">
                    <option value="interno">Interno (Agencia)</option>
                    <option value="cliente">Venta a Cliente</option>
                </select>
                <button class="btn btn-success" onclick="addProject()">Agregar</button>
            </div>
            <div style="overflow-x: auto;">
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Valor Total</th>
                            <th>Tipo</th>
                            <th>Split Estudio IA</th>
                            <th>Split Agencia</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--gray-700); padding: 2rem;">
                                No hay proyectos agregados. Añade tu primer proyecto arriba.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- MÓDULO DE LICENCIAS -->
        <div class="card" id="seccion-licencias">
            <div class="section-header" onclick="toggleSection(this)">
                <h2>🎫 Venta de Licencias <span class="badge-new">Nuevo</span></h2>
                <button class="collapse-btn">▼</button>
            </div>
            <div class="section-content">
                <div class="cost-section licenses">
                    <h4>💰 Productos con Licencias</h4>
                    <p style="margin-bottom: 1rem; color: var(--gray-600); font-size: 0.9rem;">
                        Para productos ya desarrollados que se venden como licencias (SaaS, software, herramientas IA).
                    </p>

                    <!-- Presets de productos comunes -->
                    <div class="license-presets">
                        <span>⚡ Rápido:</span>
                        <button class="preset-license-btn" onclick="addPresetLicense('Chatbot IA', 2500, 'monthly', 200)">+ Chatbot IA</button>
                        <button class="preset-license-btn" onclick="addPresetLicense('Herramienta SaaS', 999, 'monthly', 100)">+ SaaS Tool</button>
                        <button class="preset-license-btn" onclick="addPresetLicense('Plugin/Extensión', 499, 'one-time', 0)">+ Plugin</button>
                        <button class="preset-license-btn" onclick="addPresetLicense('API Access', 1500, 'monthly', 300)">+ API Access</button>
                        <button class="preset-license-btn" onclick="addPresetLicense('Template Premium', 799, 'one-time', 0)">+ Template</button>
                        <button class="preset-license-btn" onclick="addPresetLicense('Curso/Training', 4999, 'one-time', 500)">+ Curso</button>
                    </div>

                    <!-- Formulario para agregar producto/licencia -->
                    <div class="license-form-container">
                        <div class="license-form-grid">
                            <div class="form-group">
                                <label>Nombre del producto</label>
                                <input type="text" id="licenseProductName" placeholder="Ej: Mi Herramienta IA">
                            </div>
                            <div class="form-group">
                                <label>Precio (MXN)</label>
                                <input type="number" id="licensePricePerUnit" placeholder="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Tipo de licencia</label>
                                <select id="licenseType">
                                    <option value="one-time">Pago único</option>
                                    <option value="monthly">Mensual</option>
                                    <option value="annual">Anual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Costo/unidad</label>
                                <input type="number" id="licenseCostPerUnit" placeholder="0" min="0" value="0">
                            </div>
                            <button class="btn btn-success" onclick="addLicenseProduct()">+ Agregar</button>
                        </div>
                    </div>

                    <!-- Tabla de productos con licencias -->
                    <table class="data-table" id="licensesTable">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Tipo</th>
                                <th>Costo/u</th>
                                <th>Vendidas</th>
                                <th>Ingresos</th>
                                <th>Utilidad</th>
                                <th>Tu PI (<span id="licensePiPercent">50</span>%)</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="licensesTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; color: var(--gray-500); padding: 2rem; font-size: 0.9rem;">
                                    🎫 No hay productos aún. Usa los botones rápidos o agrega uno manualmente.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Resumen de licencias -->
                <div class="license-summary-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalLicenseRevenue">$0</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalLicenseCosts">$0</div>
                        <div class="stat-label">Costos Totales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalLicenseGrossProfit">$0</div>
                        <div class="stat-label">Utilidad Bruta</div>
                    </div>
                    <div class="stat-card highlight">
                        <div class="stat-value" id="totalLicenseYourShare">$0</div>
                        <div class="stat-label">Tu Participación (PI)</div>
                    </div>
                </div>

                <!-- Proyección de licencias -->
                <div class="license-projection-container">
                    <h4>📈 Proyección de Ventas de Licencias</h4>
                    <div class="license-projection-grid">
                        <div class="form-group">
                            <label>Licencias proyectadas/mes</label>
                            <input type="number" id="projectedLicensesPerMonth" value="10" min="0" onchange="updateLicenseProjection()">
                        </div>
                        <div class="form-group">
                            <label>Meses a proyectar</label>
                            <input type="number" id="licenseProjectionMonths" value="12" min="1" max="60" onchange="updateLicenseProjection()">
                        </div>
                        <div class="form-group">
                            <label>Crecimiento mensual (%)</label>
                            <input type="number" id="licenseGrowthRate" value="5" min="0" max="100" onchange="updateLicenseProjection()">
                        </div>
                    </div>
                    <div class="license-results-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="projectedTotalLicenses">0</div>
                            <div class="stat-label">Total Licencias</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="projectedLicenseRevenue">$0</div>
                            <div class="stat-label">Ingresos Proyectados</div>
                        </div>
                        <div class="stat-card highlight">
                            <div class="stat-value" id="projectedLicenseProfit">$0</div>
                            <div class="stat-label">Tu Utilidad Proyectada</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALCULADORA DE GASTOS Y UTILIDAD -->
        <div class="card" id="seccion-gastos">
            <h2>3. Calculadora de Gastos y Utilidad</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Calcula los costos y márgenes de utilidad de tus proyectos para entender la rentabilidad real.
            </p>

            <div class="cost-calculator">
                <!-- SELECTOR DE PROYECTOS -->
                <div id="projectSelector" class="project-selector-container">
                    <!-- Se renderiza dinámicamente -->
                </div>

                <!-- GASTOS -->
                <div class="cost-section expenses">
                    <h4>💸 Gastos del Proyecto Actual</h4>

                    <div class="preset-costs">
                        <span class="preset-label">👥 Equipo:</span>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Desarrollador Senior', 15000)">+ Dev Senior</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Desarrollador Jr', 8000)">+ Dev Jr</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Diseñador UI/UX', 12000)">+ Diseñador UI/UX</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Diseñador Gráfico', 10000)">+ Diseño Gráfico</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Director Creativo', 18000)">+ Creatividad</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'Project Manager', 14000)">+ PM</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('labor', 'QA Tester', 9000)">+ QA</button>
                    </div>
                    <div class="preset-costs">
                        <span class="preset-label">🛠️ Infra:</span>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'Hosting/Servidor', 1500)">+ Hosting</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'Base de Datos', 2500)">+ Base de Datos</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'Tokens IA (OpenAI/Claude)', 5000)">+ Tokens IA</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'APIs Externas', 2000)">+ APIs</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'CDN/Storage', 1000)">+ CDN/Storage</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('tools', 'Dominio/SSL', 500)">+ Dominio</button>
                    </div>
                    <div class="preset-costs">
                        <span class="preset-label">📦 Otros:</span>
                        <button class="preset-cost-btn" onclick="addPresetCost('other', 'Licencias Software', 3000)">+ Licencias</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('other', 'Assets/Recursos', 2000)">+ Assets</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('other', 'Marketing/Lanzamiento', 5000)">+ Marketing</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('other', 'Legal/Contratos', 4000)">+ Legal</button>
                        <button class="preset-cost-btn" onclick="addPresetCost('other', 'Contingencia (10%)', 0)">+ Contingencia</button>
                    </div>

                    <!-- Mano de Obra -->
                    <div class="cost-category">
                        <div class="cost-category-header">
                            <h5>👥 Mano de Obra</h5>
                            <span class="cost-category-total" id="laborTotal">$0</span>
                        </div>
                        <div id="laborCosts"></div>
                        <button class="add-cost-btn" onclick="addCostItem('labor')">+ Agregar costo de personal</button>
                    </div>

                    <!-- Herramientas y Servicios -->
                    <div class="cost-category">
                        <div class="cost-category-header">
                            <h5>🛠️ Herramientas y Servicios</h5>
                            <span class="cost-category-total" id="toolsTotal">$0</span>
                        </div>
                        <div id="toolsCosts"></div>
                        <button class="add-cost-btn" onclick="addCostItem('tools')">+ Agregar herramienta/servicio</button>
                    </div>

                    <!-- Otros Gastos -->
                    <div class="cost-category">
                        <div class="cost-category-header">
                            <h5>📦 Otros Gastos</h5>
                            <span class="cost-category-total" id="otherTotal">$0</span>
                        </div>
                        <div id="otherCosts"></div>
                        <button class="add-cost-btn" onclick="addCostItem('other')">+ Agregar otro gasto</button>
                    </div>
                </div>

                <!-- INGRESOS -->
                <div class="cost-section revenue">
                    <h4>💰 Ingresos del Proyecto</h4>

                    <div class="cost-category">
                        <div class="cost-category-header">
                            <h5>📊 Valor del Proyecto</h5>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label>Valor total del proyecto actual (MXN)</label>
                            <input type="number" id="projectTotalValue" value="100000" min="0" onchange="updateCurrentProjectValue(this.value)">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Tu participación (PI): <span id="profitIpDisplay">50%</span></label>
                            <input type="range" id="profitIpSplit" min="0" max="100" step="5" value="50" onchange="updateProfitIpDisplay(); calculateProfit()">
                        </div>
                    </div>

                    <div class="profit-summary" id="profitSummary">
                        <h4>📈 Resumen de Utilidad</h4>

                        <div class="profit-row">
                            <span class="label">Valor total del proyecto</span>
                            <span class="value" id="profitProjectValue">$0</span>
                        </div>
                        <div class="profit-row">
                            <span class="label">(-) Total de gastos</span>
                            <span class="value negative" id="profitTotalCosts">$0</span>
                        </div>
                        <div class="profit-row" style="border-top: 1px dashed var(--gray-300); padding-top: 8px;">
                            <span class="label">= Utilidad bruta del proyecto</span>
                            <span class="value" id="profitGrossProfit">$0</span>
                        </div>
                        <div class="profit-row">
                            <span class="label">Tu parte (<span id="profitIpLabel">50%</span> PI)</span>
                            <span class="value" id="profitYourShare">$0</span>
                        </div>
                        <div class="profit-row total">
                            <span class="label">= Tu utilidad neta</span>
                            <span class="value" id="profitNetProfit">$0</span>
                        </div>

                        <div class="margin-indicator">
                            <div>
                                <div class="margin-label">Margen de utilidad</div>
                                <div class="margin-bar">
                                    <div class="margin-fill high" id="marginFill" style="width: 50%;"></div>
                                </div>
                            </div>
                            <div class="margin-percent" id="marginPercent">50%</div>
                        </div>

                        <div class="utility-cards">
                            <div class="utility-card">
                                <div class="number" id="profitPerHour">$0</div>
                                <div class="label">Utilidad/hora estimada</div>
                            </div>
                            <div class="utility-card">
                                <div class="number" id="profitROI">0%</div>
                                <div class="label">ROI del proyecto</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALCULADORA DE BREAK-EVEN -->
        <div class="card" id="seccion-breakeven">
            <h2>4. Calculadora de Break-Even</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Calcula cuánto tiempo o cuántos proyectos necesitas para recuperar tu inversión inicial y empezar a generar ganancias.
            </p>

            <div class="breakeven-container">
                <!-- INPUTS -->
                <div class="breakeven-inputs">
                    <h4>📊 Configura tu Escenario</h4>

                    <div class="form-group">
                        <label>Inversión inicial / Costos fijos (MXN)</label>
                        <input type="number" id="beInitialInvestment" value="50000" min="0" onchange="calculateBreakeven()">
                        <small style="color: var(--gray-700);">Equipos, licencias, setup inicial, etc.</small>
                    </div>

                    <div class="form-group">
                        <label>Costos operativos mensuales (MXN)</label>
                        <input type="number" id="beMonthlyExpenses" value="15000" min="0" onchange="calculateBreakeven()">
                        <small style="color: var(--gray-700);">Renta, servicios, suscripciones fijas</small>
                    </div>

                    <div class="form-group">
                        <label>Ingreso mensual garantizado (Retainer)</label>
                        <div class="input-with-unit">
                            <input type="number" id="beMonthlyRetainer" value="25000" min="0" onchange="calculateBreakeven()">
                            <span class="unit">MXN/mes</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Ingreso promedio por proyecto</label>
                        <div class="input-with-unit">
                            <input type="number" id="beAvgProjectIncome" value="75000" min="0" onchange="calculateBreakeven()">
                            <span class="unit">MXN</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Proyectos esperados por mes</label>
                        <input type="range" id="beProjectsPerMonth" min="0" max="5" step="0.5" value="1" onchange="updateProjectsDisplay(); calculateBreakeven()">
                        <div class="value-display" id="beProjectsDisplay">1 proyecto/mes</div>
                    </div>
                </div>

                <!-- RESULTS -->
                <div class="breakeven-results">
                    <h4>🎯 Punto de Equilibrio</h4>

                    <div class="breakeven-metric" id="beTimeMetric">
                        <div class="icon">⏱️</div>
                        <div class="value" id="beMonthsToBreakeven">0</div>
                        <div class="label">meses para break-even</div>
                    </div>

                    <div class="breakeven-metric" id="beProjectsMetric">
                        <div class="icon">📁</div>
                        <div class="value" id="beProjectsToBreakeven">0</div>
                        <div class="label">proyectos para break-even</div>
                    </div>

                    <div class="breakeven-metric" id="beRevenueMetric">
                        <div class="icon">💰</div>
                        <div class="value" id="beRevenueNeeded">$0</div>
                        <div class="label">ingresos necesarios</div>
                    </div>
                </div>
            </div>

            <!-- GRÁFICO DE BREAK-EVEN -->
            <div class="breakeven-chart">
                <h4>📈 Proyección de Break-Even</h4>
                <div class="breakeven-timeline">
                    <div class="breakeven-progress" id="beProgressBar" style="width: 0%"></div>
                    <div class="breakeven-marker" id="beMarker" style="left: 50%" data-label="Break-even"></div>
                </div>
                <div class="breakeven-labels">
                    <span>Mes 0 (Inicio)</span>
                    <span id="beEndLabel">Mes 12</span>
                </div>
                <div class="breakeven-insight" id="beInsight">
                    Calculando...
                </div>
            </div>
        </div>

        <!-- FINDER'S FEE -->
        <div class="card" id="seccion-referidos">
            <h2>5. Comisiones por Referidos (Finder's Fee)</h2>
            <div class="form-group">
                <label for="finderFee">Porcentaje de Finder's Fee (%)</label>
                <input type="range" id="finderFee" min="5" max="15" step="1" value="10">
                <div class="value-display" id="finderFeeValue">10%</div>
            </div>
            <div class="input-group">
                <input type="text" id="referralName" placeholder="Nombre del referido">
                <input type="number" id="referralValue" placeholder="Valor del proyecto MXN" min="0">
                <button class="btn btn-success" onclick="addReferral()">Agregar Referido</button>
            </div>
            <div style="overflow-x: auto;">
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th>Proyecto Referido</th>
                            <th>Valor</th>
                            <th>Comisión</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="referralsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--gray-700); padding: 2rem;">
                                No hay referidos agregados.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- EQUITY/OPCIONES -->
        <div class="card" id="seccion-equity">
            <h2>6. Opciones de Equity / Acciones <span class="scenario-tag sale">Protección ante venta</span></h2>

            <div class="info-box" style="margin-bottom: 1.5rem;">
                <strong>¿Para qué sirve esto?</strong> Si alguna de las empresas es vendida o adquirida,
                el socio con opciones recibe parte de la ganancia. Esto protege a ambas partes y alinea intereses a largo plazo.
            </div>

            <!-- Configuración General -->
            <div class="equity-config">
                <h4>Configuración de las Opciones</h4>
                <div class="form-group">
                    <label for="equityPercent">Porcentaje de Opciones Cruzadas (%)</label>
                    <input type="range" id="equityPercent" min="1" max="15" step="0.5" value="3">
                    <div class="value-display" id="equityPercentValue">3%</div>
                    <small style="color: var(--gray-700);">Cada parte tiene este % de opciones en la otra empresa</small>
                </div>
            </div>

            <!-- Dos columnas: Estudio y Agencia -->
            <div class="equity-section">
                <!-- ESTUDIO IA -->
                <div class="equity-company studio">
                    <h4>🤖 Estudio de IA</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-700); margin-bottom: 1rem;">
                        Si venden el estudio, la <strong>Agencia recibe</strong> parte de la ganancia.
                    </p>
                    <div class="equity-inputs">
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label for="studioValuation">Valoración Actual (MXN)</label>
                            <input type="number" id="studioValuation" value="5000000" min="0">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="studioFutureValue">Valor de Venta / Exit (MXN)</label>
                            <input type="number" id="studioFutureValue" value="15000000" min="0">
                            <small style="color: var(--gray-700);">¿A cuánto podría venderse?</small>
                        </div>
                    </div>
                    <div class="equity-result" id="studioEquityResult">
                        <!-- Se llena con JS -->
                    </div>
                </div>

                <!-- AGENCIA -->
                <div class="equity-company agency">
                    <h4>🎨 Agencia Creativa</h4>
                    <p style="font-size: 0.85rem; color: var(--gray-700); margin-bottom: 1rem;">
                        Si venden la agencia, el <strong>Estudio recibe</strong> parte de la ganancia.
                    </p>
                    <div class="equity-inputs">
                        <div class="form-group" style="margin-bottom: 0.75rem;">
                            <label for="agencyValuation">Valoración Actual (MXN)</label>
                            <input type="number" id="agencyValuation" value="7500000" min="0">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="agencyFutureValue">Valor de Venta / Exit (MXN)</label>
                            <input type="number" id="agencyFutureValue" value="25000000" min="0">
                            <small style="color: var(--gray-700);">¿A cuánto podría venderse?</small>
                        </div>
                    </div>
                    <div class="equity-result" id="agencyEquityResult">
                        <!-- Se llena con JS -->
                    </div>
                </div>
            </div>

            <!-- Vesting Schedule -->
            <div class="equity-config" style="margin-top: 1.5rem;">
                <h4>Calendario de Vesting (Devengo de Opciones)</h4>
                <p style="font-size: 0.85rem; color: var(--gray-700); margin-bottom: 1rem;">
                    Las opciones se desbloquean gradualmente durante el período de vesting.
                    Esto muestra cuánto valor se "gana" cada mes.
                </p>
                <div class="equity-grid">
                    <div class="form-group">
                        <label for="vestingPeriod">Período de Vesting (meses)</label>
                        <select id="vestingPeriod">
                            <option value="12">12 meses</option>
                            <option value="24">24 meses</option>
                            <option value="36" selected>36 meses</option>
                            <option value="48">48 meses</option>
                            <option value="60">60 meses</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cliffPeriod">Período de Cliff (meses)</label>
                        <select id="cliffPeriod">
                            <option value="0">Sin cliff</option>
                            <option value="6">6 meses</option>
                            <option value="12" selected>12 meses</option>
                            <option value="18">18 meses</option>
                            <option value="24">24 meses</option>
                        </select>
                        <small style="color: var(--gray-700);">Tiempo mínimo antes de recibir opciones</small>
                    </div>
                </div>

                <!-- Desglose mensual del Estudio -->
                <div class="vesting-breakdown" id="vestingBreakdown">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- Resumen de Equity -->
            <div class="equity-summary">
                <div class="equity-summary-card">
                    <h5>Ganancia Estudio si venden Agencia</h5>
                    <div class="amount" id="studioGainFromAgency">$0</div>
                </div>
                <div class="equity-summary-card">
                    <h5>Ganancia Agencia si venden Estudio</h5>
                    <div class="amount" id="agencyGainFromStudio">$0</div>
                </div>
                <div class="equity-summary-card total">
                    <h5>Valor Total Potencial de Opciones</h5>
                    <div class="amount" id="totalEquityValue">$0</div>
                </div>
            </div>
        </div>

        <!-- RESUMEN EJECUTIVO -->
        <div class="card" id="seccion-resumen">
            <h2>7. Resumen Ejecutivo</h2>
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-item">
                    <h3>Ingresos por Iguala</h3>
                    <div class="amount" id="retainerTotal">$0</div>
                </div>
                <div class="summary-item green">
                    <h3>Participación en PI</h3>
                    <div class="amount" id="ipTotal">$0</div>
                </div>
                <div class="summary-item gold">
                    <h3>Finder's Fees</h3>
                    <div class="amount" id="referralTotal">$0</div>
                </div>
                <div class="summary-item">
                    <h3>Valor Potencial Equity</h3>
                    <div class="amount" id="equityTotal">$0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="margin-bottom: 1rem; color: var(--primary-dark);">Distribución de Ingresos Proyectados</h3>
                <div class="chart-bars" id="chartBars"></div>
            </div>
        </div>

        <!-- PROYECCIÓN TEMPORAL -->
        <div class="card" id="seccion-proyeccion">
            <h2>8. Proyección Temporal de Ingresos</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Visualiza cómo se distribuyen tus ingresos a lo largo del contrato.
            </p>

            <div class="projection-controls">
                <label>
                    <span>Vista:</span>
                    <select id="projectionView" onchange="updateProjectionChart()">
                        <option value="monthly">Mensual</option>
                        <option value="quarterly">Trimestral</option>
                        <option value="yearly">Anual</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" id="showCumulative" checked onchange="updateProjectionChart()">
                    <span>Mostrar línea acumulada</span>
                </label>
                <label>
                    <input type="checkbox" id="includeEquity" onchange="updateProjectionChart()">
                    <span>Incluir equity (al final del vesting)</span>
                </label>
            </div>

            <div class="projection-chart">
                <div class="chart-y-axis" id="chartYAxis"></div>
                <div class="chart-area" id="projectionChartArea"></div>
                <div class="cumulative-line" id="cumulativeLine"></div>
                <div class="tooltip" id="chartTooltip"></div>
            </div>

            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color retainer"></div>
                    <span>Retainer</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color ip"></div>
                    <span>Propiedad Intelectual</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color finder"></div>
                    <span>Finder's Fee</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color equity"></div>
                    <span>Equity</span>
                </div>
            </div>

            <div class="projection-summary" id="projectionSummary">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- COMPARADOR DE ESCENARIOS -->
        <div class="card" id="seccion-comparador">
            <h2>9. Comparador de Escenarios</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Guarda diferentes configuraciones y compáralas lado a lado para tomar la mejor decisión.
            </p>

            <div class="comparator-controls">
                <button class="btn btn-primary" onclick="saveCurrentScenario()">
                    💾 Guardar escenario actual
                </button>
                <button class="btn btn-secondary" onclick="clearAllScenarios()">
                    🗑️ Limpiar comparador
                </button>
            </div>

            <div class="scenarios-container" id="scenariosContainer">
                <div class="scenario-card empty" onclick="saveCurrentScenario()">
                    <div class="empty-slot-content">
                        <div class="icon">📊</div>
                        <div>Haz clic para guardar<br>el escenario actual</div>
                    </div>
                </div>
            </div>

            <div class="comparison-insights" id="comparisonInsights" style="display: none;">
                <h4>📈 Análisis Comparativo</h4>
                <div id="insightsContent"></div>
            </div>
        </div>

        <!-- CONFIGURACIONES GUARDADAS -->
        <div class="card" id="seccion-guardados">
            <h2>10. Configuraciones Guardadas</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Guarda tu configuración actual para recuperarla en futuras sesiones. Los datos se almacenan en tu navegador.
            </p>

            <div class="storage-controls">
                <input type="text" id="configName" placeholder="Nombre de la configuración (ej: Propuesta v1, Escenario Agresivo...)" maxlength="50">
                <button class="btn btn-primary" onclick="saveConfigToStorage()">
                    💾 Guardar configuración
                </button>
                <button class="btn btn-secondary" onclick="exportAllConfigs()">
                    📤 Exportar todo
                </button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                    📥 Importar
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfigs(event)">
            </div>

            <div class="saved-configs-list" id="savedConfigsList">
                <div class="empty-storage">
                    <div class="icon">📁</div>
                    <div>No hay configuraciones guardadas</div>
                    <small>Guarda tu primera configuración usando el botón de arriba</small>
                </div>
            </div>

            <div class="storage-info" id="storageInfo">
                <span>💡</span>
                <span>Las configuraciones se guardan en localStorage de tu navegador. No se pierden al cerrar la página.</span>
            </div>
        </div>

        <!-- ESCENARIOS PREDEFINIDOS -->
        <div class="card" id="seccion-escenarios">
            <h2>11. Escenarios Predefinidos</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">Carga configuraciones predefinidas para diferentes niveles de proyección:</p>
            <div class="scenario-buttons">
                <button class="btn btn-secondary" onclick="loadScenario('conservative')">
                    📊 Escenario Conservador
                </button>
                <button class="btn btn-secondary" onclick="loadScenario('moderate')">
                    📈 Escenario Moderado
                </button>
                <button class="btn btn-secondary" onclick="loadScenario('optimistic')">
                    🚀 Escenario Optimista
                </button>
                <button class="btn btn-secondary" onclick="resetAll()">
                    🔄 Resetear Todo
                </button>
            </div>
        </div>

        <!-- INDICADORES DE SALUD DEL DEAL -->
        <div class="card deal-health-section no-print" id="seccion-salud">
            <h2>💚 Indicadores de Salud del Deal</h2>
            <p style="margin-bottom: 1.5rem; color: #059669;">
                Evaluación automática del acuerdo desde múltiples perspectivas. Un buen deal debe ser beneficioso para ambas partes.
            </p>

            <div class="health-main">
                <div class="health-score-container">
                    <div class="health-score-circle" id="healthScoreCircle" style="--score: 75">
                        <div class="health-score-inner">
                            <span class="health-score-number" id="healthScoreNumber">75</span>
                            <span class="health-score-label">puntos</span>
                        </div>
                    </div>
                    <div class="health-score-verdict" id="healthVerdict">Buen Acuerdo</div>
                    <div class="health-score-sublabel" id="healthSublabel">Equilibrado y sostenible</div>
                </div>

                <div class="health-metrics" id="healthMetrics">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>

            <div class="health-perspectives" id="healthPerspectives">
                <!-- Perspectiva del estudio y de la agencia -->
            </div>

            <div class="health-recommendation" id="healthRecommendation">
                <h4>💡 Recomendaciones</h4>
                <div class="recommendation-content" id="recommendationContent">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE RIESGOS -->
        <div class="card risks-section no-print" id="seccion-riesgos">
            <h2>⚠️ Análisis de Riesgos y Mitigaciones</h2>
            <p style="margin-bottom: 1rem; color: #dc2626;">
                Identifica los riesgos potenciales de la alianza y planifica cómo mitigarlos. Ajusta el nivel según tu evaluación.
            </p>

            <div class="risk-matrix" id="riskMatrix">
                <!-- Se llena con JavaScript -->
            </div>

            <div class="risks-summary" id="risksSummary">
                <h4>📊 Resumen de Riesgos</h4>
                <div class="risks-stats" id="risksStats">
                    <!-- Se llena con JavaScript -->
                </div>
                <div class="risk-overall" id="riskOverall">
                    <div class="risk-overall-label">Nivel de Riesgo General</div>
                    <div class="risk-overall-value">Calculando...</div>
                </div>
            </div>
        </div>

        <!-- CHECKLIST DE NEGOCIACIÓN -->
        <div class="card checklist-section no-print" id="seccion-checklist">
            <h2>✅ Checklist de Negociación</h2>
            <p style="margin-bottom: 1rem; color: #6d28d9;">
                Usa este checklist para asegurarte de cubrir todos los puntos importantes durante la negociación.
            </p>

            <div class="checklist-progress">
                <div class="checklist-progress-bar">
                    <div class="checklist-progress-fill" id="checklistProgressFill" style="width: 0%"></div>
                </div>
                <div class="checklist-progress-text">
                    <span id="checklistProgressItems">0 de 0 puntos completados</span>
                    <span class="percentage" id="checklistProgressPercent">0%</span>
                </div>
            </div>

            <div class="checklist-groups" id="checklistGroups">
                <!-- Se llena con JavaScript -->
            </div>

            <div class="checklist-actions">
                <button class="btn btn-primary" onclick="markAllChecklist(true)">
                    ✅ Marcar todo
                </button>
                <button class="btn btn-secondary" onclick="markAllChecklist(false)">
                    🔄 Reiniciar checklist
                </button>
                <button class="copy-btn" onclick="exportChecklistSummary()" style="background: #8b5cf6;">
                    <span class="icon">📋</span>
                    <span>Exportar resumen</span>
                </button>
            </div>

            <div class="checklist-summary" id="checklistSummary">
                <h4>📊 Resumen de Negociación</h4>
                <div class="checklist-summary-content" id="checklistSummaryContent"></div>
            </div>
        </div>

        <!-- CLÁUSULAS SUGERIDAS -->
        <div class="card clauses-section no-print" id="seccion-clausulas">
            <h2>📜 Cláusulas Contractuales Sugeridas</h2>
            <p style="margin-bottom: 1rem; color: #92400e;">
                Selecciona las cláusulas que deseas incluir en tu contrato. Estas son sugerencias basadas en alianzas estratégicas típicas.
            </p>

            <div class="clauses-categories">
                <button class="category-tab active" onclick="filterClauses('all')" id="catAll">
                    📋 Todas
                </button>
                <button class="category-tab" onclick="filterClauses('financial')" id="catFinancial">
                    💰 Financieras
                </button>
                <button class="category-tab" onclick="filterClauses('ip')" id="catIp">
                    📜 Propiedad Intelectual
                </button>
                <button class="category-tab" onclick="filterClauses('operations')" id="catOperations">
                    ⚙️ Operativas
                </button>
                <button class="category-tab" onclick="filterClauses('exit')" id="catExit">
                    🚪 Salida/Terminación
                </button>
            </div>

            <div class="clauses-list" id="clausesList">
                <!-- Se llena con JavaScript -->
            </div>

            <div class="clauses-actions">
                <button class="btn btn-primary" onclick="selectEssentialClauses()">
                    ✅ Seleccionar esenciales
                </button>
                <button class="btn btn-secondary" onclick="clearAllClauses()">
                    🗑️ Limpiar selección
                </button>
                <button class="copy-btn" onclick="copySelectedClauses()" style="background: var(--accent-gold);">
                    <span class="icon">📋</span>
                    <span>Copiar cláusulas</span>
                </button>
                <span class="clauses-counter" id="clausesCounter">0 cláusulas seleccionadas</span>
            </div>

            <div class="clauses-output" id="clausesOutput">
                <div class="clauses-output-header">
                    <h4 style="margin: 0; color: var(--primary-dark);">📄 Documento de Cláusulas</h4>
                    <button class="btn btn-secondary" onclick="toggleClausesOutput()" style="padding: 0.5rem 1rem;">
                        ✕ Cerrar
                    </button>
                </div>
                <div class="clauses-output-content" id="clausesOutputContent">
                    <!-- Se llena con JavaScript -->
                </div>
            </div>
        </div>

        <!-- RESUMEN EJECUTIVO COPIABLE -->
        <div class="card summary-section no-print" id="seccion-copiable">
            <h2>📋 Resumen Ejecutivo Copiable</h2>
            <p style="margin-bottom: 1rem; color: var(--gray-700);">
                Genera un resumen de texto listo para pegar en emails, documentos o mensajes.
            </p>

            <div class="summary-format-selector">
                <button class="format-btn active" onclick="setSummaryFormat('formal')" id="formatFormal">
                    📧 Formal (Email)
                </button>
                <button class="format-btn" onclick="setSummaryFormat('bullet')" id="formatBullet">
                    📝 Puntos Clave
                </button>
                <button class="format-btn" onclick="setSummaryFormat('brief')" id="formatBrief">
                    ⚡ Ultra Breve
                </button>
            </div>

            <div class="summary-preview" id="summaryPreview">
                <!-- Se llena con JavaScript -->
            </div>

            <div class="summary-actions">
                <button class="copy-btn" onclick="copySummaryToClipboard()" id="copyBtn">
                    <span class="icon">📋</span>
                    <span id="copyBtnText">Copiar al portapapeles</span>
                </button>
                <button class="btn btn-secondary" onclick="generateSummary()">
                    🔄 Actualizar resumen
                </button>
            </div>

            <div class="summary-tip">
                <span class="icon">💡</span>
                <span>El resumen se actualiza automáticamente cuando cambias la configuración. Puedes copiarlo y pegarlo directamente en un email o documento.</span>
            </div>
        </div>

        <!-- EXPORTACIÓN PDF -->
        <div class="export-section no-print" id="seccion-exportar">
            <h2>📄 Exportar Propuesta</h2>
            <p style="opacity: 0.9;">Genera un documento PDF profesional para presentar tu propuesta de alianza.</p>

            <div class="pdf-options">
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeConfig" checked>
                    <label for="pdfIncludeConfig">Configuración base</label>
                </div>
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeProjects" checked>
                    <label for="pdfIncludeProjects">Proyectos simulados</label>
                </div>
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeEquity" checked>
                    <label for="pdfIncludeEquity">Equity y vesting</label>
                </div>
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeProjection" checked>
                    <label for="pdfIncludeProjection">Proyección temporal</label>
                </div>
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeBreakeven" checked>
                    <label for="pdfIncludeBreakeven">Análisis break-even</label>
                </div>
                <div class="pdf-option">
                    <input type="checkbox" id="pdfIncludeSummary" checked>
                    <label for="pdfIncludeSummary">Resumen ejecutivo</label>
                </div>
            </div>

            <div class="export-options">
                <button class="export-btn primary" onclick="exportToPDF()">
                    <span class="icon">📥</span>
                    <span>Descargar PDF</span>
                </button>
                <button class="export-btn" onclick="window.print()">
                    <span class="icon">🖨️</span>
                    <span>Imprimir</span>
                </button>
            </div>

            <div class="export-progress" id="exportProgress">
                <div class="export-spinner"></div>
                <span>Generando PDF...</span>
            </div>
        </div>
    </div>

    <script>
        // ========== NAVEGACIÓN ==========

        function initNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = [];

            // Recolectar todas las secciones
            navItems.forEach(item => {
                const sectionId = item.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                if (section) {
                    sections.push({ id: sectionId, element: section, navItem: item });
                }
            });

            // Scroll suave al hacer click
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    const section = document.getElementById(sectionId);
                    if (section) {
                        const targetPosition = section.offsetTop - 20;
                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });

                        // Cerrar menú en móvil
                        const navMenu = document.getElementById('navMenu');
                        if (window.innerWidth <= 768) {
                            navMenu.classList.remove('expanded');
                        }
                    }
                });
            });

            // Detectar sección activa al hacer scroll
            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        updateActiveNavItem(sections);
                        ticking = false;
                    });
                    ticking = true;
                }
            });

            // Inicializar estado activo
            updateActiveNavItem(sections);
        }

        function updateActiveNavItem(sections) {
            const scrollPosition = window.scrollY + 100;

            let activeSection = sections[0];

            for (const section of sections) {
                if (section.element.offsetTop <= scrollPosition) {
                    activeSection = section;
                }
            }

            // Actualizar clases activas
            sections.forEach(section => {
                section.navItem.classList.remove('active');
            });

            if (activeSection) {
                activeSection.navItem.classList.add('active');

                // Auto-scroll del menú vertical para mostrar el item activo
                const navInner = document.querySelector('.nav-menu-inner');
                const activeItem = activeSection.navItem;
                if (navInner && activeItem) {
                    const itemTop = activeItem.offsetTop;
                    const itemHeight = activeItem.offsetHeight;
                    const menuHeight = navInner.offsetHeight;
                    const scrollTop = navInner.scrollTop;

                    if (itemTop < scrollTop || itemTop + itemHeight > scrollTop + menuHeight) {
                        navInner.scrollTo({
                            top: itemTop - menuHeight / 2 + itemHeight / 2,
                            behavior: 'smooth'
                        });
                    }
                }
            }
        }

        // ========== SECCIONES COLAPSABLES ==========

        const sectionSummaries = {
            'seccion-config': () => {
                return [
                    { label: 'Retainer', value: `$${state.retainer.toLocaleString()}/mes` },
                    { label: 'PI', value: `${state.ipSplit}% / ${100 - state.ipSplit}%` },
                    { label: 'Duración', value: `${state.duration} meses` },
                    { label: 'Tipo', value: state.retainerType === 'hours' ? 'Horas' : 'Proyectos' }
                ];
            },
            'seccion-proyectos': () => {
                const total = state.projects.reduce((sum, p) => sum + p.value, 0);
                const clientProjects = state.projects.filter(p => p.type === 'cliente').length;
                return [
                    { label: 'Proyectos', value: state.projects.length },
                    { label: 'Valor total', value: `$${total.toLocaleString()}` },
                    { label: 'Para clientes', value: clientProjects }
                ];
            },
            'seccion-gastos': () => {
                const totalExpenses = getTotalExpenses();
                const numProjects = projectsData.projects.length;
                const currentProject = getCurrentProject();
                const currentProjectExpenses = currentProject ? getProjectExpenses(currentProject.id) : 0;
                return [
                    { label: 'Proyectos', value: numProjects },
                    { label: 'Gastos totales', value: `$${totalExpenses.toLocaleString()}` },
                    { label: 'Proyecto actual', value: `$${currentProjectExpenses.toLocaleString()}` }
                ];
            },
            'seccion-breakeven': () => {
                const monthlyNet = state.retainer;
                const months = monthlyNet > 0 ? Math.ceil(50000 / monthlyNet) : '∞';
                return [
                    { label: 'Inversión inicial', value: '$50,000' },
                    { label: 'Meses estimados', value: months }
                ];
            },
            'seccion-referidos': () => {
                const total = state.referrals.reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);
                return [
                    { label: 'Referidos', value: state.referrals.length },
                    { label: 'Comisión', value: `${state.finderFee}%` },
                    { label: 'Total ganado', value: `$${total.toLocaleString()}` }
                ];
            },
            'seccion-equity': () => {
                return [
                    { label: 'Equity', value: `${state.equityPercent}%` },
                    { label: 'Vesting', value: `${state.vestingPeriod} meses` },
                    { label: 'Cliff', value: `${state.cliffPeriod} meses` }
                ];
            },
            'seccion-resumen': () => {
                const retainerTotal = state.retainer * state.duration;
                const totalExpenses = getTotalExpenses();
                const ipGross = state.projects.filter(p => p.type === 'cliente').reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);
                const ipNet = Math.max(0, ipGross - totalExpenses);
                return [
                    { label: 'Iguala total', value: `$${retainerTotal.toLocaleString()}` },
                    { label: 'PI Neto', value: `$${ipNet.toLocaleString()}` },
                    { label: 'Gastos', value: `-$${totalExpenses.toLocaleString()}` }
                ];
            },
            'seccion-proyeccion': () => {
                return [
                    { label: 'Período', value: `${state.duration} meses` },
                    { label: 'Gráfico', value: 'Ingresos mensuales' }
                ];
            },
            'seccion-comparador': () => {
                return [
                    { label: 'Escenarios guardados', value: savedScenarios.length },
                    { label: 'Slots', value: '3 disponibles' }
                ];
            },
            'seccion-guardados': () => {
                const saved = JSON.parse(localStorage.getItem('alliance_configs') || '[]');
                return [
                    { label: 'Configuraciones', value: saved.length },
                    { label: 'Storage', value: 'localStorage' }
                ];
            },
            'seccion-escenarios': () => {
                return [
                    { label: 'Disponibles', value: '3 escenarios' },
                    { label: 'Tipos', value: 'Conservador, Moderado, Optimista' }
                ];
            },
            'seccion-salud': () => {
                const { totalScore } = typeof calculateDealHealth === 'function' ? calculateDealHealth() : { totalScore: 0 };
                const verdict = totalScore >= 85 ? 'Excelente' : totalScore >= 70 ? 'Bueno' : totalScore >= 50 ? 'Regular' : 'Débil';
                return [
                    { label: 'Puntuación', value: `${totalScore}/100` },
                    { label: 'Estado', value: verdict }
                ];
            },
            'seccion-riesgos': () => {
                return [
                    { label: 'Riesgos analizados', value: '12 categorías' },
                    { label: 'Estado', value: 'Ver evaluación' }
                ];
            },
            'seccion-checklist': () => {
                const checklistState = JSON.parse(localStorage.getItem('negotiation_checklist') || '{}');
                const total = Object.keys(checklistState).length || 37;
                const completed = Object.values(checklistState).filter(v => v).length;
                return [
                    { label: 'Completados', value: `${completed}/${total}` },
                    { label: 'Progreso', value: `${Math.round((completed/total)*100)}%` }
                ];
            },
            'seccion-clausulas': () => {
                return [
                    { label: 'Cláusulas', value: '17 sugeridas' },
                    { label: 'Categorías', value: '4 tipos' }
                ];
            },
            'seccion-copiable': () => {
                return [
                    { label: 'Formatos', value: '3 estilos' },
                    { label: 'Listo para', value: 'Email/Documento' }
                ];
            }
        };

        function initCollapsibleSections() {
            const collapsibleSections = [
                'seccion-config', 'seccion-proyectos', 'seccion-gastos', 'seccion-breakeven',
                'seccion-referidos', 'seccion-equity', 'seccion-resumen', 'seccion-proyeccion',
                'seccion-comparador', 'seccion-guardados', 'seccion-escenarios',
                'seccion-salud', 'seccion-riesgos', 'seccion-checklist', 'seccion-clausulas', 'seccion-copiable'
            ];

            collapsibleSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) return;

                // Agregar clase collapsible
                section.classList.add('collapsible');

                // Obtener el h2 existente
                const h2 = section.querySelector('h2');
                if (!h2) return;

                // Crear estructura colapsable
                const header = document.createElement('div');
                header.className = 'card-header';
                header.onclick = () => toggleSection(sectionId);

                const toggle = document.createElement('button');
                toggle.className = 'card-toggle';
                toggle.innerHTML = '▼';
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    toggleSection(sectionId);
                };

                // Mover h2 al header
                header.appendChild(h2.cloneNode(true));
                header.appendChild(toggle);

                // Crear contenedor de contenido
                const content = document.createElement('div');
                content.className = 'card-content';

                // Mover todo el contenido excepto h2 al contenedor
                const children = Array.from(section.children);
                children.forEach(child => {
                    if (child !== h2) {
                        content.appendChild(child);
                    }
                });

                // Crear resumen
                const summary = document.createElement('div');
                summary.className = 'card-summary';
                summary.id = `summary-${sectionId}`;

                // Limpiar sección y agregar nueva estructura
                section.innerHTML = '';
                section.appendChild(header);
                section.appendChild(content);
                section.appendChild(summary);

                // Generar resumen inicial
                updateSectionSummary(sectionId);
            });
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;

            section.classList.toggle('collapsed');
            updateSectionSummary(sectionId);

            // Guardar estado en localStorage
            const collapsedState = JSON.parse(localStorage.getItem('collapsed_sections') || '{}');
            collapsedState[sectionId] = section.classList.contains('collapsed');
            localStorage.setItem('collapsed_sections', JSON.stringify(collapsedState));
        }

        function updateSectionSummary(sectionId) {
            const summaryEl = document.getElementById(`summary-${sectionId}`);
            if (!summaryEl || !sectionSummaries[sectionId]) return;

            const items = sectionSummaries[sectionId]();
            summaryEl.innerHTML = `
                <div class="card-summary-items">
                    ${items.map(item => `
                        <div class="card-summary-item">
                            <span class="label">${item.label}:</span>
                            <span class="value">${item.value}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateAllSummaries() {
            Object.keys(sectionSummaries).forEach(sectionId => {
                updateSectionSummary(sectionId);
            });
        }

        function restoreCollapsedState() {
            const collapsedState = JSON.parse(localStorage.getItem('collapsed_sections') || '{}');
            Object.keys(collapsedState).forEach(sectionId => {
                if (collapsedState[sectionId]) {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        section.classList.add('collapsed');
                    }
                }
            });
        }

        function expandAllSections() {
            document.querySelectorAll('.card.collapsible').forEach(card => {
                card.classList.remove('collapsed');
            });
            localStorage.removeItem('collapsed_sections');
        }

        function collapseAllSections() {
            const collapsedState = {};
            document.querySelectorAll('.card.collapsible').forEach(card => {
                card.classList.add('collapsed');
                if (card.id) {
                    collapsedState[card.id] = true;
                    updateSectionSummary(card.id);
                }
            });
            localStorage.setItem('collapsed_sections', JSON.stringify(collapsedState));
        }

        // ========== ESTADO GLOBAL ==========

        // Estado global de la aplicación
        const state = {
            projects: [],
            referrals: [],
            retainer: 25000,
            retainerType: 'hours', // 'hours' o 'projects'
            ipSplit: 50,
            duration: 24,
            finderFee: 10,
            studioValuation: 5000000,
            studioFutureValue: 15000000,
            agencyValuation: 7500000,
            agencyFutureValue: 25000000,
            equityPercent: 3,
            vestingPeriod: 36,
            cliffPeriod: 12
        };

        // Escenarios guardados para comparar
        const savedScenarios = [];
        const scenarioSlots = ['A', 'B', 'C'];
        const slotColors = {
            'A': 'slot-a',
            'B': 'slot-b',
            'C': 'slot-c'
        };

        // Estado de costos para la calculadora de utilidad (soporte multi-proyecto)
        const projectsData = {
            currentProjectId: null,
            projects: []
        };

        // Función para obtener proyecto actual o crear uno por defecto
        function getCurrentProject() {
            if (projectsData.projects.length === 0) {
                addNewCostProject('Proyecto Principal');
            }
            return projectsData.projects.find(p => p.id === projectsData.currentProjectId) || projectsData.projects[0];
        }

        // Obtener costos del proyecto actual (para compatibilidad)
        function getProjectCosts() {
            const project = getCurrentProject();
            return project ? project.costs : { labor: [], tools: [], other: [] };
        }

        // Calcular gastos totales de todos los proyectos
        function getTotalExpenses() {
            return projectsData.projects.reduce((total, project) => {
                const laborCosts = project.costs.labor.reduce((sum, item) => sum + item.amount, 0);
                const toolsCosts = project.costs.tools.reduce((sum, item) => sum + item.amount, 0);
                const otherCosts = project.costs.other.reduce((sum, item) => sum + item.amount, 0);
                return total + laborCosts + toolsCosts + otherCosts;
            }, 0);
        }

        // Calcular gastos de un proyecto específico
        function getProjectExpenses(projectId) {
            const project = projectsData.projects.find(p => p.id === projectId);
            if (!project) return 0;
            const laborCosts = project.costs.labor.reduce((sum, item) => sum + item.amount, 0);
            const toolsCosts = project.costs.tools.reduce((sum, item) => sum + item.amount, 0);
            const otherCosts = project.costs.other.reduce((sum, item) => sum + item.amount, 0);
            return laborCosts + toolsCosts + otherCosts;
        }

        // Tarifa base por hora en MXN (cuando PI es 50%)
        const TARIFA_HORA_BASE = 500;

        // Calcula la tarifa por hora ajustada según el % de PI
        // Más PI = menor tarifa (compensación por participación en ventas)
        // Menos PI = mayor tarifa (compensación por no participar en ventas)
        function calcularTarifaAjustada(piPercent) {
            // Fórmula: por cada 10% de PI arriba/abajo del 50%, la tarifa cambia 10%
            // 50% PI = $500/hr (base)
            // 60% PI = $450/hr (-10%)
            // 70% PI = $400/hr (-20%)
            // 40% PI = $550/hr (+10%)
            // 30% PI = $600/hr (+20%)
            const ajuste = (50 - piPercent) / 50; // -1 a +1
            const tarifaAjustada = TARIFA_HORA_BASE * (1 + ajuste);
            return Math.round(tarifaAjustada);
        }

        // Escala de horas según precio del retainer (en MXN)
        // Basado en $500 MXN/hora
        const hoursScale = [
            { price: 5000, hours: 10, projects: 1 },
            { price: 7500, hours: 15, projects: 1 },
            { price: 10000, hours: 20, projects: 2 },
            { price: 12500, hours: 25, projects: 2 },
            { price: 15000, hours: 30, projects: 2 },
            { price: 17500, hours: 35, projects: 3 },
            { price: 20000, hours: 40, projects: 3 },
            { price: 22500, hours: 45, projects: 3 },
            { price: 25000, hours: 50, projects: 4 },
            { price: 30000, hours: 60, projects: 4 },
            { price: 35000, hours: 70, projects: 5 },
            { price: 40000, hours: 80, projects: 5 },
            { price: 45000, hours: 90, projects: 6 },
            { price: 50000, hours: 100, projects: 6 },
            { price: 55000, hours: 110, projects: 7 },
            { price: 60000, hours: 120, projects: 7 },
            { price: 70000, hours: 140, projects: 8 },
            { price: 80000, hours: 160, projects: 9 },
            { price: 90000, hours: 180, projects: 9 },
            { price: 100000, hours: 200, projects: 10 }
        ];

        function getRetainerDetails(price) {
            // Tarifa ajustada según PI
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);

            // Calcular horas incluidas basándose en el retainer y la tarifa ajustada
            const horasCalculadas = Math.floor(price / tarifaAjustada);

            // Para proyectos, usar una proporción aproximada (1 proyecto ≈ 10 horas)
            const proyectosCalculados = Math.floor(horasCalculadas / 10);

            const units = state.retainerType === 'hours' ? horasCalculadas : Math.max(1, proyectosCalculados);
            const ratePerUnit = tarifaAjustada;
            const extraRate = Math.round(ratePerUnit * 1.2); // +20% para extras

            return {
                units,
                ratePerUnit,
                extraRate,
                tarifaBase: TARIFA_HORA_BASE
            };
        }

        function setRetainerType(type) {
            state.retainerType = type;

            // Actualizar botones
            document.getElementById('toggleHours').classList.toggle('active', type === 'hours');
            document.getElementById('toggleProjects').classList.toggle('active', type === 'projects');

            // Actualizar labels
            updateRetainerLabels();
            updateRetainerDisplay();
        }

        function updateRetainerLabels() {
            const isHours = state.retainerType === 'hours';
            document.getElementById('unitsLabel').textContent = isHours ? 'horas incluidas/mes' : 'proyectos incluidos/mes';
            document.getElementById('rateLabel').textContent = isHours ? 'tarifa por hora' : 'tarifa por proyecto';
            document.getElementById('extraRateLabel').textContent = isHours ? 'hora extra (+20%)' : 'proyecto extra (+20%)';

            // Actualizar escala visual
            updateScaleDisplay();
        }

        function updateScaleDisplay() {
            const scaleContainer = document.getElementById('hoursScale');
            const isHours = state.retainerType === 'hours';
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);

            // Calcular horas dinámicamente según la tarifa ajustada
            const scalePoints = [
                { price: 5000 },
                { price: 15000 },
                { price: 25000 },
                { price: 40000 },
                { price: 60000 },
                { price: 100000 }
            ].map(point => ({
                ...point,
                hours: Math.floor(point.price / tarifaAjustada),
                projects: Math.max(1, Math.floor(point.price / tarifaAjustada / 10))
            }));

            scaleContainer.innerHTML = scalePoints.map(point => {
                const isActive = Math.abs(state.retainer - point.price) < 5000;
                const value = isHours ? `${point.hours}h` : `${point.projects}p`;
                return `
                    <div class="hours-scale-item ${isActive ? 'active' : ''}" data-value="${point.price}">
                        <div>$${(point.price / 1000)}K</div>
                        <div>${value}</div>
                    </div>
                `;
            }).join('');
        }

        function updateRetainerDisplay() {
            const details = getRetainerDetails(state.retainer);
            const isHours = state.retainerType === 'hours';

            document.getElementById('includedUnits').textContent = details.units;
            document.getElementById('ratePerUnit').textContent = `$${details.ratePerUnit} MXN`;
            document.getElementById('extraRate').textContent = `$${details.extraRate} MXN`;

            // Actualizar escala activa
            updateScaleDisplay();

            // Calcular diferencia de tarifa vs base
            const diferenciaTarifa = details.ratePerUnit - TARIFA_HORA_BASE;
            let ajusteTexto = '';
            if (diferenciaTarifa > 0) {
                ajusteTexto = `<span style="color: #059669;">+$${diferenciaTarifa} por menor PI</span>`;
            } else if (diferenciaTarifa < 0) {
                ajusteTexto = `<span style="color: #2563eb;">-$${Math.abs(diferenciaTarifa)} por mayor PI</span>`;
            } else {
                ajusteTexto = `<span style="color: #6b7280;">tarifa base (50% PI)</span>`;
            }

            // Actualizar info box
            const unitType = isHours ? 'horas' : 'proyectos/entregables';
            const unitSingular = isHours ? 'hora' : 'proyecto';
            document.getElementById('retainerInfo').innerHTML = `
                Con una iguala de <strong>$${state.retainer.toLocaleString()} MXN/mes</strong> y
                <strong>${state.ipSplit}% de PI</strong> se incluyen
                <strong>${details.units} ${unitType}</strong> de desarrollo.
                <br><br>
                <strong>Tarifa ajustada:</strong> $${details.ratePerUnit} MXN/${unitSingular} ${ajusteTexto}
                <br>
                <strong>Hora extra:</strong> $${details.extraRate} MXN (+20%)
                <br><br>
                <em style="font-size: 0.85rem; color: #6b7280;">
                    Lógica: Tarifa base $${TARIFA_HORA_BASE}/hr con 50% PI.
                    Más PI → menor tarifa (compensación por ventas).
                    Menos PI → mayor tarifa.
                </em>
            `;
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            initCollapsibleSections();
            restoreCollapsedState();
            initNavigation();
            setupEventListeners();
            // Inicializar sistema multi-proyecto
            initProjectsSystem();
            updateRetainerDisplay();
            updateAllCalculations();
            calculateProfit();
            calculateBreakeven();
            renderSavedConfigsList();
            updateStorageInfo();
            generateSummary();
            renderClauses();
            initChecklist();
            initRisks();
            initDealHealth();
            initAlerts();
        });

        // Inicializar sistema de proyectos
        function initProjectsSystem() {
            if (projectsData.projects.length === 0) {
                addNewCostProject('Proyecto Principal');
            }
            renderProjectSelector();
            renderAllCostCategories();
        }

        function setupEventListeners() {
            document.getElementById('retainer').addEventListener('input', function(e) {
                state.retainer = parseInt(e.target.value);
                document.getElementById('retainerValue').textContent = `$${state.retainer.toLocaleString()} MXN/mes`;
                updateRetainerDisplay();
                updateAllCalculations();
                // Sincronizar con calculadora de break-even
                document.getElementById('beMonthlyRetainer').value = state.retainer;
                calculateBreakeven();
            });

            document.getElementById('ipSplit').addEventListener('input', function(e) {
                state.ipSplit = parseInt(e.target.value);
                document.getElementById('ipSplitValue').textContent = `${state.ipSplit}% / ${100 - state.ipSplit}%`;
                updateRetainerDisplay();
                updateProjectsTable();
                // Actualizar módulo de licencias
                if (typeof renderLicensesTable === 'function') {
                    renderLicensesTable();
                    updateLicenseSummary();
                    updateLicenseProjection();
                }
                updateAllCalculations();
            });

            document.getElementById('duration').addEventListener('change', function(e) {
                state.duration = parseInt(e.target.value);
                updateAllCalculations();
            });

            document.getElementById('finderFee').addEventListener('input', function(e) {
                state.finderFee = parseInt(e.target.value);
                document.getElementById('finderFeeValue').textContent = `${state.finderFee}%`;
                updateReferralsTable();
                updateAllCalculations();
            });

            document.getElementById('studioValuation').addEventListener('input', function(e) {
                state.studioValuation = parseInt(e.target.value) || 0;
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('studioFutureValue').addEventListener('input', function(e) {
                state.studioFutureValue = parseInt(e.target.value) || 0;
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('agencyValuation').addEventListener('input', function(e) {
                state.agencyValuation = parseInt(e.target.value) || 0;
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('agencyFutureValue').addEventListener('input', function(e) {
                state.agencyFutureValue = parseInt(e.target.value) || 0;
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('equityPercent').addEventListener('input', function(e) {
                state.equityPercent = parseFloat(e.target.value);
                document.getElementById('equityPercentValue').textContent = `${state.equityPercent}%`;
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('vestingPeriod').addEventListener('change', function(e) {
                state.vestingPeriod = parseInt(e.target.value);
                updateEquityDisplay();
                updateAllCalculations();
            });

            document.getElementById('cliffPeriod').addEventListener('change', function(e) {
                state.cliffPeriod = parseInt(e.target.value);
                updateEquityDisplay();
                updateAllCalculations();
            });
        }

        function addProject() {
            const name = document.getElementById('projectName').value.trim();
            const value = parseInt(document.getElementById('projectValue').value) || 0;
            const type = document.getElementById('projectType').value;

            if (!name || value <= 0) {
                alert('Por favor completa el nombre y un valor válido del proyecto');
                return;
            }

            state.projects.push({ name, value, type });
            document.getElementById('projectName').value = '';
            document.getElementById('projectValue').value = '';
            updateProjectsTable();
            updateAllCalculations();
        }

        function deleteProject(index) {
            state.projects.splice(index, 1);
            updateProjectsTable();
            updateAllCalculations();
        }

        function updateProjectsTable() {
            const tbody = document.getElementById('projectsTableBody');

            if (state.projects.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray-700); padding: 2rem;">
                            No hay proyectos agregados. Añade tu primer proyecto arriba.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.projects.map((project, index) => {
                const studioSplit = project.type === 'cliente' ? (project.value * state.ipSplit / 100) : project.value;
                const agencySplit = project.type === 'cliente' ? (project.value * (100 - state.ipSplit) / 100) : 0;

                return `
                    <tr>
                        <td>${project.name}</td>
                        <td>$${project.value.toLocaleString()}</td>
                        <td><span class="badge badge-${project.type}">${project.type === 'interno' ? 'Interno' : 'Cliente'}</span></td>
                        <td>$${Math.round(studioSplit).toLocaleString()}</td>
                        <td>$${Math.round(agencySplit).toLocaleString()}</td>
                        <td><button class="delete-btn" onclick="deleteProject(${index})">Eliminar</button></td>
                    </tr>
                `;
            }).join('');
        }

        function addReferral() {
            const name = document.getElementById('referralName').value.trim();
            const value = parseInt(document.getElementById('referralValue').value) || 0;

            if (!name || value <= 0) {
                alert('Por favor completa el nombre y un valor válido del referido');
                return;
            }

            state.referrals.push({ name, value });
            document.getElementById('referralName').value = '';
            document.getElementById('referralValue').value = '';
            updateReferralsTable();
            updateAllCalculations();
        }

        function deleteReferral(index) {
            state.referrals.splice(index, 1);
            updateReferralsTable();
            updateAllCalculations();
        }

        function updateReferralsTable() {
            const tbody = document.getElementById('referralsTableBody');

            if (state.referrals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--gray-700); padding: 2rem;">
                            No hay referidos agregados.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = state.referrals.map((referral, index) => {
                const commission = referral.value * state.finderFee / 100;
                return `
                    <tr>
                        <td>${referral.name}</td>
                        <td>$${referral.value.toLocaleString()}</td>
                        <td>$${Math.round(commission).toLocaleString()}</td>
                        <td><button class="delete-btn" onclick="deleteReferral(${index})">Eliminar</button></td>
                    </tr>
                `;
            }).join('');
        }

        function updateEquityDisplay() {
            const equityPct = state.equityPercent / 100;

            // Cálculos para el ESTUDIO (lo que gana la Agencia si venden el Estudio)
            const studioCurrentValue = state.studioValuation * equityPct;
            const studioFutureOptionsValue = state.studioFutureValue * equityPct;
            const studioGain = studioFutureOptionsValue - studioCurrentValue;
            const studioMultiple = state.studioValuation > 0 ? (state.studioFutureValue / state.studioValuation) : 0;

            // Cálculos para la AGENCIA (lo que gana el Estudio si venden la Agencia)
            const agencyCurrentValue = state.agencyValuation * equityPct;
            const agencyFutureOptionsValue = state.agencyFutureValue * equityPct;
            const agencyGain = agencyFutureOptionsValue - agencyCurrentValue;
            const agencyMultiple = state.agencyValuation > 0 ? (state.agencyFutureValue / state.agencyValuation) : 0;

            // Cálculos de vesting para el ESTUDIO (opciones sobre la Agencia)
            const vestingMonths = state.vestingPeriod;
            const cliffMonths = state.cliffPeriod;
            const vestingMonthsAfterCliff = vestingMonths - cliffMonths;

            // Valor mensual que se desbloquea (después del cliff)
            const monthlyVestingValue = vestingMonthsAfterCliff > 0 ? agencyFutureOptionsValue / vestingMonthsAfterCliff : 0;
            const cliffValue = cliffMonths > 0 ? (agencyFutureOptionsValue / vestingMonths) * cliffMonths : 0;

            // Actualizar resultado del Estudio
            document.getElementById('studioEquityResult').innerHTML = `
                <div class="equity-result-row">
                    <span class="label">Valor opciones HOY (${state.equityPercent}%)</span>
                    <span class="value">$${Math.round(studioCurrentValue).toLocaleString()}</span>
                </div>
                <div class="equity-result-row">
                    <span class="label">Valor al momento de venta</span>
                    <span class="value">$${Math.round(studioFutureOptionsValue).toLocaleString()}</span>
                </div>
                <div class="equity-result-row">
                    <span class="label">Múltiplo de crecimiento</span>
                    <span class="value">${studioMultiple.toFixed(1)}x</span>
                </div>
                <div class="equity-result-row profit">
                    <span class="label">Ganancia para Agencia</span>
                    <span class="value">+$${Math.round(studioGain).toLocaleString()}</span>
                </div>
            `;

            // Actualizar resultado de la Agencia
            document.getElementById('agencyEquityResult').innerHTML = `
                <div class="equity-result-row">
                    <span class="label">Valor opciones HOY (${state.equityPercent}%)</span>
                    <span class="value">$${Math.round(agencyCurrentValue).toLocaleString()}</span>
                </div>
                <div class="equity-result-row">
                    <span class="label">Valor al momento de venta</span>
                    <span class="value">$${Math.round(agencyFutureOptionsValue).toLocaleString()}</span>
                </div>
                <div class="equity-result-row">
                    <span class="label">Múltiplo de crecimiento</span>
                    <span class="value">${agencyMultiple.toFixed(1)}x</span>
                </div>
                <div class="equity-result-row profit">
                    <span class="label">Ganancia para Estudio</span>
                    <span class="value">+$${Math.round(agencyGain).toLocaleString()}</span>
                </div>
            `;

            // Actualizar resumen de equity
            document.getElementById('studioGainFromAgency').textContent = `$${Math.round(agencyGain).toLocaleString()}`;
            document.getElementById('agencyGainFromStudio').textContent = `$${Math.round(studioGain).toLocaleString()}`;
            document.getElementById('totalEquityValue').textContent = `$${Math.round(studioGain + agencyGain).toLocaleString()}`;

            // Actualizar desglose de vesting
            updateVestingBreakdown(agencyFutureOptionsValue, agencyGain, vestingMonths, cliffMonths);

            return {
                studioGain,
                agencyGain,
                totalGain: studioGain + agencyGain
            };
        }

        function updateVestingBreakdown(totalValue, totalGain, vestingMonths, cliffMonths) {
            const vestingMonthsAfterCliff = vestingMonths - cliffMonths;

            // Valor mensual después del cliff
            const monthlyValue = vestingMonthsAfterCliff > 0 ? totalValue / vestingMonths : 0;
            const cliffValue = monthlyValue * cliffMonths;

            // Calcular porcentajes para la barra de timeline
            const cliffPercent = (cliffMonths / vestingMonths) * 100;
            const vestingPercent = 100 - cliffPercent;

            // Generar tabla de desglose por año
            let tableRows = '';
            let accumulated = 0;
            const years = Math.ceil(vestingMonths / 12);

            for (let year = 1; year <= years; year++) {
                const startMonth = (year - 1) * 12 + 1;
                const endMonth = Math.min(year * 12, vestingMonths);

                let yearValue = 0;
                for (let month = startMonth; month <= endMonth; month++) {
                    if (month <= cliffMonths) {
                        // Durante el cliff no se recibe nada (se acumula)
                        if (month === cliffMonths) {
                            yearValue += cliffValue; // Se desbloquea todo el cliff al final
                        }
                    } else {
                        yearValue += monthlyValue;
                    }
                }

                accumulated += yearValue;
                const percentVested = (accumulated / totalValue) * 100;

                tableRows += `
                    <tr>
                        <td>Año ${year} (Mes ${startMonth}-${endMonth})</td>
                        <td>$${Math.round(yearValue).toLocaleString()}</td>
                        <td>$${Math.round(accumulated).toLocaleString()}</td>
                        <td>${percentVested.toFixed(0)}%</td>
                    </tr>
                `;
            }

            document.getElementById('vestingBreakdown').innerHTML = `
                <h5>Desglose de Vesting para el Estudio (Opciones sobre Agencia)</h5>

                <div class="vesting-stats">
                    <div class="vesting-stat">
                        <div class="number">$${Math.round(monthlyValue).toLocaleString()}</div>
                        <div class="label">Valor mensual devengado</div>
                    </div>
                    <div class="vesting-stat highlight">
                        <div class="number">$${Math.round(totalGain / vestingMonths).toLocaleString()}</div>
                        <div class="label">Ganancia mensual</div>
                    </div>
                    <div class="vesting-stat">
                        <div class="number">${cliffMonths > 0 ? '$' + Math.round(cliffValue).toLocaleString() : 'N/A'}</div>
                        <div class="label">Valor al terminar cliff</div>
                    </div>
                    <div class="vesting-stat">
                        <div class="number">${vestingMonths}</div>
                        <div class="label">Meses para 100%</div>
                    </div>
                </div>

                <div class="vesting-timeline">
                    <h6>Timeline de Vesting</h6>
                    <div class="timeline-bar">
                        ${cliffPercent > 0 ? `<div class="timeline-cliff" style="width: ${cliffPercent}%">Cliff (${cliffMonths}m)</div>` : ''}
                        <div class="timeline-vesting" style="width: ${vestingPercent}%">Vesting lineal (${vestingMonthsAfterCliff}m)</div>
                    </div>
                    <div class="timeline-labels">
                        <span>Mes 0</span>
                        ${cliffMonths > 0 ? `<span>Cliff: Mes ${cliffMonths}</span>` : ''}
                        <span>Mes ${vestingMonths}</span>
                    </div>
                </div>

                <table class="vesting-table">
                    <thead>
                        <tr>
                            <th>Período</th>
                            <th>Valor Desbloqueado</th>
                            <th>Acumulado</th>
                            <th>% Vestido</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                        <tr>
                            <td><strong>Total</strong></td>
                            <td><strong>$${Math.round(totalValue).toLocaleString()}</strong></td>
                            <td><strong>$${Math.round(totalValue).toLocaleString()}</strong></td>
                            <td><strong>100%</strong></td>
                        </tr>
                    </tbody>
                </table>

                <div class="info-box" style="margin-top: 1rem;">
                    <strong>Resumen:</strong> Si la agencia se vende por $${state.agencyFutureValue.toLocaleString()} después de ${vestingMonths} meses,
                    el estudio recibiría <strong>$${Math.round(totalValue).toLocaleString()}</strong> en total
                    (ganancia neta de <strong>$${Math.round(totalGain).toLocaleString()}</strong>).
                    <br><br>
                    <em>Esto equivale a ~$${Math.round(totalGain / vestingMonths).toLocaleString()} MXN de ganancia mensual devengada.</em>
                </div>
            `;
        }

        function updateAllCalculations() {
            // Calcular ingresos por iguala
            const retainerTotal = state.retainer * state.duration;

            // Calcular GASTOS TOTALES de todos los proyectos
            const totalExpenses = getTotalExpenses();

            // Calcular ingresos BRUTOS por PI (solo proyectos vendidos a clientes)
            const ipGross = state.projects
                .filter(p => p.type === 'cliente')
                .reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);

            // Calcular ingresos NETOS por PI (después de gastos)
            // Los gastos se restan del IP ya que son costos de desarrollo
            const ipFromProjects = Math.max(0, ipGross - totalExpenses);

            // Calcular ingresos por licencias (ya calculados con PI incluido)
            const licenseIncome = typeof getTotalLicenseIncome === 'function' ? getTotalLicenseIncome() : 0;

            // Total PI = proyectos + licencias
            const ipTotal = ipFromProjects + licenseIncome;

            // Calcular finder's fees (estos no tienen gastos asociados)
            const referralTotal = state.referrals
                .reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);

            // Calcular valor potencial de equity (ganancias)
            const equityData = updateEquityDisplay();
            const equityTotal = equityData.totalGain;

            // Actualizar resumen con indicador de neto
            document.getElementById('retainerTotal').textContent = `$${Math.round(retainerTotal).toLocaleString()}`;

            // Mostrar IP neto con indicador de gastos y licencias
            const ipTotalEl = document.getElementById('ipTotal');
            const hasExpenses = totalExpenses > 0;
            const hasLicenses = licenseIncome > 0;
            let ipLabel = '';
            if (hasExpenses || hasLicenses) {
                const parts = [];
                if (hasExpenses) parts.push('neto');
                if (hasLicenses) parts.push('+lic');
                ipLabel = ` <small style="color: var(--gray-400); font-size: 0.7em;">(${parts.join(' ')})</small>`;
            }
            ipTotalEl.innerHTML = `$${Math.round(ipTotal).toLocaleString()}${ipLabel}`;

            document.getElementById('referralTotal').textContent = `$${Math.round(referralTotal).toLocaleString()}`;
            document.getElementById('equityTotal').textContent = `$${Math.round(equityTotal).toLocaleString()}`;

            // Actualizar gráficos con valores netos
            updateChart(retainerTotal, ipTotal, referralTotal, equityTotal);
            updateProjectionChart();

            // Actualizar selector de proyectos
            if (typeof renderProjectSelector === 'function') {
                renderProjectSelector();
            }

            // Actualizar resumen ejecutivo copiable
            if (typeof generateSummary === 'function') {
                generateSummary();
            }

            // Verificar alertas inteligentes
            if (typeof checkAlerts === 'function') {
                checkAlerts();
            }

            // Actualizar indicadores de salud del deal
            if (typeof renderDealHealth === 'function') {
                renderDealHealth();
            }

            // Actualizar resúmenes de secciones colapsadas
            if (typeof updateAllSummaries === 'function') {
                updateAllSummaries();
            }
        }

        function updateChart(retainer, ip, referral, equity) {
            const total = retainer + ip + referral + equity;
            const chartBars = document.getElementById('chartBars');

            const data = [
                { label: 'Iguala', value: retainer, class: '' },
                { label: 'PI', value: ip, class: 'green' },
                { label: "Finder's Fee", value: referral, class: 'gold' },
                { label: 'Equity', value: equity, class: '' }
            ];

            chartBars.innerHTML = data.map(item => {
                const percentage = total > 0 ? (item.value / total) * 100 : 0;
                return `
                    <div style="flex: 1; text-align: center;">
                        <div class="chart-bar ${item.class}" style="height: ${percentage}%;">
                            <div class="chart-bar-value">$${Math.round(item.value).toLocaleString()}</div>
                        </div>
                        <div class="chart-bar-label">${item.label}</div>
                    </div>
                `;
            }).join('');
        }

        function updateProjectionChart() {
            const view = document.getElementById('projectionView').value;
            const showCumulative = document.getElementById('showCumulative').checked;
            const includeEquity = document.getElementById('includeEquity').checked;

            const duration = state.duration;
            const monthlyRetainer = state.retainer;

            // Calcular gastos totales
            const totalExpenses = getTotalExpenses();

            // Calcular ingresos NETOS por PI distribuidos en el tiempo (después de gastos)
            const ipGross = state.projects
                .filter(p => p.type === 'cliente')
                .reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);
            const totalIP = Math.max(0, ipGross - totalExpenses);
            const monthlyIP = totalIP / duration;

            // Finder's fees distribuidos
            const totalFinder = state.referrals
                .reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);
            const monthlyFinder = totalFinder / duration;

            // Equity (solo al final del vesting si está habilitado)
            const equityPct = state.equityPercent / 100;
            const totalEquity = includeEquity ?
                (state.agencyFutureValue * equityPct) + (state.studioFutureValue * equityPct) : 0;

            // Generar datos según la vista
            let periods = [];
            let periodLabels = [];

            if (view === 'monthly') {
                for (let i = 1; i <= duration; i++) {
                    periods.push(i);
                    periodLabels.push(`M${i}`);
                }
            } else if (view === 'quarterly') {
                const quarters = Math.ceil(duration / 3);
                for (let i = 1; i <= quarters; i++) {
                    periods.push(i);
                    periodLabels.push(`T${i}`);
                }
            } else { // yearly
                const years = Math.ceil(duration / 12);
                for (let i = 1; i <= years; i++) {
                    periods.push(i);
                    periodLabels.push(`Año ${i}`);
                }
            }

            // Calcular valores por período
            const multiplier = view === 'monthly' ? 1 : (view === 'quarterly' ? 3 : 12);
            const periodData = periods.map((period, index) => {
                const isLastPeriod = index === periods.length - 1;
                const monthsInPeriod = view === 'monthly' ? 1 :
                    (view === 'quarterly' ? Math.min(3, duration - (period - 1) * 3) :
                    Math.min(12, duration - (period - 1) * 12));

                return {
                    label: periodLabels[index],
                    retainer: monthlyRetainer * monthsInPeriod,
                    ip: monthlyIP * monthsInPeriod,
                    finder: monthlyFinder * monthsInPeriod,
                    equity: (includeEquity && isLastPeriod) ? totalEquity : 0
                };
            });

            // Encontrar el valor máximo para escalar
            let maxValue = 0;
            let cumulativeValues = [];
            let cumulative = 0;

            periodData.forEach(p => {
                const total = p.retainer + p.ip + p.finder + p.equity;
                cumulative += total;
                cumulativeValues.push(cumulative);
                if (total > maxValue) maxValue = total;
            });

            // Usar maxValue para las barras (no el acumulado, que las haría muy pequeñas)
            const maxForBars = maxValue;
            // Usar el acumulado máximo para el eje Y cuando se muestra la línea acumulada
            const maxForScale = showCumulative ? Math.max(maxValue, cumulative) : maxValue;

            // Renderizar el gráfico
            const chartArea = document.getElementById('projectionChartArea');
            chartArea.innerHTML = periodData.map((p, index) => {
                const total = p.retainer + p.ip + p.finder + p.equity;
                // Las barras usan su propia escala para que sean visibles
                const retainerHeight = maxForBars > 0 ? (p.retainer / maxForBars) * 100 : 0;
                const ipHeight = maxForBars > 0 ? (p.ip / maxForBars) * 100 : 0;
                const finderHeight = maxForBars > 0 ? (p.finder / maxForBars) * 100 : 0;
                const equityHeight = maxForBars > 0 ? (p.equity / maxForBars) * 100 : 0;

                return `
                    <div class="chart-bar-group"
                         onmouseenter="showTooltip(event, '${p.label}', ${Math.round(p.retainer)}, ${Math.round(p.ip)}, ${Math.round(p.finder)}, ${Math.round(p.equity)}, ${Math.round(cumulativeValues[index])})"
                         onmouseleave="hideTooltip()">
                        <div class="chart-bar-stack">
                            ${p.equity > 0 ? `<div class="chart-segment equity" style="height: ${equityHeight}%;"></div>` : ''}
                            ${p.finder > 0 ? `<div class="chart-segment finder" style="height: ${finderHeight}%;"></div>` : ''}
                            ${p.ip > 0 ? `<div class="chart-segment ip" style="height: ${ipHeight}%;"></div>` : ''}
                            <div class="chart-segment retainer" style="height: ${retainerHeight}%;"></div>
                        </div>
                        <div class="chart-x-label">${p.label}</div>
                    </div>
                `;
            }).join('');

            // Renderizar eje Y
            const yAxis = document.getElementById('chartYAxis');
            const steps = 5;
            yAxis.innerHTML = Array.from({length: steps + 1}, (_, i) => {
                const value = maxForScale * (1 - i / steps);
                return `<span>$${formatCompact(value)}</span>`;
            }).join('');

            // Renderizar línea acumulada
            if (showCumulative && periodData.length > 1) {
                const lineContainer = document.getElementById('cumulativeLine');
                const width = 100;
                const height = 100;
                const points = cumulativeValues.map((val, i) => {
                    const x = (i / (periodData.length - 1)) * width;
                    const y = height - (val / maxForScale) * height;
                    return `${x},${y}`;
                }).join(' ');

                lineContainer.innerHTML = `
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polyline points="${points}" />
                    </svg>
                `;
            } else {
                document.getElementById('cumulativeLine').innerHTML = '';
            }

            // Actualizar resumen
            const totalRetainer = monthlyRetainer * duration;
            const grandTotal = totalRetainer + totalIP + totalFinder + (includeEquity ? totalEquity : 0);
            const monthlyAvg = grandTotal / duration;

            document.getElementById('projectionSummary').innerHTML = `
                <div class="projection-stat">
                    <div class="value">$${formatCompact(grandTotal)}</div>
                    <div class="label">Total proyectado</div>
                </div>
                <div class="projection-stat">
                    <div class="value">$${formatCompact(monthlyAvg)}</div>
                    <div class="label">Promedio mensual</div>
                </div>
                <div class="projection-stat">
                    <div class="value">$${formatCompact(totalRetainer)}</div>
                    <div class="label">Total retainer</div>
                </div>
                <div class="projection-stat">
                    <div class="value">$${formatCompact(totalIP + totalFinder)}</div>
                    <div class="label">Total PI + Finder's</div>
                </div>
                ${includeEquity ? `
                <div class="projection-stat">
                    <div class="value">$${formatCompact(totalEquity)}</div>
                    <div class="label">Valor equity</div>
                </div>
                ` : ''}
            `;
        }

        function formatCompact(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toLocaleString();
        }

        function showTooltip(event, label, retainer, ip, finder, equity, cumulative) {
            const tooltip = document.getElementById('chartTooltip');
            const total = retainer + ip + finder + equity;
            tooltip.innerHTML = `
                <strong>${label}</strong><br>
                Retainer: $${retainer.toLocaleString()}<br>
                PI: $${ip.toLocaleString()}<br>
                Finder: $${finder.toLocaleString()}<br>
                ${equity > 0 ? `Equity: $${equity.toLocaleString()}<br>` : ''}
                <strong>Total: $${total.toLocaleString()}</strong><br>
                <em>Acumulado: $${cumulative.toLocaleString()}</em>
            `;
            tooltip.classList.add('visible');
            tooltip.style.left = event.pageX - tooltip.offsetParent.offsetLeft + 10 + 'px';
            tooltip.style.top = event.pageY - tooltip.offsetParent.offsetTop - 80 + 'px';
        }

        function hideTooltip() {
            document.getElementById('chartTooltip').classList.remove('visible');
        }

        // ========== CALCULADORA DE GASTOS Y UTILIDAD (MULTI-PROYECTO) ==========

        // Agregar nuevo proyecto de costos
        function addNewCostProject(name = '') {
            const id = Date.now();
            const projectName = name || `Proyecto ${projectsData.projects.length + 1}`;
            const newProject = {
                id,
                name: projectName,
                value: 100000, // Valor por defecto
                costs: {
                    labor: [],
                    tools: [],
                    other: []
                }
            };
            projectsData.projects.push(newProject);
            projectsData.currentProjectId = id;
            renderProjectSelector();
            renderAllCostCategories();
            calculateProfit();
            updateAllCalculations();
            return newProject;
        }

        // Eliminar proyecto de costos
        function deleteCostProject(projectId) {
            if (projectsData.projects.length <= 1) {
                alert('Debe haber al menos un proyecto');
                return;
            }
            if (!confirm('¿Eliminar este proyecto y todos sus gastos?')) return;

            projectsData.projects = projectsData.projects.filter(p => p.id !== projectId);
            if (projectsData.currentProjectId === projectId) {
                projectsData.currentProjectId = projectsData.projects[0]?.id || null;
            }
            renderProjectSelector();
            renderAllCostCategories();
            calculateProfit();
            updateAllCalculations();
        }

        // Cambiar proyecto activo
        function selectCostProject(projectId) {
            projectsData.currentProjectId = projectId;
            const project = getCurrentProject();
            if (project) {
                document.getElementById('projectTotalValue').value = project.value || 100000;
            }
            renderProjectSelector();
            renderAllCostCategories();
            calculateProfit();
        }

        // Actualizar nombre de proyecto
        function updateCostProjectName(projectId, name) {
            const project = projectsData.projects.find(p => p.id === projectId);
            if (project) {
                project.name = name;
                renderProjectSelector();
            }
        }

        // Actualizar valor del proyecto actual
        function updateCurrentProjectValue(value) {
            const project = getCurrentProject();
            if (project) {
                project.value = parseFloat(value) || 0;
                calculateProfit();
                updateAllCalculations();
            }
        }

        // Renderizar selector de proyectos
        function renderProjectSelector() {
            const container = document.getElementById('projectSelector');
            if (!container) return;

            container.innerHTML = `
                <div class="project-tabs">
                    ${projectsData.projects.map(p => `
                        <div class="project-tab ${p.id === projectsData.currentProjectId ? 'active' : ''}"
                             onclick="selectCostProject(${p.id})">
                            <input type="text"
                                   class="project-tab-name"
                                   value="${p.name}"
                                   onclick="event.stopPropagation()"
                                   onchange="updateCostProjectName(${p.id}, this.value)"
                                   onkeydown="if(event.key==='Enter')this.blur()">
                            <span class="project-tab-total">$${getProjectExpenses(p.id).toLocaleString()}</span>
                            ${projectsData.projects.length > 1 ? `
                                <button class="project-tab-delete" onclick="event.stopPropagation(); deleteCostProject(${p.id})" title="Eliminar proyecto">×</button>
                            ` : ''}
                        </div>
                    `).join('')}
                    <button class="add-project-btn" onclick="addNewCostProject()">
                        + Nuevo Proyecto
                    </button>
                </div>
                <div class="projects-summary">
                    <span class="summary-label">Total todos los proyectos:</span>
                    <span class="summary-value">$${getTotalExpenses().toLocaleString()}</span>
                </div>
            `;
        }

        function addCostItem(category, name = '', amount = 0) {
            const project = getCurrentProject();
            if (!project) return;

            const id = Date.now();
            project.costs[category].push({ id, name, amount });
            renderCostItems(category);
            calculateProfit();
            updateAllCalculations();
        }

        function addPresetCost(category, name, amount) {
            addCostItem(category, name, amount);
        }

        function removeCostItem(category, id) {
            const project = getCurrentProject();
            if (!project) return;

            project.costs[category] = project.costs[category].filter(item => item.id !== id);
            renderCostItems(category);
            calculateProfit();
            updateAllCalculations();
        }

        function updateCostItem(category, id, field, value) {
            const project = getCurrentProject();
            if (!project) return;

            const item = project.costs[category].find(item => item.id === id);
            if (item) {
                item[field] = field === 'amount' ? (parseFloat(value) || 0) : value;
                calculateProfit();
                updateAllCalculations();
            }
        }

        function renderCostItems(category) {
            const container = document.getElementById(`${category}Costs`);
            const totalElement = document.getElementById(`${category}Total`);
            const projectCosts = getProjectCosts();

            if (!projectCosts[category] || projectCosts[category].length === 0) {
                container.innerHTML = '';
                totalElement.textContent = '$0';
                return;
            }

            container.innerHTML = projectCosts[category].map(item => `
                <div class="cost-item">
                    <input type="text"
                           value="${item.name}"
                           placeholder="Descripción"
                           onchange="updateCostItem('${category}', ${item.id}, 'name', this.value)">
                    <input type="number"
                           value="${item.amount}"
                           placeholder="$0"
                           onchange="updateCostItem('${category}', ${item.id}, 'amount', this.value)">
                    <button class="remove-cost" onclick="removeCostItem('${category}', ${item.id})">×</button>
                </div>
            `).join('');

            const total = projectCosts[category].reduce((sum, item) => sum + item.amount, 0);
            totalElement.textContent = `$${total.toLocaleString()}`;
        }

        function renderAllCostCategories() {
            renderCostItems('labor');
            renderCostItems('tools');
            renderCostItems('other');
            renderProjectSelector();
        }

        function updateProfitIpDisplay() {
            const value = document.getElementById('profitIpSplit').value;
            document.getElementById('profitIpDisplay').textContent = `${value}%`;
        }

        function calculateProfit() {
            const project = getCurrentProject();
            if (!project) return;

            const projectValue = parseFloat(document.getElementById('projectTotalValue').value) || 0;
            project.value = projectValue; // Sincronizar valor

            const ipSplit = parseFloat(document.getElementById('profitIpSplit').value) || 0;

            // Calcular costos del proyecto
            const projectCosts = getProjectCosts();
            const laborCosts = projectCosts.labor.reduce((sum, item) => sum + item.amount, 0);
            const toolsCosts = projectCosts.tools.reduce((sum, item) => sum + item.amount, 0);
            const otherCosts = projectCosts.other.reduce((sum, item) => sum + item.amount, 0);
            const totalCosts = laborCosts + toolsCosts + otherCosts;

            // NUEVO: Primero restar gastos, luego aplicar PI
            const grossProfit = projectValue - totalCosts;  // Utilidad bruta del proyecto
            const yourShare = grossProfit * (ipSplit / 100); // Tu parte del PI sobre utilidad
            const netProfit = yourShare; // Tu utilidad neta = tu parte del split

            const margin = grossProfit > 0 ? (yourShare / grossProfit) * 100 : 0;
            const roi = totalCosts > 0 ? (grossProfit / totalCosts) * 100 : 0;

            // Estimar horas (asumiendo costo promedio por hora de trabajo)
            const estimatedHours = laborCosts > 0 ? laborCosts / 300 : 40; // $300/hr promedio o 40 hrs default
            const profitPerHour = estimatedHours > 0 ? yourShare / estimatedHours : 0;

            // Actualizar UI
            document.getElementById('profitProjectValue').textContent = `$${projectValue.toLocaleString()}`;
            document.getElementById('profitTotalCosts').textContent = `-$${totalCosts.toLocaleString()}`;
            document.getElementById('profitGrossProfit').textContent = `$${grossProfit.toLocaleString()}`;
            document.getElementById('profitGrossProfit').className = `value ${grossProfit >= 0 ? '' : 'negative'}`;
            document.getElementById('profitIpLabel').textContent = `${ipSplit}%`;
            document.getElementById('profitYourShare').textContent = `$${yourShare.toLocaleString()}`;

            const netProfitEl = document.getElementById('profitNetProfit');
            netProfitEl.textContent = `$${netProfit.toLocaleString()}`;
            netProfitEl.className = `value ${netProfit >= 0 ? 'positive' : 'negative'}`;

            // Actualizar barra de margen
            const marginFill = document.getElementById('marginFill');
            const marginPercent = document.getElementById('marginPercent');
            const clampedMargin = Math.max(0, Math.min(100, margin));

            marginFill.style.width = `${clampedMargin}%`;
            marginFill.className = `margin-fill ${margin < 20 ? 'low' : margin < 40 ? 'medium' : 'high'}`;
            marginPercent.textContent = `${margin.toFixed(0)}%`;
            marginPercent.className = `margin-percent ${margin < 20 ? 'low' : margin < 40 ? 'medium' : 'high'}`;

            // Actualizar cards
            document.getElementById('profitPerHour').textContent = `$${Math.round(profitPerHour).toLocaleString()}`;
            document.getElementById('profitROI').textContent = `${roi.toFixed(0)}%`;

            // Actualizar totales de categorías
            document.getElementById('laborTotal').textContent = `$${laborCosts.toLocaleString()}`;
            document.getElementById('toolsTotal').textContent = `$${toolsCosts.toLocaleString()}`;
            document.getElementById('otherTotal').textContent = `$${otherCosts.toLocaleString()}`;
        }

        // ========== MÓDULO DE LICENCIAS ==========

        const licenseProducts = [];

        function addLicenseProduct() {
            const name = document.getElementById('licenseProductName').value.trim();
            const price = parseFloat(document.getElementById('licensePricePerUnit').value) || 0;
            const type = document.getElementById('licenseType').value;
            const cost = parseFloat(document.getElementById('licenseCostPerUnit').value) || 0;

            if (!name || price <= 0) {
                alert('Por favor ingresa un nombre y precio válido para el producto.');
                return;
            }

            const product = {
                id: Date.now(),
                name,
                price,
                type,
                costPerUnit: cost,
                sold: 0
            };

            licenseProducts.push(product);
            renderLicensesTable();
            updateLicenseSummary();
            updateLicenseProjection();

            // Limpiar formulario
            document.getElementById('licenseProductName').value = '';
            document.getElementById('licensePricePerUnit').value = '';
            document.getElementById('licenseCostPerUnit').value = '0';
        }

        function updateLicenseSold(id, value) {
            const product = licenseProducts.find(p => p.id === id);
            if (product) {
                product.sold = parseInt(value) || 0;
                renderLicensesTable();
                updateLicenseSummary();
                updateAllCalculations();
            }
        }

        function removeLicenseProduct(id) {
            const index = licenseProducts.findIndex(p => p.id === id);
            if (index > -1) {
                licenseProducts.splice(index, 1);
                renderLicensesTable();
                updateLicenseSummary();
                updateLicenseProjection();
                updateAllCalculations();
            }
        }

        function addPresetLicense(name, price, type, cost) {
            const product = {
                id: Date.now(),
                name,
                price,
                type,
                costPerUnit: cost,
                sold: 0
            };
            licenseProducts.push(product);
            renderLicensesTable();
            updateLicenseSummary();
            updateLicenseProjection();
        }

        function getLicenseTypeLabel(type) {
            const labels = {
                'one-time': 'Único',
                'monthly': 'Mensual',
                'annual': 'Anual'
            };
            return labels[type] || type;
        }

        function renderLicensesTable() {
            const tbody = document.getElementById('licensesTableBody');
            const piPercent = state.ipSplit;
            document.getElementById('licensePiPercent').textContent = piPercent;

            if (licenseProducts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: var(--gray-500); padding: 2rem; font-size: 0.9rem;">
                            🎫 No hay productos aún. Usa los botones rápidos o agrega uno manualmente.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = licenseProducts.map(product => {
                const revenue = product.price * product.sold;
                const costs = product.costPerUnit * product.sold;
                const grossProfit = revenue - costs;
                const yourShare = grossProfit * (piPercent / 100);

                return `
                    <tr>
                        <td><strong>${product.name}</strong></td>
                        <td>$${product.price.toLocaleString()}</td>
                        <td><span class="license-type-badge ${product.type}">${getLicenseTypeLabel(product.type)}</span></td>
                        <td>$${product.costPerUnit.toLocaleString()}</td>
                        <td>
                            <input type="number" value="${product.sold}" min="0"
                                   onchange="updateLicenseSold(${product.id}, this.value)">
                        </td>
                        <td>$${revenue.toLocaleString()}</td>
                        <td class="${grossProfit >= 0 ? 'positive' : 'negative'}">$${grossProfit.toLocaleString()}</td>
                        <td class="positive"><strong>$${yourShare.toLocaleString()}</strong></td>
                        <td>
                            <button class="btn-delete" onclick="removeLicenseProduct(${product.id})">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateLicenseSummary() {
            const piPercent = state.ipSplit;
            let totalRevenue = 0;
            let totalCosts = 0;

            licenseProducts.forEach(product => {
                totalRevenue += product.price * product.sold;
                totalCosts += product.costPerUnit * product.sold;
            });

            const grossProfit = totalRevenue - totalCosts;
            const yourShare = grossProfit * (piPercent / 100);

            document.getElementById('totalLicenseRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
            document.getElementById('totalLicenseCosts').textContent = `$${totalCosts.toLocaleString()}`;
            document.getElementById('totalLicenseGrossProfit').textContent = `$${grossProfit.toLocaleString()}`;
            document.getElementById('totalLicenseYourShare').textContent = `$${yourShare.toLocaleString()}`;
        }

        function updateLicenseProjection() {
            const licensesPerMonth = parseInt(document.getElementById('projectedLicensesPerMonth').value) || 0;
            const months = parseInt(document.getElementById('licenseProjectionMonths').value) || 12;
            const growthRate = parseFloat(document.getElementById('licenseGrowthRate').value) || 0;
            const piPercent = state.ipSplit;

            // Calcular precio promedio y costo promedio de los productos
            let avgPrice = 0;
            let avgCost = 0;
            if (licenseProducts.length > 0) {
                avgPrice = licenseProducts.reduce((sum, p) => sum + p.price, 0) / licenseProducts.length;
                avgCost = licenseProducts.reduce((sum, p) => sum + p.costPerUnit, 0) / licenseProducts.length;
            }

            // Proyección con crecimiento compuesto
            let totalLicenses = 0;
            let currentMonthlyLicenses = licensesPerMonth;

            for (let i = 0; i < months; i++) {
                totalLicenses += currentMonthlyLicenses;
                currentMonthlyLicenses *= (1 + growthRate / 100);
            }

            totalLicenses = Math.round(totalLicenses);
            const projectedRevenue = totalLicenses * avgPrice;
            const projectedCosts = totalLicenses * avgCost;
            const projectedGrossProfit = projectedRevenue - projectedCosts;
            const projectedYourShare = projectedGrossProfit * (piPercent / 100);

            document.getElementById('projectedTotalLicenses').textContent = totalLicenses.toLocaleString();
            document.getElementById('projectedLicenseRevenue').textContent = `$${Math.round(projectedRevenue).toLocaleString()}`;
            document.getElementById('projectedLicenseProfit').textContent = `$${Math.round(projectedYourShare).toLocaleString()}`;
        }

        function getTotalLicenseIncome() {
            const piPercent = state.ipSplit;
            let totalGrossProfit = 0;

            licenseProducts.forEach(product => {
                const revenue = product.price * product.sold;
                const costs = product.costPerUnit * product.sold;
                totalGrossProfit += revenue - costs;
            });

            return totalGrossProfit * (piPercent / 100);
        }

        // ========== COMPARADOR DE ESCENARIOS ==========

        function calculateScenarioMetrics() {
            const retainerTotal = state.retainer * state.duration;
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);
            const horasIncluidas = Math.floor(state.retainer / tarifaAjustada);

            // Calcular gastos totales
            const totalExpenses = getTotalExpenses();

            // IP Bruto
            const ipGross = state.projects
                .filter(p => p.type === 'cliente')
                .reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);

            // IP Neto (después de gastos)
            const ipTotal = Math.max(0, ipGross - totalExpenses);

            const finderTotal = state.referrals
                .reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);

            const equityPct = state.equityPercent / 100;
            const equityGain = (state.agencyFutureValue - state.agencyValuation) * equityPct +
                              (state.studioFutureValue - state.studioValuation) * equityPct;

            const grandTotal = retainerTotal + ipTotal + finderTotal + equityGain;
            const monthlyAvg = grandTotal / state.duration;

            return {
                retainer: state.retainer,
                retainerTotal,
                ipSplit: state.ipSplit,
                duration: state.duration,
                tarifaHora: tarifaAjustada,
                horasIncluidas,
                ipTotal,
                finderFee: state.finderFee,
                finderTotal,
                equityPercent: state.equityPercent,
                equityGain,
                grandTotal,
                monthlyAvg,
                projectCount: state.projects.length,
                referralCount: state.referrals.length
            };
        }

        function saveCurrentScenario() {
            if (savedScenarios.length >= 3) {
                alert('Máximo 3 escenarios. Elimina uno para agregar otro.');
                return;
            }

            const slot = scenarioSlots[savedScenarios.length];
            const metrics = calculateScenarioMetrics();
            const name = prompt('Nombre del escenario:', `Escenario ${slot}`) || `Escenario ${slot}`;

            savedScenarios.push({
                slot,
                name,
                metrics,
                timestamp: new Date().toLocaleTimeString()
            });

            renderScenarioComparator();
        }

        function deleteScenario(index) {
            savedScenarios.splice(index, 1);
            // Reasignar slots
            savedScenarios.forEach((s, i) => {
                s.slot = scenarioSlots[i];
            });
            renderScenarioComparator();
        }

        function clearAllScenarios() {
            if (savedScenarios.length === 0) return;
            if (confirm('¿Eliminar todos los escenarios guardados?')) {
                savedScenarios.length = 0;
                renderScenarioComparator();
            }
        }

        function renderScenarioComparator() {
            const container = document.getElementById('scenariosContainer');

            if (savedScenarios.length === 0) {
                container.innerHTML = `
                    <div class="scenario-card empty" onclick="saveCurrentScenario()">
                        <div class="empty-slot-content">
                            <div class="icon">📊</div>
                            <div>Haz clic para guardar<br>el escenario actual</div>
                        </div>
                    </div>
                `;
                document.getElementById('comparisonInsights').style.display = 'none';
                return;
            }

            // Encontrar mejor y peor para cada métrica
            const bestWorst = findBestWorstMetrics();

            let html = savedScenarios.map((scenario, index) => {
                const m = scenario.metrics;
                const slotClass = slotColors[scenario.slot];

                return `
                    <div class="scenario-card ${slotClass}">
                        <div class="scenario-header ${slotClass}">
                            <h4>${scenario.name}</h4>
                            <button class="delete-scenario" onclick="deleteScenario(${index})">×</button>
                        </div>
                        <div class="scenario-body">
                            <div class="scenario-metric ${bestWorst.retainer.best === index ? 'best' : bestWorst.retainer.worst === index ? 'worst' : ''}">
                                <span class="label">Retainer mensual</span>
                                <span class="value">$${m.retainer.toLocaleString()}</span>
                            </div>
                            <div class="scenario-metric">
                                <span class="label">Tarifa/hora</span>
                                <span class="value">$${m.tarifaHora}</span>
                            </div>
                            <div class="scenario-metric">
                                <span class="label">Horas incluidas</span>
                                <span class="value">${m.horasIncluidas}h/mes</span>
                            </div>
                            <div class="scenario-metric ${bestWorst.ipSplit.best === index ? 'best' : bestWorst.ipSplit.worst === index ? 'worst' : ''}">
                                <span class="label">% PI</span>
                                <span class="value">${m.ipSplit}%</span>
                            </div>
                            <div class="scenario-metric">
                                <span class="label">Duración</span>
                                <span class="value">${m.duration} meses</span>
                            </div>
                            <div class="scenario-metric ${bestWorst.retainerTotal.best === index ? 'best' : ''}">
                                <span class="label">Total retainer</span>
                                <span class="value">$${formatCompact(m.retainerTotal)}</span>
                            </div>
                            <div class="scenario-metric ${bestWorst.ipTotal.best === index ? 'best' : ''}">
                                <span class="label">Total PI</span>
                                <span class="value">$${formatCompact(m.ipTotal)}</span>
                            </div>
                            <div class="scenario-metric">
                                <span class="label">Finder's fee (${m.finderFee}%)</span>
                                <span class="value">$${formatCompact(m.finderTotal)}</span>
                            </div>
                            <div class="scenario-metric ${bestWorst.equityGain.best === index ? 'best' : ''}">
                                <span class="label">Ganancia equity (${m.equityPercent}%)</span>
                                <span class="value">$${formatCompact(m.equityGain)}</span>
                            </div>
                            <div class="scenario-total">
                                <div class="amount ${bestWorst.grandTotal.best === index ? 'best' : ''}">$${formatCompact(m.grandTotal)}</div>
                                <div class="label">Total proyectado</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Agregar slot vacío si hay espacio
            if (savedScenarios.length < 3) {
                html += `
                    <div class="scenario-card empty" onclick="saveCurrentScenario()">
                        <div class="empty-slot-content">
                            <div class="icon">➕</div>
                            <div>Agregar otro<br>escenario</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Mostrar insights si hay al menos 2 escenarios
            if (savedScenarios.length >= 2) {
                renderComparisonInsights(bestWorst);
            } else {
                document.getElementById('comparisonInsights').style.display = 'none';
            }
        }

        function findBestWorstMetrics() {
            const metrics = ['retainer', 'retainerTotal', 'ipSplit', 'ipTotal', 'equityGain', 'grandTotal'];
            const result = {};

            metrics.forEach(metric => {
                let bestIndex = 0;
                let worstIndex = 0;
                let bestValue = savedScenarios[0]?.metrics[metric] || 0;
                let worstValue = savedScenarios[0]?.metrics[metric] || 0;

                savedScenarios.forEach((s, i) => {
                    if (s.metrics[metric] > bestValue) {
                        bestValue = s.metrics[metric];
                        bestIndex = i;
                    }
                    if (s.metrics[metric] < worstValue) {
                        worstValue = s.metrics[metric];
                        worstIndex = i;
                    }
                });

                result[metric] = { best: bestIndex, worst: worstIndex, bestValue, worstValue };
            });

            return result;
        }

        function renderComparisonInsights(bestWorst) {
            const insights = document.getElementById('comparisonInsights');
            const content = document.getElementById('insightsContent');

            const best = savedScenarios[bestWorst.grandTotal.best];
            const diff = bestWorst.grandTotal.bestValue - bestWorst.grandTotal.worstValue;
            const diffPercent = ((diff / bestWorst.grandTotal.worstValue) * 100).toFixed(0);

            let insightsHtml = `
                <div class="insight-item">
                    <span class="icon">🏆</span>
                    <span class="text">
                        <strong>${best.name}</strong> genera el mayor ingreso total:
                        <strong>$${formatCompact(best.metrics.grandTotal)}</strong>
                    </span>
                </div>
            `;

            if (savedScenarios.length >= 2) {
                insightsHtml += `
                    <div class="insight-item">
                        <span class="icon">📊</span>
                        <span class="text">
                            Diferencia entre el mejor y peor escenario:
                            <strong>$${formatCompact(diff)}</strong> (${diffPercent}% más)
                        </span>
                    </div>
                `;

                // Comparar retainers
                const retainerBest = savedScenarios[bestWorst.retainer.best];
                const retainerWorst = savedScenarios[bestWorst.retainer.worst];
                if (retainerBest !== retainerWorst) {
                    insightsHtml += `
                        <div class="insight-item">
                            <span class="icon">💰</span>
                            <span class="text">
                                <strong>${retainerBest.name}</strong> tiene el retainer más alto ($${retainerBest.metrics.retainer.toLocaleString()}/mes)
                                pero menor tarifa por hora ($${retainerBest.metrics.tarifaHora})
                            </span>
                        </div>
                    `;
                }

                // Comparar PI
                const ipBest = savedScenarios[bestWorst.ipSplit.best];
                if (ipBest.metrics.ipSplit !== savedScenarios[bestWorst.ipSplit.worst].metrics.ipSplit) {
                    insightsHtml += `
                        <div class="insight-item">
                            <span class="icon">📜</span>
                            <span class="text">
                                <strong>${ipBest.name}</strong> maximiza la participación en PI (${ipBest.metrics.ipSplit}%)
                                generando <strong>$${formatCompact(ipBest.metrics.ipTotal)}</strong> en proyectos
                            </span>
                        </div>
                    `;
                }

                // Equity
                const equityBest = savedScenarios[bestWorst.equityGain.best];
                if (equityBest.metrics.equityGain > 0) {
                    insightsHtml += `
                        <div class="insight-item">
                            <span class="icon">🚀</span>
                            <span class="text">
                                <strong>${equityBest.name}</strong> tiene el mayor potencial de equity:
                                <strong>$${formatCompact(equityBest.metrics.equityGain)}</strong>
                            </span>
                        </div>
                    `;
                }
            }

            content.innerHTML = insightsHtml;
            insights.style.display = 'block';
        }

        function loadScenario(type) {
            // Limpiar proyectos y referidos actuales
            state.projects = [];
            state.referrals = [];

            switch(type) {
                case 'conservative':
                    state.retainer = 15000;
                    state.ipSplit = 40;
                    state.duration = 12;
                    state.finderFee = 5;
                    state.equityPercent = 2;
                    state.studioValuation = 3000000;
                    state.studioFutureValue = 5000000;
                    state.agencyValuation = 5000000;
                    state.agencyFutureValue = 8000000;
                    // Proyectos conservadores (en MXN)
                    state.projects = [
                        { name: 'Chatbot Básico', value: 150000, type: 'cliente' },
                        { name: 'Landing Page IA', value: 80000, type: 'interno' }
                    ];
                    state.referrals = [
                        { name: 'Referido Pequeño', value: 50000 }
                    ];
                    break;

                case 'moderate':
                    state.retainer = 35000;
                    state.ipSplit = 50;
                    state.duration = 24;
                    state.finderFee = 10;
                    state.equityPercent = 3;
                    state.studioValuation = 5000000;
                    state.studioFutureValue = 15000000;
                    state.agencyValuation = 7500000;
                    state.agencyFutureValue = 25000000;
                    // Proyectos moderados (en MXN)
                    state.projects = [
                        { name: 'Plataforma IA Personalizada', value: 450000, type: 'cliente' },
                        { name: 'Sistema de Automatización', value: 300000, type: 'cliente' },
                        { name: 'Dashboard Analytics', value: 200000, type: 'interno' },
                        { name: 'Herramienta Interna', value: 120000, type: 'interno' }
                    ];
                    state.referrals = [
                        { name: 'Referido Mediano 1', value: 250000 },
                        { name: 'Referido Mediano 2', value: 180000 }
                    ];
                    break;

                case 'optimistic':
                    state.retainer = 60000;
                    state.ipSplit = 60;
                    state.duration = 36;
                    state.finderFee = 15;
                    state.equityPercent = 5;
                    state.studioValuation = 10000000;
                    state.studioFutureValue = 50000000;
                    state.agencyValuation = 15000000;
                    state.agencyFutureValue = 75000000;
                    // Proyectos optimistas (en MXN)
                    state.projects = [
                        { name: 'Plataforma Enterprise IA', value: 1200000, type: 'cliente' },
                        { name: 'Sistema ML Completo', value: 850000, type: 'cliente' },
                        { name: 'Automatización Avanzada', value: 650000, type: 'cliente' },
                        { name: 'Suite de Herramientas', value: 450000, type: 'interno' },
                        { name: 'Dashboard Premium', value: 300000, type: 'interno' }
                    ];
                    state.referrals = [
                        { name: 'Referido Grande 1', value: 750000 },
                        { name: 'Referido Grande 2', value: 500000 },
                        { name: 'Referido Mediano', value: 300000 }
                    ];
                    break;
            }

            // Actualizar UI
            updateUIFromState();
            updateRetainerDisplay();
            updateProjectsTable();
            updateReferralsTable();
            updateAllCalculations();
        }

        function updateUIFromState() {
            document.getElementById('retainer').value = state.retainer;
            document.getElementById('retainerValue').textContent = `$${state.retainer.toLocaleString()} MXN/mes`;

            document.getElementById('ipSplit').value = state.ipSplit;
            document.getElementById('ipSplitValue').textContent = `${state.ipSplit}% / ${100 - state.ipSplit}%`;

            document.getElementById('duration').value = state.duration;

            document.getElementById('finderFee').value = state.finderFee;
            document.getElementById('finderFeeValue').textContent = `${state.finderFee}%`;

            document.getElementById('equityPercent').value = state.equityPercent;
            document.getElementById('equityPercentValue').textContent = `${state.equityPercent}%`;

            // Actualizar campos de equity
            document.getElementById('studioValuation').value = state.studioValuation;
            document.getElementById('studioFutureValue').value = state.studioFutureValue;
            document.getElementById('agencyValuation').value = state.agencyValuation;
            document.getElementById('agencyFutureValue').value = state.agencyFutureValue;
        }

        // ========== CALCULADORA DE BREAK-EVEN ==========

        function updateProjectsDisplay() {
            const projects = parseFloat(document.getElementById('beProjectsPerMonth').value);
            const display = document.getElementById('beProjectsDisplay');
            if (projects === 0) {
                display.textContent = 'Sin proyectos adicionales';
            } else if (projects === 1) {
                display.textContent = '1 proyecto/mes';
            } else {
                display.textContent = `${projects} proyectos/mes`;
            }
        }

        function calculateBreakeven() {
            const initialInvestment = parseFloat(document.getElementById('beInitialInvestment').value) || 0;
            const monthlyExpenses = parseFloat(document.getElementById('beMonthlyExpenses').value) || 0;
            const monthlyRetainer = parseFloat(document.getElementById('beMonthlyRetainer').value) || 0;
            const avgProjectIncome = parseFloat(document.getElementById('beAvgProjectIncome').value) || 0;
            const projectsPerMonth = parseFloat(document.getElementById('beProjectsPerMonth').value) || 0;

            // Ingreso mensual neto
            const monthlyProjectIncome = avgProjectIncome * projectsPerMonth;
            const totalMonthlyIncome = monthlyRetainer + monthlyProjectIncome;
            const monthlyNetIncome = totalMonthlyIncome - monthlyExpenses;

            // Elementos de resultado
            const monthsEl = document.getElementById('beMonthsToBreakeven');
            const projectsEl = document.getElementById('beProjectsToBreakeven');
            const revenueEl = document.getElementById('beRevenueNeeded');
            const progressBar = document.getElementById('beProgressBar');
            const marker = document.getElementById('beMarker');
            const endLabel = document.getElementById('beEndLabel');
            const insight = document.getElementById('beInsight');

            // Caso: Sin inversión inicial
            if (initialInvestment <= 0) {
                monthsEl.textContent = '0';
                projectsEl.textContent = '0';
                revenueEl.textContent = '$0';
                progressBar.style.width = '100%';
                progressBar.style.background = 'var(--accent-green)';
                marker.style.left = '0%';
                endLabel.textContent = 'Mes 12';
                insight.innerHTML = `
                    <strong>✅ Sin inversión inicial necesaria</strong><br>
                    Ya estás en punto de equilibrio desde el inicio. Tu ingreso neto mensual sería de
                    <strong>$${monthlyNetIncome.toLocaleString()} MXN</strong>.
                `;
                insight.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                return;
            }

            // Caso: Ingresos no cubren gastos
            if (monthlyNetIncome <= 0) {
                monthsEl.textContent = '∞';
                projectsEl.textContent = '∞';
                revenueEl.textContent = 'N/A';
                progressBar.style.width = '5%';
                progressBar.style.background = '#ef4444';
                marker.style.left = '100%';
                endLabel.textContent = 'Nunca';

                const deficit = Math.abs(monthlyNetIncome);
                insight.innerHTML = `
                    <strong>⚠️ Modelo no rentable</strong><br>
                    Tus gastos mensuales ($${monthlyExpenses.toLocaleString()}) superan tus ingresos
                    ($${totalMonthlyIncome.toLocaleString()}). Necesitas aumentar ingresos en
                    <strong>$${deficit.toLocaleString()} MXN/mes</strong> para alcanzar el break-even.
                `;
                insight.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                return;
            }

            // Cálculos de break-even
            const monthsToBreakeven = Math.ceil(initialInvestment / monthlyNetIncome);
            const totalRevenueNeeded = initialInvestment + (monthlyExpenses * monthsToBreakeven);

            // Proyectos para break-even (si solo dependieras de proyectos)
            let projectsToBreakeven;
            if (avgProjectIncome > 0) {
                projectsToBreakeven = Math.ceil(initialInvestment / avgProjectIncome);
            } else {
                projectsToBreakeven = '∞';
            }

            // Actualizar displays
            monthsEl.textContent = monthsToBreakeven;
            if (typeof projectsToBreakeven === 'number') {
                projectsEl.textContent = projectsToBreakeven;
            } else {
                projectsEl.textContent = projectsToBreakeven;
            }
            revenueEl.textContent = `$${totalRevenueNeeded.toLocaleString()}`;

            // Actualizar gráfico
            const maxMonths = Math.max(24, monthsToBreakeven * 1.5);
            const progressPercent = Math.min(100, (monthsToBreakeven / maxMonths) * 100);

            progressBar.style.width = `${progressPercent}%`;
            marker.style.left = `${progressPercent}%`;
            endLabel.textContent = `Mes ${Math.ceil(maxMonths)}`;

            // Color del progreso según velocidad de break-even
            if (monthsToBreakeven <= 3) {
                progressBar.style.background = 'var(--accent-green)';
            } else if (monthsToBreakeven <= 6) {
                progressBar.style.background = 'linear-gradient(90deg, var(--accent-green), var(--accent-gold))';
            } else if (monthsToBreakeven <= 12) {
                progressBar.style.background = 'var(--accent-gold)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, var(--accent-gold), #ef4444)';
            }

            // Generar insight
            const roi = ((totalMonthlyIncome * 12 - monthlyExpenses * 12 - initialInvestment) / initialInvestment * 100).toFixed(1);
            const profitAfterBreakeven = monthlyNetIncome * (12 - Math.min(monthsToBreakeven, 12));

            let insightText = '';
            let insightBg = '';

            if (monthsToBreakeven <= 3) {
                insightBg = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
                insightText = `
                    <strong>🚀 Excelente escenario!</strong><br>
                    Recuperarás tu inversión en solo <strong>${monthsToBreakeven} meses</strong>.
                    Después del break-even, generarás ~<strong>$${profitAfterBreakeven.toLocaleString()} MXN</strong>
                    de ganancia en el primer año. ROI anual estimado: <strong>${roi}%</strong>.
                `;
            } else if (monthsToBreakeven <= 6) {
                insightBg = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                insightText = `
                    <strong>👍 Buen escenario</strong><br>
                    Break-even en <strong>${monthsToBreakeven} meses</strong>. Tu ingreso neto mensual de
                    <strong>$${monthlyNetIncome.toLocaleString()} MXN</strong> es saludable.
                    Considera aumentar el retainer o proyectos para acelerar la recuperación.
                `;
            } else if (monthsToBreakeven <= 12) {
                insightBg = 'linear-gradient(135deg, #fef3c7, #fed7aa)';
                insightText = `
                    <strong>📊 Escenario moderado</strong><br>
                    Alcanzarás break-even en <strong>${monthsToBreakeven} meses</strong>.
                    Para mejorar: aumenta el retainer mensual, busca más proyectos, o reduce costos operativos
                    en <strong>$${Math.ceil(monthlyNetIncome * 0.5).toLocaleString()} MXN</strong>.
                `;
            } else {
                insightBg = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                insightText = `
                    <strong>⚠️ Recuperación lenta</strong><br>
                    <strong>${monthsToBreakeven} meses</strong> para break-even es considerable.
                    Recomendaciones: Negocia un retainer más alto (mínimo
                    $${Math.ceil(monthlyExpenses + initialInvestment/6).toLocaleString()}/mes),
                    o reduce la inversión inicial.
                `;
            }

            insight.innerHTML = insightText;
            insight.style.background = insightBg;
        }

        // ========== GESTIÓN DE CONFIGURACIONES EN LOCALSTORAGE ==========

        const STORAGE_KEY = 'alianza_dashboard_configs';

        function getStoredConfigs() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error('Error al leer localStorage:', e);
                return [];
            }
        }

        function setStoredConfigs(configs) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(configs));
                return true;
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
                alert('Error al guardar. Es posible que localStorage esté lleno.');
                return false;
            }
        }

        function saveConfigToStorage() {
            const nameInput = document.getElementById('configName');
            let name = nameInput.value.trim();

            if (!name) {
                name = `Configuración ${new Date().toLocaleDateString('es-MX')}`;
            }

            const config = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                state: JSON.parse(JSON.stringify(state)),
                projectsData: JSON.parse(JSON.stringify(projectsData)), // Nueva estructura multi-proyecto
                breakeven: {
                    initialInvestment: parseFloat(document.getElementById('beInitialInvestment').value) || 0,
                    monthlyExpenses: parseFloat(document.getElementById('beMonthlyExpenses').value) || 0,
                    avgProjectIncome: parseFloat(document.getElementById('beAvgProjectIncome').value) || 0,
                    projectsPerMonth: parseFloat(document.getElementById('beProjectsPerMonth').value) || 0
                }
            };

            const configs = getStoredConfigs();
            configs.unshift(config); // Agregar al inicio

            // Limitar a 10 configuraciones
            if (configs.length > 10) {
                configs.pop();
            }

            if (setStoredConfigs(configs)) {
                nameInput.value = '';
                renderSavedConfigsList();
                updateStorageInfo();
                alert(`✅ Configuración "${name}" guardada correctamente`);
            }
        }

        function loadConfigFromStorage(configId) {
            const configs = getStoredConfigs();
            const config = configs.find(c => c.id === configId);

            if (!config) {
                alert('No se encontró la configuración');
                return;
            }

            // Restaurar estado
            Object.assign(state, config.state);

            // Restaurar costos del proyecto - compatibilidad con formato antiguo y nuevo
            if (config.projectsData) {
                // Nuevo formato multi-proyecto
                Object.assign(projectsData, config.projectsData);
            } else if (config.projectCosts) {
                // Formato antiguo - migrar a nuevo formato
                projectsData.projects = [{
                    id: Date.now(),
                    name: 'Proyecto Principal',
                    value: 100000,
                    costs: JSON.parse(JSON.stringify(config.projectCosts))
                }];
                projectsData.currentProjectId = projectsData.projects[0].id;
            }

            // Renderizar selector de proyectos y categorías de costos
            renderProjectSelector();
            renderAllCostCategories();

            // Restaurar break-even si existe
            if (config.breakeven) {
                document.getElementById('beInitialInvestment').value = config.breakeven.initialInvestment;
                document.getElementById('beMonthlyExpenses').value = config.breakeven.monthlyExpenses;
                document.getElementById('beAvgProjectIncome').value = config.breakeven.avgProjectIncome;
                document.getElementById('beProjectsPerMonth').value = config.breakeven.projectsPerMonth;
                updateProjectsDisplay();
            }

            // Actualizar UI
            updateUIFromState();
            document.getElementById('vestingPeriod').value = state.vestingPeriod || 36;
            document.getElementById('cliffPeriod').value = state.cliffPeriod || 12;

            // Actualizar tipo de retainer
            if (state.retainerType === 'projects') {
                document.getElementById('toggleHours').classList.remove('active');
                document.getElementById('toggleProjects').classList.add('active');
            } else {
                document.getElementById('toggleHours').classList.add('active');
                document.getElementById('toggleProjects').classList.remove('active');
            }

            updateRetainerLabels();
            updateRetainerDisplay();
            updateProjectsTable();
            updateReferralsTable();
            updateAllCalculations();
            calculateBreakeven();
            calculateProfit();

            // Sincronizar retainer con break-even
            document.getElementById('beMonthlyRetainer').value = state.retainer;

            alert(`✅ Configuración "${config.name}" cargada`);
        }

        function deleteConfigFromStorage(configId) {
            if (!confirm('¿Estás seguro de que deseas eliminar esta configuración?')) {
                return;
            }

            const configs = getStoredConfigs();
            const newConfigs = configs.filter(c => c.id !== configId);
            setStoredConfigs(newConfigs);
            renderSavedConfigsList();
            updateStorageInfo();
        }

        function renderSavedConfigsList() {
            const container = document.getElementById('savedConfigsList');
            const configs = getStoredConfigs();

            if (configs.length === 0) {
                container.innerHTML = `
                    <div class="empty-storage">
                        <div class="icon">📁</div>
                        <div>No hay configuraciones guardadas</div>
                        <small>Guarda tu primera configuración usando el botón de arriba</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = configs.map(config => {
                const date = new Date(config.date);
                const dateStr = date.toLocaleDateString('es-MX', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="saved-config-item">
                        <div class="config-icon">💾</div>
                        <div class="config-info">
                            <div class="config-name">${config.name}</div>
                            <div class="config-date">${dateStr}</div>
                            <div class="config-preview">
                                <span>$${(config.state.retainer || 0).toLocaleString()}/mes</span>
                                <span>PI: ${config.state.ipSplit || 50}%</span>
                                <span>${config.state.duration || 24} meses</span>
                                <span>${(config.state.projects || []).length} proyectos</span>
                            </div>
                        </div>
                        <div class="config-actions">
                            <button class="btn-icon btn-load" onclick="loadConfigFromStorage(${config.id})" title="Cargar">
                                ▶️
                            </button>
                            <button class="btn-icon btn-delete" onclick="deleteConfigFromStorage(${config.id})" title="Eliminar">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStorageInfo() {
            const info = document.getElementById('storageInfo');
            const configs = getStoredConfigs();

            if (configs.length >= 8) {
                info.className = 'storage-info warning';
                info.innerHTML = `
                    <span>⚠️</span>
                    <span>Tienes ${configs.length}/10 configuraciones guardadas. Las más antiguas se eliminarán automáticamente.</span>
                `;
            } else {
                info.className = 'storage-info';
                info.innerHTML = `
                    <span>💡</span>
                    <span>Las configuraciones se guardan en localStorage de tu navegador (${configs.length}/10 usadas).</span>
                `;
            }
        }

        function exportAllConfigs() {
            const configs = getStoredConfigs();

            if (configs.length === 0) {
                alert('No hay configuraciones para exportar');
                return;
            }

            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                configs: configs
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alianza-dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfigs(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.configs || !Array.isArray(data.configs)) {
                        throw new Error('Formato de archivo inválido');
                    }

                    const existingConfigs = getStoredConfigs();
                    const existingIds = new Set(existingConfigs.map(c => c.id));

                    // Filtrar duplicados y agregar nuevas configs
                    let imported = 0;
                    data.configs.forEach(config => {
                        if (!existingIds.has(config.id)) {
                            existingConfigs.push(config);
                            imported++;
                        }
                    });

                    // Ordenar por fecha (más recientes primero)
                    existingConfigs.sort((a, b) => new Date(b.date) - new Date(a.date));

                    // Limitar a 10
                    while (existingConfigs.length > 10) {
                        existingConfigs.pop();
                    }

                    setStoredConfigs(existingConfigs);
                    renderSavedConfigsList();
                    updateStorageInfo();

                    alert(`✅ Importación completada. ${imported} configuraciones nuevas agregadas.`);
                } catch (err) {
                    alert('❌ Error al importar: ' + err.message);
                }
            };
            reader.readAsText(file);

            // Limpiar el input para permitir seleccionar el mismo archivo de nuevo
            event.target.value = '';
        }

        // ========== EXPORTACIÓN A PDF ==========

        function generatePDFContent() {
            const includeConfig = document.getElementById('pdfIncludeConfig').checked;
            const includeProjects = document.getElementById('pdfIncludeProjects').checked;
            const includeEquity = document.getElementById('pdfIncludeEquity').checked;
            const includeProjection = document.getElementById('pdfIncludeProjection').checked;
            const includeBreakeven = document.getElementById('pdfIncludeBreakeven').checked;
            const includeSummary = document.getElementById('pdfIncludeSummary').checked;

            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);
            const horasIncluidas = Math.floor(state.retainer / tarifaAjustada);

            // Calcular totales
            const retainerTotal = state.retainer * state.duration;

            // Calcular gastos totales
            const totalExpenses = getTotalExpenses();

            // IP Bruto y Neto
            const ipGross = state.projects
                .filter(p => p.type === 'cliente')
                .reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);
            const ipTotal = Math.max(0, ipGross - totalExpenses);

            const finderTotal = state.referrals
                .reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);
            const equityPct = state.equityPercent / 100;
            const equityValue = (state.agencyFutureValue - state.agencyValuation) * equityPct;
            const grandTotal = retainerTotal + ipTotal + finderTotal + equityValue;

            const today = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let html = `
                <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #374151;">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #1a2332 0%, #2563eb 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <h1 style="font-size: 24px; margin: 0 0 8px 0;">Propuesta de Alianza Estratégica</h1>
                        <p style="opacity: 0.9; margin: 0; font-size: 14px;">Estudio de Desarrollo de IA + Agencia de Creatividad</p>
                        <p style="margin-top: 15px; font-size: 12px; opacity: 0.8;">Documento generado el ${today}</p>
                    </div>
            `;

            // Resumen Ejecutivo
            if (includeSummary) {
                html += `
                    <div style="background: #f0fdf4; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; font-size: 16px;">📊 Resumen Ejecutivo</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #2563eb;">$${grandTotal.toLocaleString()}</div>
                                <div style="font-size: 12px; color: #6b7280;">Ingreso Total Proyectado</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #2563eb;">${state.duration}</div>
                                <div style="font-size: 12px; color: #6b7280;">Meses de Contrato</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #2563eb;">$${Math.round(grandTotal / state.duration).toLocaleString()}</div>
                                <div style="font-size: 12px; color: #6b7280;">Promedio Mensual</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Configuración Base
            if (includeConfig) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2563eb; font-size: 16px;">⚙️ Configuración del Acuerdo</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Iguala Mensual (Retainer)</td>
                                <td style="padding: 10px 0; text-align: right;">$${state.retainer.toLocaleString()} MXN/mes</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Horas Incluidas</td>
                                <td style="padding: 10px 0; text-align: right;">${horasIncluidas} hrs/mes @ $${tarifaAjustada.toFixed(0)}/hr</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">División de Propiedad Intelectual</td>
                                <td style="padding: 10px 0; text-align: right;">${state.ipSplit}% Estudio / ${100 - state.ipSplit}% Agencia</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Duración del Contrato</td>
                                <td style="padding: 10px 0; text-align: right;">${state.duration} meses</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Finder's Fee</td>
                                <td style="padding: 10px 0; text-align: right;">${state.finderFee}%</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px 0; font-weight: 600; color: #2563eb;">Total Retainer (${state.duration} meses)</td>
                                <td style="padding: 10px 0; text-align: right; font-weight: 700; color: #2563eb;">$${retainerTotal.toLocaleString()} MXN</td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // Proyectos Simulados
            if (includeProjects && state.projects.length > 0) {
                const clienteProjects = state.projects.filter(p => p.type === 'cliente');
                const internoProjects = state.projects.filter(p => p.type === 'interno');

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2563eb; font-size: 16px;">📁 Proyectos Simulados</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 10px; text-align: left; font-weight: 600;">Proyecto</th>
                                    <th style="padding: 10px; text-align: center;">Tipo</th>
                                    <th style="padding: 10px; text-align: right;">Valor Total</th>
                                    <th style="padding: 10px; text-align: right;">Tu Parte (${state.ipSplit}%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${state.projects.map(p => `
                                    <tr style="border-bottom: 1px solid #e5e7eb;">
                                        <td style="padding: 10px;">${p.name}</td>
                                        <td style="padding: 10px; text-align: center;">${p.type === 'cliente' ? '🏢 Cliente' : '🔧 Interno'}</td>
                                        <td style="padding: 10px; text-align: right;">$${p.value.toLocaleString()}</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600;">$${Math.round(p.value * state.ipSplit / 100).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: #eff6ff;">
                                    <td colspan="3" style="padding: 10px; font-weight: 600;">Total Ingresos por PI</td>
                                    <td style="padding: 10px; text-align: right; font-weight: 700; color: #2563eb;">$${ipTotal.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            // Equity
            if (includeEquity) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2563eb; font-size: 16px;">📈 Participación Accionaria (Stock Options)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Porcentaje de Opciones</td>
                                <td style="padding: 10px 0; text-align: right;">${state.equityPercent}%</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Periodo de Vesting</td>
                                <td style="padding: 10px 0; text-align: right;">${state.vestingPeriod} meses</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0; font-weight: 600;">Periodo de Cliff</td>
                                <td style="padding: 10px 0; text-align: right;">${state.cliffPeriod} meses</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0;">Valuación actual de la Agencia</td>
                                <td style="padding: 10px 0; text-align: right;">$${state.agencyValuation.toLocaleString()}</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 10px 0;">Valuación proyectada</td>
                                <td style="padding: 10px 0; text-align: right;">$${state.agencyFutureValue.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px 0; font-weight: 600; color: #10b981;">Ganancia Potencial por Equity</td>
                                <td style="padding: 10px 0; text-align: right; font-weight: 700; color: #10b981;">$${equityValue.toLocaleString()}</td>
                            </tr>
                        </table>
                    </div>
                `;
            }

            // Break-even
            if (includeBreakeven) {
                const beMonths = document.getElementById('beMonthsToBreakeven').textContent;
                const beProjects = document.getElementById('beProjectsToBreakeven').textContent;
                const beRevenue = document.getElementById('beRevenueNeeded').textContent;

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2563eb; font-size: 16px;">⚖️ Análisis de Break-Even</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${beMonths}</div>
                                <div style="font-size: 12px; color: #6b7280;">Meses para Break-Even</div>
                            </div>
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${beProjects}</div>
                                <div style="font-size: 12px; color: #6b7280;">Proyectos para Break-Even</div>
                            </div>
                            <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                                <div style="font-size: 28px; font-weight: 700; color: #f59e0b;">${beRevenue}</div>
                                <div style="font-size: 12px; color: #6b7280;">Ingresos Necesarios</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Proyección (tabla simplificada)
            if (includeProjection) {
                const monthlyRetainer = state.retainer;
                const monthlyAvgIP = ipTotal / state.duration;
                const monthlyAvgFinder = finderTotal / state.duration;

                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <h3 style="color: #1a2332; margin: 0 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #2563eb; font-size: 16px;">📅 Proyección de Ingresos</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 10px; text-align: left;">Concepto</th>
                                    <th style="padding: 10px; text-align: right;">Mensual</th>
                                    <th style="padding: 10px; text-align: right;">Total (${state.duration} meses)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">💰 Retainer</td>
                                    <td style="padding: 10px; text-align: right;">$${monthlyRetainer.toLocaleString()}</td>
                                    <td style="padding: 10px; text-align: right;">$${retainerTotal.toLocaleString()}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">📜 Propiedad Intelectual</td>
                                    <td style="padding: 10px; text-align: right;">~$${Math.round(monthlyAvgIP).toLocaleString()}</td>
                                    <td style="padding: 10px; text-align: right;">$${ipTotal.toLocaleString()}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">🤝 Finder's Fee</td>
                                    <td style="padding: 10px; text-align: right;">~$${Math.round(monthlyAvgFinder).toLocaleString()}</td>
                                    <td style="padding: 10px; text-align: right;">$${finderTotal.toLocaleString()}</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 10px;">📈 Equity (al vender)</td>
                                    <td style="padding: 10px; text-align: right; color: #6b7280;">-</td>
                                    <td style="padding: 10px; text-align: right;">$${equityValue.toLocaleString()}</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr style="background: linear-gradient(135deg, #eff6ff, #dbeafe);">
                                    <td style="padding: 12px; font-weight: 700; font-size: 14px;">TOTAL</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700;">$${Math.round(grandTotal / state.duration).toLocaleString()}/mes</td>
                                    <td style="padding: 12px; text-align: right; font-weight: 700; font-size: 16px; color: #2563eb;">$${grandTotal.toLocaleString()}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            // Footer
            html += `
                <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px; border-top: 1px solid #e5e7eb; margin-top: 20px;">
                    <p>Este documento es una simulación financiera y no constituye un contrato vinculante.</p>
                    <p style="margin-top: 5px;">Generado con Dashboard de Alianza Estratégica • ${today}</p>
                </div>
            </div>
            `;

            return html;
        }

        async function exportToPDF() {
            const progress = document.getElementById('exportProgress');
            progress.classList.add('active');

            try {
                // Crear contenedor temporal visible para html2canvas
                const container = document.createElement('div');
                container.innerHTML = generatePDFContent();
                container.style.position = 'fixed';
                container.style.left = '0';
                container.style.top = '0';
                container.style.width = '800px';
                container.style.background = 'white';
                container.style.zIndex = '-1';
                container.style.opacity = '0';
                container.style.pointerEvents = 'none';
                document.body.appendChild(container);

                // Esperar a que el DOM se actualice
                await new Promise(resolve => setTimeout(resolve, 100));

                // Configuración de html2pdf
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: `propuesta-alianza-${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        windowWidth: 800
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Generar PDF
                await html2pdf().set(opt).from(container).save();

                // Limpiar
                document.body.removeChild(container);

            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF. Por favor intenta de nuevo.');
            } finally {
                progress.classList.remove('active');
            }
        }

        // ========== INDICADORES DE SALUD DEL DEAL ==========

        const healthMetrics = [
            { id: 'balance', name: 'Balance de Beneficios', weight: 20 },
            { id: 'sustainability', name: 'Sostenibilidad', weight: 20 },
            { id: 'fairness', name: 'Equidad de Términos', weight: 15 },
            { id: 'growth', name: 'Potencial de Crecimiento', weight: 15 },
            { id: 'risk', name: 'Nivel de Riesgo', weight: 15 },
            { id: 'flexibility', name: 'Flexibilidad', weight: 15 }
        ];

        function calculateDealHealth() {
            const scores = {};

            // 1. Balance de beneficios (¿ambas partes ganan?)
            const ipBalance = 100 - Math.abs(state.ipSplit - 50) * 2;
            const retainerFair = Math.min(100, (state.retainer / 25000) * 100);
            scores.balance = (ipBalance * 0.6 + retainerFair * 0.4);

            // 2. Sostenibilidad (¿es viable a largo plazo?)
            const durationScore = state.duration >= 24 ? 100 : state.duration >= 12 ? 70 : 40;
            const retainerSustain = state.retainer >= 20000 ? 100 : state.retainer >= 15000 ? 70 : 40;
            scores.sustainability = (durationScore * 0.5 + retainerSustain * 0.5);

            // 3. Equidad de términos
            const finderFair = state.finderFee >= 8 && state.finderFee <= 15 ? 100 :
                               state.finderFee >= 5 && state.finderFee <= 20 ? 70 : 40;
            const equityFair = state.equityPercent >= 1 && state.equityPercent <= 5 ? 100 :
                               state.equityPercent >= 0.5 && state.equityPercent <= 8 ? 70 : 50;
            scores.fairness = (finderFair * 0.5 + equityFair * 0.5);

            // 4. Potencial de crecimiento
            const ipGrowth = state.ipSplit >= 40 ? 100 : state.ipSplit >= 25 ? 70 : 40;
            const projectsCount = state.projects.length;
            const projectsScore = projectsCount >= 3 ? 100 : projectsCount >= 1 ? 70 : 40;
            scores.growth = (ipGrowth * 0.6 + projectsScore * 0.4);

            // 5. Nivel de riesgo (inverso - menos riesgo = mejor)
            const riskFromDuration = state.duration >= 24 ? 90 : state.duration >= 12 ? 70 : 50;
            const riskFromRetainer = state.retainer >= 25000 ? 90 : state.retainer >= 15000 ? 70 : 50;
            const vestingRisk = state.cliffPeriod <= 12 ? 90 : 70;
            scores.risk = (riskFromDuration * 0.4 + riskFromRetainer * 0.4 + vestingRisk * 0.2);

            // 6. Flexibilidad
            const vestingFlex = state.vestingPeriod <= 36 ? 90 : 60;
            const typeFlex = 80; // Ambos tipos (horas/proyectos) disponibles
            scores.flexibility = (vestingFlex * 0.5 + typeFlex * 0.5);

            // Calcular score total ponderado
            let totalScore = 0;
            healthMetrics.forEach(metric => {
                totalScore += (scores[metric.id] || 0) * (metric.weight / 100);
            });

            return { scores, totalScore: Math.round(totalScore) };
        }

        function getDealVerdict(score) {
            if (score >= 85) return { text: 'Excelente Acuerdo', class: 'excellent', sublabel: 'Muy equilibrado y beneficioso' };
            if (score >= 70) return { text: 'Buen Acuerdo', class: 'good', sublabel: 'Equilibrado y sostenible' };
            if (score >= 50) return { text: 'Acuerdo Regular', class: 'fair', sublabel: 'Algunos aspectos a mejorar' };
            return { text: 'Acuerdo Débil', class: 'poor', sublabel: 'Necesita renegociación' };
        }

        function getPerspectives(scores, totalScore) {
            const studioScore = Math.round(
                scores.sustainability * 0.3 +
                scores.growth * 0.3 +
                scores.risk * 0.2 +
                (state.ipSplit * 0.2)
            );

            const agencyScore = Math.round(
                scores.balance * 0.3 +
                scores.fairness * 0.3 +
                scores.flexibility * 0.2 +
                ((100 - state.ipSplit) * 0.2)
            );

            return { studioScore, agencyScore };
        }

        function getRecommendations(scores, totalScore) {
            const recommendations = [];

            if (scores.balance < 70) {
                recommendations.push({
                    icon: '⚖️',
                    text: 'Considera ajustar el split de PI hacia 50/50 para mayor equilibrio.',
                    priority: 'high'
                });
            }

            if (scores.sustainability < 70) {
                recommendations.push({
                    icon: '📈',
                    text: state.duration < 24
                        ? 'Un contrato de 24+ meses daría más estabilidad.'
                        : 'Aumentar el retainer mejoraría la sostenibilidad.',
                    priority: 'medium'
                });
            }

            if (scores.growth < 70) {
                recommendations.push({
                    icon: '🚀',
                    text: 'Agrega más proyectos potenciales para mejorar las proyecciones de crecimiento.',
                    priority: 'medium'
                });
            }

            if (scores.risk < 70) {
                recommendations.push({
                    icon: '🛡️',
                    text: 'Considera cláusulas de protección adicionales o un cliff más corto.',
                    priority: 'low'
                });
            }

            if (totalScore >= 80 && recommendations.length === 0) {
                recommendations.push({
                    icon: '✅',
                    text: '¡El acuerdo está bien balanceado! Revisa los detalles finales antes de firmar.',
                    priority: 'success'
                });
            }

            return recommendations;
        }

        function renderDealHealth() {
            const { scores, totalScore } = calculateDealHealth();
            const verdict = getDealVerdict(totalScore);
            const perspectives = getPerspectives(scores, totalScore);
            const recommendations = getRecommendations(scores, totalScore);

            // Actualizar círculo de score
            const circle = document.getElementById('healthScoreCircle');
            const scoreNumber = document.getElementById('healthScoreNumber');
            const verdictEl = document.getElementById('healthVerdict');
            const sublabelEl = document.getElementById('healthSublabel');

            if (circle) {
                circle.style.setProperty('--score', totalScore);
                circle.className = `health-score-circle ${verdict.class}`;
            }
            if (scoreNumber) scoreNumber.textContent = totalScore;
            if (verdictEl) {
                verdictEl.textContent = verdict.text;
                verdictEl.className = `health-score-verdict ${verdict.class}`;
            }
            if (sublabelEl) sublabelEl.textContent = verdict.sublabel;

            // Renderizar métricas individuales
            const metricsContainer = document.getElementById('healthMetrics');
            if (metricsContainer) {
                metricsContainer.innerHTML = healthMetrics.map(metric => {
                    const score = Math.round(scores[metric.id] || 0);
                    const colorClass = score >= 80 ? 'excellent' : score >= 60 ? 'good' : score >= 40 ? 'fair' : 'poor';
                    return `
                        <div class="health-metric-row">
                            <div class="metric-info">
                                <span class="metric-name">${metric.name}</span>
                                <span class="metric-weight">(${metric.weight}%)</span>
                            </div>
                            <div class="metric-bar-container">
                                <div class="metric-bar ${colorClass}" style="width: ${score}%"></div>
                            </div>
                            <span class="metric-score ${colorClass}">${score}</span>
                        </div>
                    `;
                }).join('');
            }

            // Renderizar perspectivas
            const perspectivesContainer = document.getElementById('healthPerspectives');
            if (perspectivesContainer) {
                const studioVerdict = getDealVerdict(perspectives.studioScore);
                const agencyVerdict = getDealVerdict(perspectives.agencyScore);

                perspectivesContainer.innerHTML = `
                    <div class="perspective-card studio">
                        <div class="perspective-header">
                            <span class="perspective-icon">🎨</span>
                            <span class="perspective-title">Para el Estudio de AI</span>
                        </div>
                        <div class="perspective-score ${studioVerdict.class}">${perspectives.studioScore}/100</div>
                        <div class="perspective-points">
                            <div class="point ${state.ipSplit >= 40 ? 'positive' : 'negative'}">
                                ${state.ipSplit >= 40 ? '✓' : '!'} ${state.ipSplit}% de participación en PI
                            </div>
                            <div class="point ${state.retainer >= 20000 ? 'positive' : 'negative'}">
                                ${state.retainer >= 20000 ? '✓' : '!'} Retainer de $${state.retainer.toLocaleString()}/mes
                            </div>
                            <div class="point ${state.duration >= 24 ? 'positive' : 'neutral'}">
                                ${state.duration >= 24 ? '✓' : '○'} Contrato de ${state.duration} meses
                            </div>
                        </div>
                    </div>
                    <div class="perspective-card agency">
                        <div class="perspective-header">
                            <span class="perspective-icon">🏢</span>
                            <span class="perspective-title">Para la Agencia Creativa</span>
                        </div>
                        <div class="perspective-score ${agencyVerdict.class}">${perspectives.agencyScore}/100</div>
                        <div class="perspective-points">
                            <div class="point ${state.ipSplit <= 60 ? 'positive' : 'negative'}">
                                ${state.ipSplit <= 60 ? '✓' : '!'} ${100 - state.ipSplit}% de participación en PI
                            </div>
                            <div class="point ${state.finderFee <= 15 ? 'positive' : 'neutral'}">
                                ${state.finderFee <= 15 ? '✓' : '○'} ${state.finderFee}% de finder's fee
                            </div>
                            <div class="point ${state.equityPercent <= 5 ? 'positive' : 'neutral'}">
                                ${state.equityPercent <= 5 ? '✓' : '○'} ${state.equityPercent}% de equity
                            </div>
                        </div>
                    </div>
                `;
            }

            // Renderizar recomendaciones
            const recommendationContainer = document.getElementById('recommendationContent');
            if (recommendationContainer) {
                recommendationContainer.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-item ${rec.priority}">
                        <span class="rec-icon">${rec.icon}</span>
                        <span class="rec-text">${rec.text}</span>
                    </div>
                `).join('');
            }
        }

        function initDealHealth() {
            renderDealHealth();
        }

        // ========== ALERTAS INTELIGENTES ==========

        let currentAlerts = [];
        let alertsPanelVisible = false;
        let dismissedAlerts = new Set();

        function initAlerts() {
            // Cargar alertas descartadas
            const saved = localStorage.getItem('dismissed_alerts');
            if (saved) {
                dismissedAlerts = new Set(JSON.parse(saved));
            }
            checkAlerts();
        }

        function saveDismissedAlerts() {
            localStorage.setItem('dismissed_alerts', JSON.stringify([...dismissedAlerts]));
        }

        function checkAlerts() {
            currentAlerts = [];

            // 1. Alerta: Retainer muy bajo
            if (state.retainer < 15000) {
                currentAlerts.push({
                    id: 'low_retainer',
                    type: 'warning',
                    icon: '💰',
                    title: 'Retainer bajo',
                    message: `$${state.retainer.toLocaleString()}/mes puede ser insuficiente para cubrir costos. Considera negociar al menos $15,000-20,000 MXN.`
                });
            }

            // 2. Alerta: PI muy desbalanceada
            if (state.ipSplit < 30) {
                currentAlerts.push({
                    id: 'low_ip',
                    type: 'warning',
                    icon: '📜',
                    title: 'Baja participación en PI',
                    message: `Con solo ${state.ipSplit}% de PI, podrías perder valor significativo en proyectos exitosos. La tarifa actual lo compensa parcialmente.`
                });
            } else if (state.ipSplit > 70) {
                currentAlerts.push({
                    id: 'high_ip',
                    type: 'info',
                    icon: '📜',
                    title: 'Alta participación en PI',
                    message: `${state.ipSplit}% de PI es ventajoso, pero verifica que la tarifa reducida ($${calcularTarifaAjustada(state.ipSplit).toFixed(0)}/hr) sea sostenible.`
                });
            }

            // 3. Alerta: Contrato muy corto
            if (state.duration < 12) {
                currentAlerts.push({
                    id: 'short_contract',
                    type: 'warning',
                    icon: '📅',
                    title: 'Contrato corto',
                    message: `${state.duration} meses puede ser insuficiente para desarrollar una alianza sólida. Considera al menos 12-24 meses.`
                });
            }

            // 4. Alerta: Sin proyectos simulados
            if (state.projects.length === 0) {
                currentAlerts.push({
                    id: 'no_projects',
                    type: 'info',
                    icon: '📁',
                    title: 'Sin proyectos simulados',
                    message: 'Agrega proyectos de ejemplo para ver proyecciones más realistas de ingresos por PI.'
                });
            }

            // 5. Alerta: Finder's fee muy alto o bajo
            if (state.finderFee > 12) {
                currentAlerts.push({
                    id: 'high_finder',
                    type: 'info',
                    icon: '🤝',
                    title: "Finder's fee alto",
                    message: `${state.finderFee}% es generoso. El estándar del mercado es 5-10%. Asegúrate de que sea sostenible.`
                });
            } else if (state.finderFee < 5) {
                currentAlerts.push({
                    id: 'low_finder',
                    type: 'info',
                    icon: '🤝',
                    title: "Finder's fee bajo",
                    message: `${state.finderFee}% podría no incentivar suficientes referidos. Considera al menos 5-10%.`
                });
            }

            // 6. Alerta: Equity alto sin vesting largo
            if (state.equityPercent > 5 && state.vestingPeriod < 36) {
                currentAlerts.push({
                    id: 'equity_vesting',
                    type: 'warning',
                    icon: '📈',
                    title: 'Equity alto con vesting corto',
                    message: `${state.equityPercent}% de equity con solo ${state.vestingPeriod} meses de vesting podría no alinear incentivos a largo plazo.`
                });
            }

            // 7. Alerta: Valuación futura muy optimista
            const agencyGrowth = ((state.agencyFutureValue / state.agencyValuation) - 1) * 100;
            if (agencyGrowth > 400) {
                currentAlerts.push({
                    id: 'optimistic_valuation',
                    type: 'warning',
                    icon: '🎯',
                    title: 'Proyección muy optimista',
                    message: `Proyectas ${agencyGrowth.toFixed(0)}% de crecimiento en valuación. Considera escenarios más conservadores.`
                });
            }

            // 8. Alerta: Sin cliff en vesting
            if (state.cliffPeriod < 6 && state.equityPercent > 2) {
                currentAlerts.push({
                    id: 'no_cliff',
                    type: 'info',
                    icon: '⏰',
                    title: 'Cliff period corto',
                    message: `Un cliff de ${state.cliffPeriod} meses es corto. Considera 12 meses para proteger ambas partes.`
                });
            }

            // 9. Alerta: Retainer no cubre horas mínimas
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);
            const horasIncluidas = Math.floor(state.retainer / tarifaAjustada);
            if (horasIncluidas < 20) {
                currentAlerts.push({
                    id: 'few_hours',
                    type: 'warning',
                    icon: '⏱️',
                    title: 'Pocas horas incluidas',
                    message: `Solo ${horasIncluidas} hrs/mes incluidas. Considera si es suficiente para mantener la alianza activa.`
                });
            }

            // 10. Alerta: Muchos proyectos para el tiempo
            if (state.projects.length > 5 && state.duration <= 12) {
                currentAlerts.push({
                    id: 'many_projects',
                    type: 'info',
                    icon: '📊',
                    title: 'Muchos proyectos simulados',
                    message: `${state.projects.length} proyectos en ${state.duration} meses es ambicioso. Verifica la capacidad real.`
                });
            }

            // 11. Alerta positiva: Configuración balanceada
            if (state.retainer >= 25000 && state.ipSplit >= 40 && state.ipSplit <= 60 &&
                state.duration >= 24 && state.projects.length > 0) {
                currentAlerts.push({
                    id: 'balanced_config',
                    type: 'success',
                    icon: '✅',
                    title: 'Configuración equilibrada',
                    message: 'Tu propuesta tiene un buen balance entre ingresos fijos, participación en PI y duración.'
                });
            }

            // Filtrar alertas descartadas
            currentAlerts = currentAlerts.filter(alert => !dismissedAlerts.has(alert.id));

            renderAlerts();
            updateAlertsBadge();
        }

        function renderAlerts() {
            const container = document.getElementById('alertsPanelBody');

            if (currentAlerts.length === 0) {
                container.innerHTML = `
                    <div class="no-alerts-message">
                        <div class="icon">✅</div>
                        <div>¡Todo en orden!</div>
                        <small>No hay alertas pendientes</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentAlerts.map(alert => `
                <div class="alert-item ${alert.type}">
                    <button class="alert-close" onclick="dismissAlert('${alert.id}')">&times;</button>
                    <div class="alert-header">
                        <span class="alert-icon">${alert.icon}</span>
                        <div class="alert-content">
                            <div class="alert-title">${alert.title}</div>
                            <div class="alert-message">${alert.message}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateAlertsBadge() {
            const badge = document.getElementById('alertsBadge');
            const toggle = document.getElementById('alertsToggle');
            const count = currentAlerts.length;

            badge.textContent = count;

            if (count === 0) {
                toggle.classList.add('no-alerts');
                badge.textContent = '✓';
            } else {
                toggle.classList.remove('no-alerts');
            }
        }

        function toggleAlertsPanel() {
            alertsPanelVisible = !alertsPanelVisible;
            const panel = document.getElementById('alertsPanel');
            panel.classList.toggle('visible', alertsPanelVisible);
        }

        function dismissAlert(alertId) {
            dismissedAlerts.add(alertId);
            saveDismissedAlerts();
            checkAlerts();
        }

        function resetDismissedAlerts() {
            dismissedAlerts.clear();
            localStorage.removeItem('dismissed_alerts');
            checkAlerts();
        }

        // ========== ANÁLISIS DE RIESGOS ==========

        const allianceRisks = [
            {
                id: 'payment_default',
                category: 'financial',
                title: 'Incumplimiento de pagos',
                icon: '💸',
                defaultLevel: 'medium',
                description: 'La otra parte podría retrasarse o incumplir con los pagos acordados del retainer o proyectos.',
                mitigation: 'Incluir cláusula de pagos adelantados, intereses moratorios, y derecho a suspender trabajo. Considerar pagos parciales al inicio de cada proyecto.'
            },
            {
                id: 'scope_creep',
                category: 'operational',
                title: 'Expansión del alcance sin compensación',
                icon: '📈',
                defaultLevel: 'high',
                description: 'Los proyectos podrían expandirse más allá de lo acordado sin ajuste en la compensación.',
                mitigation: 'Definir claramente el alcance en cada proyecto. Establecer proceso formal de change requests con costos asociados. Documentar todo por escrito.'
            },
            {
                id: 'ip_dispute',
                category: 'legal',
                title: 'Disputas de propiedad intelectual',
                icon: '⚖️',
                defaultLevel: 'medium',
                description: 'Podría haber desacuerdos sobre quién posee qué parte de los desarrollos o cómo se comercializan.',
                mitigation: 'Documentar claramente la división de PI antes de cada proyecto. Registrar la PI importante. Incluir cláusula de arbitraje para disputas.'
            },
            {
                id: 'dependency',
                category: 'strategic',
                title: 'Dependencia excesiva de la alianza',
                icon: '🔗',
                defaultLevel: 'medium',
                description: 'Tu negocio podría volverse demasiado dependiente de esta alianza, perdiendo otros clientes u oportunidades.',
                mitigation: 'Mantener diversificación de clientes. Limitar a máximo 40-50% de ingresos de la alianza. Preservar capacidad de trabajo independiente.'
            },
            {
                id: 'quality_issues',
                category: 'operational',
                title: 'Diferencias en estándares de calidad',
                icon: '📊',
                defaultLevel: 'low',
                description: 'Las expectativas de calidad podrían no estar alineadas, causando fricciones o retrabajo.',
                mitigation: 'Establecer estándares de calidad documentados desde el inicio. Definir proceso de revisión y aprobación. Incluir periodo de prueba.'
            },
            {
                id: 'communication_breakdown',
                category: 'operational',
                title: 'Fallas de comunicación',
                icon: '📵',
                defaultLevel: 'medium',
                description: 'La falta de comunicación efectiva podría causar malentendidos, retrasos o conflictos.',
                mitigation: 'Establecer canales claros de comunicación. Reuniones regulares de seguimiento. Documentar decisiones importantes por escrito.'
            },
            {
                id: 'key_person_risk',
                category: 'operational',
                title: 'Riesgo de persona clave',
                icon: '👤',
                defaultLevel: 'medium',
                description: 'La alianza podría depender demasiado de personas específicas que podrían irse o no estar disponibles.',
                mitigation: 'Documentar procesos y conocimiento. Involucrar múltiples personas en la relación. Planificar transiciones con anticipación.'
            },
            {
                id: 'market_change',
                category: 'strategic',
                title: 'Cambios en el mercado',
                icon: '🌊',
                defaultLevel: 'low',
                description: 'El mercado de IA/creatividad podría cambiar, haciendo la alianza menos relevante o rentable.',
                mitigation: 'Mantener flexibilidad en los términos. Revisiones periódicas del acuerdo. Cláusula de ajuste por condiciones de mercado.'
            },
            {
                id: 'confidentiality_breach',
                category: 'legal',
                title: 'Filtración de información confidencial',
                icon: '🔓',
                defaultLevel: 'low',
                description: 'Información sensible de tu negocio o clientes podría filtrarse a través de la otra parte.',
                mitigation: 'NDA robusto con penalizaciones. Limitar acceso a información sensible. Protocolos claros de manejo de datos de clientes.'
            },
            {
                id: 'termination_messy',
                category: 'legal',
                title: 'Terminación conflictiva',
                icon: '💔',
                defaultLevel: 'medium',
                description: 'Si la alianza termina mal, podría haber conflictos sobre proyectos en curso, PI, o competencia.',
                mitigation: 'Cláusulas claras de terminación y transición. Definir qué pasa con proyectos en curso. Periodo de no competencia razonable.'
            },
            {
                id: 'reputation_risk',
                category: 'strategic',
                title: 'Riesgo reputacional',
                icon: '📢',
                defaultLevel: 'low',
                description: 'Problemas de la otra parte podrían afectar tu reputación si están asociados públicamente.',
                mitigation: 'Due diligence antes de formalizar. Cláusula de daño reputacional. Derecho a terminar si hay problemas graves de reputación.'
            },
            {
                id: 'equity_dilution',
                category: 'financial',
                title: 'Dilución o pérdida de equity',
                icon: '📉',
                defaultLevel: 'low',
                description: 'Las stock options podrían perder valor por dilución, o la otra empresa podría no llegar a venderse.',
                mitigation: 'Cláusulas anti-dilución. No depender del equity como ingreso principal. Entender escenarios de salida antes de aceptar opciones.'
            }
        ];

        let riskAssessments = {};

        function initRisks() {
            // Cargar evaluaciones guardadas o usar defaults
            const saved = localStorage.getItem('risk_assessments');
            if (saved) {
                riskAssessments = JSON.parse(saved);
            } else {
                allianceRisks.forEach(risk => {
                    riskAssessments[risk.id] = risk.defaultLevel;
                });
            }
            renderRisks();
        }

        function saveRiskAssessments() {
            localStorage.setItem('risk_assessments', JSON.stringify(riskAssessments));
        }

        function renderRisks() {
            const container = document.getElementById('riskMatrix');

            container.innerHTML = allianceRisks.map(risk => {
                const level = riskAssessments[risk.id] || risk.defaultLevel;
                const levelLabels = {
                    low: 'Bajo',
                    medium: 'Medio',
                    high: 'Alto'
                };

                return `
                    <div class="risk-card ${level}">
                        <div class="risk-card-header">
                            <div class="risk-card-title">
                                <span>${risk.icon}</span>
                                <span>${risk.title}</span>
                            </div>
                            <span class="risk-level ${level}">${levelLabels[level]}</span>
                        </div>
                        <div class="risk-description">${risk.description}</div>
                        <div class="risk-mitigation">
                            <div class="risk-mitigation-title">
                                <span>🛡️</span>
                                <span>Mitigación sugerida</span>
                            </div>
                            <div class="risk-mitigation-text">${risk.mitigation}</div>
                        </div>
                        <div class="risk-assessment">
                            <label>Tu evaluación:</label>
                            <select onchange="updateRiskLevel('${risk.id}', this.value)">
                                <option value="low" ${level === 'low' ? 'selected' : ''}>🟢 Bajo</option>
                                <option value="medium" ${level === 'medium' ? 'selected' : ''}>🟡 Medio</option>
                                <option value="high" ${level === 'high' ? 'selected' : ''}>🔴 Alto</option>
                            </select>
                        </div>
                    </div>
                `;
            }).join('');

            updateRisksSummary();
        }

        function updateRiskLevel(riskId, level) {
            riskAssessments[riskId] = level;
            saveRiskAssessments();
            renderRisks();
        }

        function updateRisksSummary() {
            const stats = { high: 0, medium: 0, low: 0 };

            allianceRisks.forEach(risk => {
                const level = riskAssessments[risk.id] || risk.defaultLevel;
                stats[level]++;
            });

            const statsContainer = document.getElementById('risksStats');
            statsContainer.innerHTML = `
                <div class="risk-stat">
                    <div class="risk-stat-dot high"></div>
                    <span><strong>${stats.high}</strong> riesgos altos</span>
                </div>
                <div class="risk-stat">
                    <div class="risk-stat-dot medium"></div>
                    <span><strong>${stats.medium}</strong> riesgos medios</span>
                </div>
                <div class="risk-stat">
                    <div class="risk-stat-dot low"></div>
                    <span><strong>${stats.low}</strong> riesgos bajos</span>
                </div>
            `;

            // Calcular nivel general
            const overallContainer = document.getElementById('riskOverall');
            let overallLevel, overallText;

            // Ponderación: alto=3, medio=2, bajo=1
            const score = (stats.high * 3 + stats.medium * 2 + stats.low * 1) / allianceRisks.length;

            if (score >= 2.3 || stats.high >= 4) {
                overallLevel = 'high';
                overallText = '⚠️ RIESGO ALTO';
            } else if (score >= 1.7 || stats.high >= 2) {
                overallLevel = 'medium';
                overallText = '⚡ RIESGO MODERADO';
            } else {
                overallLevel = 'low';
                overallText = '✅ RIESGO BAJO';
            }

            overallContainer.className = `risk-overall ${overallLevel}`;
            overallContainer.innerHTML = `
                <div class="risk-overall-label">Nivel de Riesgo General</div>
                <div class="risk-overall-value">${overallText}</div>
                <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                    ${overallLevel === 'high' ? 'Considera revisar las mitigaciones y negociar términos más favorables.' :
                      overallLevel === 'medium' ? 'Nivel aceptable. Asegúrate de implementar las mitigaciones clave.' :
                      'Buen perfil de riesgo. Procede con las precauciones estándar.'}
                </div>
            `;
        }

        // ========== CHECKLIST DE NEGOCIACIÓN ==========

        const negotiationChecklist = [
            {
                id: 'pre_meeting',
                title: 'Preparación Pre-Reunión',
                icon: '📋',
                items: [
                    { id: 'research', text: 'Investigar a la otra parte (portfolio, clientes, cultura)', hint: '¿Qué proyectos han hecho? ¿Cuál es su reputación?' },
                    { id: 'goals', text: 'Definir tus objetivos mínimos y máximos', hint: 'Retainer mínimo, % PI ideal, deal breakers' },
                    { id: 'alternatives', text: 'Identificar tu BATNA (mejor alternativa si no hay acuerdo)', hint: '¿Qué harías si esta alianza no se concreta?' },
                    { id: 'materials', text: 'Preparar materiales de apoyo (portfolio, casos de éxito)', hint: 'Demuestra el valor que aportas' }
                ]
            },
            {
                id: 'financial',
                title: 'Términos Financieros',
                icon: '💰',
                items: [
                    { id: 'retainer_amount', text: 'Acordar monto del retainer mensual', hint: 'Tu propuesta: $' + state.retainer.toLocaleString() + ' MXN' },
                    { id: 'retainer_scope', text: 'Definir qué incluye el retainer (horas, entregables)', hint: '¿Horas fijas o por proyecto?' },
                    { id: 'extra_work', text: 'Acordar tarifa de trabajo adicional', hint: 'Típicamente 20-50% sobre tarifa base' },
                    { id: 'payment_terms', text: 'Definir términos de pago (fechas, métodos)', hint: '¿Mensual adelantado? ¿Por proyecto?' },
                    { id: 'late_payments', text: 'Acordar consecuencias por pagos atrasados', hint: 'Intereses moratorios, suspensión de trabajo' }
                ]
            },
            {
                id: 'ip_rights',
                title: 'Propiedad Intelectual',
                icon: '📜',
                items: [
                    { id: 'ip_split', text: 'Acordar división de PI en proyectos conjuntos', hint: 'Tu propuesta: ' + state.ipSplit + '% / ' + (100-state.ipSplit) + '%' },
                    { id: 'ip_client_work', text: 'Definir PI en trabajo para clientes', hint: '¿Quién retiene derechos de código/diseño base?' },
                    { id: 'ip_internal', text: 'Acordar PI en herramientas internas', hint: 'Herramientas desarrolladas para uso de la alianza' },
                    { id: 'ip_preexisting', text: 'Proteger PI preexistente de cada parte', hint: 'Lo que cada quien trae a la mesa' },
                    { id: 'ip_licensing', text: 'Definir cómo se licenciará/venderá la PI conjunta', hint: '¿Quién negocia? ¿Cómo se dividen ingresos?' }
                ]
            },
            {
                id: 'operations',
                title: 'Operación y Trabajo',
                icon: '⚙️',
                items: [
                    { id: 'communication', text: 'Establecer canales y frecuencia de comunicación', hint: 'Slack, reuniones semanales, reportes' },
                    { id: 'decision_making', text: 'Definir proceso de toma de decisiones', hint: '¿Quién aprueba qué? ¿Cómo se resuelven desacuerdos?' },
                    { id: 'quality_standards', text: 'Acordar estándares de calidad y entrega', hint: 'Documentación, testing, código limpio' },
                    { id: 'timeline', text: 'Definir expectativas de tiempos de respuesta', hint: 'SLAs para urgencias vs trabajo normal' },
                    { id: 'team_access', text: 'Acordar acceso a equipos y recursos', hint: '¿Contacto directo o a través de PM?' }
                ]
            },
            {
                id: 'referrals',
                title: 'Referidos y Nuevos Negocios',
                icon: '🤝',
                items: [
                    { id: 'finder_fee', text: "Acordar porcentaje de finder's fee", hint: 'Tu propuesta: ' + state.finderFee + '%' },
                    { id: 'referral_process', text: 'Definir proceso para referir clientes', hint: '¿Cómo se documenta? ¿Quién da seguimiento?' },
                    { id: 'referral_payment', text: 'Acordar cuándo y cómo se paga la comisión', hint: '¿Al cerrar el trato o al recibir pago?' },
                    { id: 'joint_sales', text: 'Definir estrategia de ventas conjuntas', hint: '¿Cómo se presentan como alianza?' }
                ]
            },
            {
                id: 'equity',
                title: 'Equity y Largo Plazo',
                icon: '📈',
                items: [
                    { id: 'equity_percent', text: 'Acordar porcentaje de stock options', hint: 'Tu propuesta: ' + state.equityPercent + '%' },
                    { id: 'vesting', text: 'Definir periodo de vesting y cliff', hint: state.vestingPeriod + ' meses con ' + state.cliffPeriod + ' meses de cliff' },
                    { id: 'valuation', text: 'Acordar valuación para ejercer opciones', hint: '¿Valuación fija o fórmula?' },
                    { id: 'exit_scenarios', text: 'Discutir escenarios de salida/venta', hint: '¿Qué pasa si se vende una de las empresas?' }
                ]
            },
            {
                id: 'legal',
                title: 'Legal y Protección',
                icon: '⚖️',
                items: [
                    { id: 'contract_review', text: 'Acordar quién redacta el contrato formal', hint: '¿Abogado de quién? ¿Costos compartidos?' },
                    { id: 'confidentiality', text: 'Firmar NDA si no existe', hint: 'Proteger información sensible desde ya' },
                    { id: 'dispute_resolution', text: 'Acordar mecanismo de resolución de disputas', hint: 'Mediación, arbitraje, jurisdicción' },
                    { id: 'termination', text: 'Definir condiciones de terminación', hint: 'Aviso previo, causales, consecuencias' },
                    { id: 'liability', text: 'Discutir limitaciones de responsabilidad', hint: 'Caps, exclusiones, seguros' }
                ]
            },
            {
                id: 'next_steps',
                title: 'Próximos Pasos',
                icon: '🚀',
                items: [
                    { id: 'summary', text: 'Resumir acuerdos alcanzados', hint: 'Documentar todo por escrito' },
                    { id: 'pending', text: 'Listar puntos pendientes', hint: '¿Qué falta por definir?' },
                    { id: 'timeline_next', text: 'Acordar timeline para siguientes pasos', hint: 'Fecha para contrato, inicio de operaciones' },
                    { id: 'pilot', text: 'Considerar proyecto piloto', hint: '¿Empezar con algo pequeño para probar?' },
                    { id: 'celebration', text: '¡Celebrar el acuerdo!', hint: 'Un café, una comida, iniciar con buen pie' }
                ]
            }
        ];

        let checklistState = {};

        function initChecklist() {
            // Cargar estado guardado o inicializar
            const saved = localStorage.getItem('negotiation_checklist');
            if (saved) {
                checklistState = JSON.parse(saved);
            } else {
                negotiationChecklist.forEach(group => {
                    group.items.forEach(item => {
                        checklistState[item.id] = { completed: false, note: '' };
                    });
                });
            }
            renderChecklist();
        }

        function saveChecklistState() {
            localStorage.setItem('negotiation_checklist', JSON.stringify(checklistState));
        }

        function renderChecklist() {
            const container = document.getElementById('checklistGroups');

            container.innerHTML = negotiationChecklist.map(group => {
                const completedInGroup = group.items.filter(item => checklistState[item.id]?.completed).length;
                const totalInGroup = group.items.length;

                return `
                    <div class="checklist-group ${completedInGroup === totalInGroup ? 'completed' : ''}" id="group-${group.id}">
                        <div class="checklist-group-header" onclick="toggleChecklistGroup('${group.id}')">
                            <div class="checklist-group-title">
                                <span class="icon">${group.icon}</span>
                                <span>${group.title}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span class="checklist-group-badge">${completedInGroup}/${totalInGroup}</span>
                                <span class="expand-icon">▼</span>
                            </div>
                        </div>
                        <div class="checklist-group-items">
                            ${group.items.map(item => {
                                const itemState = checklistState[item.id] || { completed: false, note: '' };
                                return `
                                    <div class="checklist-item ${itemState.completed ? 'completed' : ''}"
                                         onclick="toggleChecklistItem('${item.id}')">
                                        <div class="checklist-item-checkbox">✓</div>
                                        <div class="checklist-item-content">
                                            <div class="checklist-item-text">${item.text}</div>
                                            <div class="checklist-item-hint">${item.hint}</div>
                                            ${itemState.completed ? `
                                                <div class="checklist-item-note" onclick="event.stopPropagation()">
                                                    <input type="text"
                                                           placeholder="Agregar nota..."
                                                           value="${itemState.note || ''}"
                                                           onchange="updateChecklistNote('${item.id}', this.value)">
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            updateChecklistProgress();
        }

        function toggleChecklistGroup(groupId) {
            const group = document.getElementById(`group-${groupId}`);
            group.classList.toggle('expanded');
        }

        function toggleChecklistItem(itemId) {
            if (!checklistState[itemId]) {
                checklistState[itemId] = { completed: false, note: '' };
            }
            checklistState[itemId].completed = !checklistState[itemId].completed;
            saveChecklistState();
            renderChecklist();
        }

        function updateChecklistNote(itemId, note) {
            if (checklistState[itemId]) {
                checklistState[itemId].note = note;
                saveChecklistState();
            }
        }

        function updateChecklistProgress() {
            let completed = 0;
            let total = 0;

            negotiationChecklist.forEach(group => {
                group.items.forEach(item => {
                    total++;
                    if (checklistState[item.id]?.completed) {
                        completed++;
                    }
                });
            });

            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('checklistProgressFill').style.width = `${percentage}%`;
            document.getElementById('checklistProgressItems').textContent = `${completed} de ${total} puntos completados`;
            document.getElementById('checklistProgressPercent').textContent = `${percentage}%`;
        }

        function markAllChecklist(completed) {
            negotiationChecklist.forEach(group => {
                group.items.forEach(item => {
                    if (!checklistState[item.id]) {
                        checklistState[item.id] = { completed: false, note: '' };
                    }
                    checklistState[item.id].completed = completed;
                    if (!completed) {
                        checklistState[item.id].note = '';
                    }
                });
            });
            saveChecklistState();
            renderChecklist();
        }

        function exportChecklistSummary() {
            const summary = document.getElementById('checklistSummary');
            const content = document.getElementById('checklistSummaryContent');

            let text = `RESUMEN DE NEGOCIACIÓN - ALIANZA ESTRATÉGICA
Fecha: ${new Date().toLocaleDateString('es-MX')}

${'═'.repeat(50)}

`;

            let completedCount = 0;
            let totalCount = 0;

            negotiationChecklist.forEach(group => {
                const groupItems = group.items.filter(item => checklistState[item.id]?.completed);
                if (groupItems.length > 0) {
                    text += `\n${group.icon} ${group.title.toUpperCase()}\n${'─'.repeat(40)}\n`;

                    groupItems.forEach(item => {
                        const note = checklistState[item.id]?.note;
                        text += `✓ ${item.text}`;
                        if (note) {
                            text += `\n  → Nota: ${note}`;
                        }
                        text += '\n';
                        completedCount++;
                    });
                }
                totalCount += group.items.length;
            });

            const pendingItems = [];
            negotiationChecklist.forEach(group => {
                group.items.forEach(item => {
                    if (!checklistState[item.id]?.completed) {
                        pendingItems.push({ group: group.title, item: item.text });
                    }
                });
            });

            if (pendingItems.length > 0) {
                text += `\n\n⏳ PUNTOS PENDIENTES\n${'─'.repeat(40)}\n`;
                pendingItems.forEach(p => {
                    text += `○ [${p.group}] ${p.item}\n`;
                });
            }

            text += `\n${'═'.repeat(50)}
Progreso: ${completedCount}/${totalCount} (${Math.round(completedCount/totalCount*100)}%)
`;

            content.textContent = text;
            summary.classList.add('visible');

            // Copiar al portapapeles
            navigator.clipboard.writeText(text).then(() => {
                alert('✅ Resumen copiado al portapapeles');
            }).catch(() => {
                // Fallback
            });
        }

        // ========== CLÁUSULAS CONTRACTUALES SUGERIDAS ==========

        const contractClauses = [
            // Financieras
            {
                id: 'retainer',
                category: 'financial',
                priority: 'essential',
                title: 'Iguala Mensual (Retainer Fee)',
                description: 'Establece el pago mensual garantizado por servicios de desarrollo.',
                template: `CLÁUSULA DE RETAINER: Las partes acuerdan una iguala mensual de $[RETAINER] MXN (pesos mexicanos), pagadera dentro de los primeros 5 días hábiles de cada mes. Este monto incluye hasta [HORAS] horas de trabajo mensual. Las horas adicionales se facturarán a una tarifa de $[TARIFA_EXTRA] MXN por hora.`
            },
            {
                id: 'payment_terms',
                category: 'financial',
                priority: 'essential',
                title: 'Términos de Pago',
                description: 'Define plazos, métodos de pago y consecuencias por retrasos.',
                template: `CLÁUSULA DE PAGOS: Los pagos se realizarán mediante transferencia bancaria. En caso de retraso superior a 15 días, se aplicará un interés moratorio del 2% mensual. Los proyectos adicionales se facturarán 50% al inicio y 50% a la entrega.`
            },
            {
                id: 'ip_split',
                category: 'ip',
                priority: 'essential',
                title: 'División de Propiedad Intelectual',
                description: 'Establece cómo se divide la PI de los proyectos desarrollados.',
                template: `CLÁUSULA DE PROPIEDAD INTELECTUAL: Los derechos de propiedad intelectual de los desarrollos realizados conjuntamente se dividirán en [IP_ESTUDIO]% para el Estudio y [IP_AGENCIA]% para la Agencia. Esta división aplica a ingresos por licenciamiento, venta y cualquier forma de comercialización.`
            },
            {
                id: 'ip_preexisting',
                category: 'ip',
                priority: 'recommended',
                title: 'PI Preexistente',
                description: 'Protege la propiedad intelectual que cada parte trae a la alianza.',
                template: `CLÁUSULA DE PI PREEXISTENTE: Cada parte conserva la propiedad exclusiva de su propiedad intelectual preexistente. Cualquier uso de PI preexistente en proyectos conjuntos requerirá autorización escrita y no transferirá derechos adicionales.`
            },
            {
                id: 'ip_improvements',
                category: 'ip',
                priority: 'recommended',
                title: 'Mejoras y Derivados',
                description: 'Define quién posee las mejoras a desarrollos existentes.',
                template: `CLÁUSULA DE MEJORAS: Las mejoras, modificaciones o trabajos derivados de desarrollos conjuntos seguirán la misma división de PI acordada. Las mejoras a PI preexistente pertenecerán a la parte propietaria original.`
            },
            {
                id: 'finder_fee',
                category: 'financial',
                priority: 'recommended',
                title: "Comisión por Referidos (Finder's Fee)",
                description: 'Establece la comisión por referir clientes o proyectos.',
                template: `CLÁUSULA DE FINDER'S FEE: La parte que refiera un cliente o proyecto recibirá una comisión del [FINDER_FEE]% sobre el valor total del contrato referido. Esta comisión se pagará dentro de los 30 días siguientes al primer pago recibido del cliente.`
            },
            {
                id: 'equity',
                category: 'financial',
                priority: 'optional',
                title: 'Stock Options / Participación Accionaria',
                description: 'Establece opciones de compra de acciones entre las partes.',
                template: `CLÁUSULA DE STOCK OPTIONS: Las partes se otorgan mutuamente opciones para adquirir el [EQUITY_PERCENT]% del capital social. Estas opciones tendrán un periodo de vesting de [VESTING] meses con un cliff de [CLIFF] meses. El precio de ejercicio será la valuación actual acordada.`
            },
            {
                id: 'confidentiality',
                category: 'operations',
                priority: 'essential',
                title: 'Confidencialidad',
                description: 'Protege la información sensible compartida entre las partes.',
                template: `CLÁUSULA DE CONFIDENCIALIDAD: Las partes se comprometen a mantener estricta confidencialidad sobre información técnica, comercial, financiera y estratégica. Esta obligación permanecerá vigente durante 3 años después de terminada la alianza.`
            },
            {
                id: 'exclusivity',
                category: 'operations',
                priority: 'optional',
                title: 'Exclusividad',
                description: 'Define si la alianza es exclusiva en ciertos mercados o servicios.',
                template: `CLÁUSULA DE EXCLUSIVIDAD: Durante la vigencia de este acuerdo, las partes se comprometen a no establecer alianzas similares con competidores directos en el mercado de [MERCADO]. Esta exclusividad no limita proyectos individuales fuera del alcance de la alianza.`
            },
            {
                id: 'non_compete',
                category: 'operations',
                priority: 'optional',
                title: 'No Competencia',
                description: 'Restricciones sobre competir directamente durante y después de la alianza.',
                template: `CLÁUSULA DE NO COMPETENCIA: Durante la vigencia y por 12 meses posteriores, las partes no desarrollarán productos que compitan directamente con los desarrollos conjuntos sin previo acuerdo escrito.`
            },
            {
                id: 'delivery_standards',
                category: 'operations',
                priority: 'recommended',
                title: 'Estándares de Entrega',
                description: 'Define los estándares de calidad y tiempos de entrega.',
                template: `CLÁUSULA DE ESTÁNDARES: Los entregables cumplirán con estándares de calidad acordados, incluyendo documentación técnica, código comentado y pruebas. Los tiempos de entrega se acordarán por proyecto y cualquier retraso significativo se comunicará con al menos 5 días de anticipación.`
            },
            {
                id: 'communication',
                category: 'operations',
                priority: 'recommended',
                title: 'Comunicación y Reportes',
                description: 'Establece la frecuencia y formato de comunicación entre las partes.',
                template: `CLÁUSULA DE COMUNICACIÓN: Las partes sostendrán reuniones de seguimiento [FRECUENCIA]. Se mantendrá un canal de comunicación directa para asuntos urgentes. Los reportes de avance se entregarán mensualmente incluyendo horas trabajadas, entregables y próximos pasos.`
            },
            {
                id: 'termination',
                category: 'exit',
                priority: 'essential',
                title: 'Terminación del Acuerdo',
                description: 'Condiciones y proceso para terminar la alianza.',
                template: `CLÁUSULA DE TERMINACIÓN: Cualquier parte podrá terminar este acuerdo con 60 días de aviso previo por escrito. En caso de incumplimiento material, la parte afectada podrá terminar inmediatamente después de un periodo de cura de 15 días.`
            },
            {
                id: 'post_termination',
                category: 'exit',
                priority: 'recommended',
                title: 'Obligaciones Post-Terminación',
                description: 'Define qué sucede con los proyectos en curso al terminar.',
                template: `CLÁUSULA POST-TERMINACIÓN: Al terminar la alianza, los proyectos en curso se completarán o transferirán según se acuerde. La división de PI acordada permanecerá vigente. Los pagos pendientes se liquidarán dentro de 30 días.`
            },
            {
                id: 'dispute_resolution',
                category: 'exit',
                priority: 'essential',
                title: 'Resolución de Disputas',
                description: 'Mecanismo para resolver conflictos entre las partes.',
                template: `CLÁUSULA DE DISPUTAS: Las controversias se resolverán primero mediante negociación directa. De no alcanzar acuerdo en 30 días, se someterán a mediación. Como última instancia, se acudirá a arbitraje conforme a las reglas del Centro de Arbitraje de México.`
            },
            {
                id: 'liability',
                category: 'exit',
                priority: 'recommended',
                title: 'Limitación de Responsabilidad',
                description: 'Limita la responsabilidad de cada parte en caso de problemas.',
                template: `CLÁUSULA DE RESPONSABILIDAD: La responsabilidad máxima de cada parte se limitará al monto total pagado en los últimos 12 meses. Ninguna parte será responsable por daños indirectos, consecuentes o pérdida de ganancias.`
            },
            {
                id: 'force_majeure',
                category: 'exit',
                priority: 'optional',
                title: 'Fuerza Mayor',
                description: 'Define qué sucede en caso de eventos fuera del control de las partes.',
                template: `CLÁUSULA DE FUERZA MAYOR: Ninguna parte será responsable por incumplimiento debido a eventos fuera de su control razonable (desastres naturales, pandemias, conflictos, etc.). La parte afectada notificará dentro de 5 días y las obligaciones se suspenderán proporcionalmente.`
            }
        ];

        let selectedClauses = new Set();
        let currentClauseCategory = 'all';

        function renderClauses() {
            const list = document.getElementById('clausesList');
            const filteredClauses = currentClauseCategory === 'all'
                ? contractClauses
                : contractClauses.filter(c => c.category === currentClauseCategory);

            list.innerHTML = filteredClauses.map(clause => {
                const isSelected = selectedClauses.has(clause.id);
                const priorityLabels = {
                    essential: { text: 'Esencial', class: 'essential' },
                    recommended: { text: 'Recomendada', class: 'recommended' },
                    optional: { text: 'Opcional', class: 'optional' }
                };
                const priority = priorityLabels[clause.priority];

                return `
                    <div class="clause-item ${isSelected ? 'selected' : ''}" onclick="toggleClause('${clause.id}')">
                        <div class="clause-header">
                            <input type="checkbox" class="clause-checkbox"
                                ${isSelected ? 'checked' : ''}
                                onclick="event.stopPropagation(); toggleClause('${clause.id}')">
                            <div class="clause-content">
                                <div class="clause-title">
                                    ${clause.title}
                                    <span class="tag ${priority.class}">${priority.text}</span>
                                </div>
                                <div class="clause-description">${clause.description}</div>
                                <div class="clause-preview">${fillClauseTemplate(clause.template)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateClausesCounter();
        }

        function fillClauseTemplate(template) {
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);
            const horasIncluidas = Math.floor(state.retainer / tarifaAjustada);

            return template
                .replace('[RETAINER]', state.retainer.toLocaleString())
                .replace('[HORAS]', horasIncluidas)
                .replace('[TARIFA_EXTRA]', Math.round(tarifaAjustada * 1.25).toLocaleString())
                .replace('[IP_ESTUDIO]', state.ipSplit)
                .replace('[IP_AGENCIA]', 100 - state.ipSplit)
                .replace('[FINDER_FEE]', state.finderFee)
                .replace('[EQUITY_PERCENT]', state.equityPercent)
                .replace('[VESTING]', state.vestingPeriod)
                .replace('[CLIFF]', state.cliffPeriod)
                .replace('[MERCADO]', 'desarrollo de aplicaciones de IA')
                .replace('[FRECUENCIA]', 'semanales');
        }

        function toggleClause(clauseId) {
            if (selectedClauses.has(clauseId)) {
                selectedClauses.delete(clauseId);
            } else {
                selectedClauses.add(clauseId);
            }
            renderClauses();
        }

        function filterClauses(category) {
            currentClauseCategory = category;

            // Actualizar tabs activos
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            const categoryMap = {
                all: 'catAll',
                financial: 'catFinancial',
                ip: 'catIp',
                operations: 'catOperations',
                exit: 'catExit'
            };
            document.getElementById(categoryMap[category]).classList.add('active');

            renderClauses();
        }

        function selectEssentialClauses() {
            contractClauses
                .filter(c => c.priority === 'essential')
                .forEach(c => selectedClauses.add(c.id));
            renderClauses();
        }

        function clearAllClauses() {
            selectedClauses.clear();
            renderClauses();
            document.getElementById('clausesOutput').classList.remove('visible');
        }

        function updateClausesCounter() {
            const counter = document.getElementById('clausesCounter');
            const count = selectedClauses.size;
            counter.textContent = `${count} cláusula${count !== 1 ? 's' : ''} seleccionada${count !== 1 ? 's' : ''}`;
        }

        function generateClausesDocument() {
            const selected = contractClauses.filter(c => selectedClauses.has(c.id));

            if (selected.length === 0) {
                return 'No hay cláusulas seleccionadas.';
            }

            const today = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let doc = `CLÁUSULAS CONTRACTUALES - ALIANZA ESTRATÉGICA
Estudio de Desarrollo de IA + Agencia de Creatividad
Fecha de generación: ${today}

${'═'.repeat(60)}

`;

            const categories = {
                financial: '💰 CLÁUSULAS FINANCIERAS',
                ip: '📜 PROPIEDAD INTELECTUAL',
                operations: '⚙️ CLÁUSULAS OPERATIVAS',
                exit: '🚪 TERMINACIÓN Y SALIDA'
            };

            // Agrupar por categoría
            const grouped = {};
            selected.forEach(clause => {
                if (!grouped[clause.category]) {
                    grouped[clause.category] = [];
                }
                grouped[clause.category].push(clause);
            });

            let clauseNumber = 1;
            for (const [category, clauses] of Object.entries(grouped)) {
                doc += `\n${categories[category]}\n${'─'.repeat(40)}\n\n`;

                clauses.forEach(clause => {
                    doc += `${clauseNumber}. ${clause.title.toUpperCase()}\n\n`;
                    doc += `${fillClauseTemplate(clause.template)}\n\n`;
                    clauseNumber++;
                });
            }

            doc += `${'═'.repeat(60)}

FIRMAS

_____________________________          _____________________________
Por el Estudio de IA                   Por la Agencia de Creatividad
Nombre:                                Nombre:
Cargo:                                 Cargo:
Fecha:                                 Fecha:

Este documento es un borrador generado automáticamente y debe ser revisado por asesores legales antes de su firma.`;

            return doc;
        }

        function copySelectedClauses() {
            if (selectedClauses.size === 0) {
                alert('Por favor selecciona al menos una cláusula.');
                return;
            }

            const doc = generateClausesDocument();
            const output = document.getElementById('clausesOutput');
            const content = document.getElementById('clausesOutputContent');

            content.textContent = doc;
            output.classList.add('visible');

            // Copiar al portapapeles
            navigator.clipboard.writeText(doc).then(() => {
                alert('✅ Cláusulas copiadas al portapapeles');
            }).catch(() => {
                alert('El documento está listo. Selecciona el texto manualmente para copiar.');
            });
        }

        function toggleClausesOutput() {
            document.getElementById('clausesOutput').classList.toggle('visible');
        }

        // ========== RESUMEN EJECUTIVO COPIABLE ==========

        let currentSummaryFormat = 'formal';

        function setSummaryFormat(format) {
            currentSummaryFormat = format;

            // Actualizar botones activos
            document.querySelectorAll('.format-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`format${format.charAt(0).toUpperCase() + format.slice(1)}`).classList.add('active');

            generateSummary();
        }

        function generateSummary() {
            const preview = document.getElementById('summaryPreview');
            const tarifaAjustada = calcularTarifaAjustada(state.ipSplit);
            const horasIncluidas = Math.floor(state.retainer / tarifaAjustada);

            // Calcular totales
            const retainerTotal = state.retainer * state.duration;

            // Calcular gastos totales de todos los proyectos
            const totalExpenses = getTotalExpenses();

            // IP Bruto
            const ipGross = state.projects
                .filter(p => p.type === 'cliente')
                .reduce((sum, p) => sum + (p.value * state.ipSplit / 100), 0);

            // IP Neto (después de gastos)
            const ipTotal = Math.max(0, ipGross - totalExpenses);

            const finderTotal = state.referrals
                .reduce((sum, r) => sum + (r.value * state.finderFee / 100), 0);
            const equityPct = state.equityPercent / 100;
            const equityValue = (state.agencyFutureValue - state.agencyValuation) * equityPct;
            const grandTotal = retainerTotal + ipTotal + finderTotal + equityValue;
            const monthlyAvg = Math.round(grandTotal / state.duration);

            let summary = '';

            switch (currentSummaryFormat) {
                case 'formal':
                    summary = generateFormalSummary({
                        retainer: state.retainer,
                        horasIncluidas,
                        tarifaAjustada,
                        ipSplit: state.ipSplit,
                        duration: state.duration,
                        finderFee: state.finderFee,
                        equityPercent: state.equityPercent,
                        vestingPeriod: state.vestingPeriod,
                        cliffPeriod: state.cliffPeriod,
                        retainerTotal,
                        ipTotal,
                        finderTotal,
                        equityValue,
                        grandTotal,
                        monthlyAvg,
                        projectCount: state.projects.length
                    });
                    break;

                case 'bullet':
                    summary = generateBulletSummary({
                        retainer: state.retainer,
                        horasIncluidas,
                        tarifaAjustada,
                        ipSplit: state.ipSplit,
                        duration: state.duration,
                        finderFee: state.finderFee,
                        equityPercent: state.equityPercent,
                        vestingPeriod: state.vestingPeriod,
                        retainerTotal,
                        grandTotal,
                        monthlyAvg
                    });
                    break;

                case 'brief':
                    summary = generateBriefSummary({
                        retainer: state.retainer,
                        ipSplit: state.ipSplit,
                        duration: state.duration,
                        grandTotal,
                        monthlyAvg
                    });
                    break;
            }

            preview.textContent = summary;
        }

        function generateFormalSummary(data) {
            const today = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            return `PROPUESTA DE ALIANZA ESTRATÉGICA
Estudio de Desarrollo de IA + Agencia de Creatividad
Fecha: ${today}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

TÉRMINOS PRINCIPALES DEL ACUERDO

1. IGUALA MENSUAL (RETAINER)
   • Monto mensual: $${data.retainer.toLocaleString()} MXN
   • Horas incluidas: ${data.horasIncluidas} hrs/mes
   • Tarifa por hora: $${data.tarifaAjustada.toFixed(0)} MXN
   • Duración del contrato: ${data.duration} meses
   • Total del periodo: $${data.retainerTotal.toLocaleString()} MXN

2. PROPIEDAD INTELECTUAL
   • Participación del Estudio: ${data.ipSplit}%
   • Participación de la Agencia: ${100 - data.ipSplit}%
   • Aplica a todos los proyectos desarrollados en conjunto

3. COMISIONES POR REFERIDOS (FINDER'S FEE)
   • Porcentaje: ${data.finderFee}%
   • Aplica a proyectos referidos por cualquiera de las partes

4. PARTICIPACIÓN ACCIONARIA (STOCK OPTIONS)
   • Porcentaje de opciones: ${data.equityPercent}%
   • Periodo de vesting: ${data.vestingPeriod} meses
   • Periodo de cliff: ${data.cliffPeriod} meses

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

PROYECCIÓN FINANCIERA (${data.duration} meses)

   Ingresos por Retainer:      $${data.retainerTotal.toLocaleString()} MXN
   Ingresos por PI estimados:  $${data.ipTotal.toLocaleString()} MXN
   Finder's Fee estimado:      $${data.finderTotal.toLocaleString()} MXN
   Valor potencial de Equity:  $${data.equityValue.toLocaleString()} MXN
   ─────────────────────────────────────
   TOTAL PROYECTADO:           $${data.grandTotal.toLocaleString()} MXN
   Promedio mensual:           $${data.monthlyAvg.toLocaleString()} MXN

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Este documento es una propuesta preliminar sujeta a negociación.
Los montos proyectados son estimaciones basadas en ${data.projectCount} proyectos simulados.

Quedo atento a sus comentarios para agendar una reunión.

Saludos cordiales.`;
        }

        function generateBulletSummary(data) {
            return `📋 RESUMEN DE PROPUESTA - ALIANZA ESTRATÉGICA

💰 FINANCIERO
• Retainer: $${data.retainer.toLocaleString()} MXN/mes (${data.horasIncluidas} hrs incluidas)
• Tarifa hora extra: $${data.tarifaAjustada.toFixed(0)} MXN
• Duración: ${data.duration} meses
• Total retainer: $${data.retainerTotal.toLocaleString()} MXN

📜 PROPIEDAD INTELECTUAL
• División: ${data.ipSplit}% Estudio / ${100 - data.ipSplit}% Agencia
• Aplica a proyectos para clientes externos

🤝 REFERIDOS
• Finder's fee: ${data.finderFee}% por proyecto referido

📈 EQUITY
• Stock options: ${data.equityPercent}%
• Vesting: ${data.vestingPeriod} meses

💵 PROYECCIÓN TOTAL
• Ingreso proyectado: $${data.grandTotal.toLocaleString()} MXN
• Promedio mensual: $${data.monthlyAvg.toLocaleString()} MXN

━━━━━━━━━━━━━━━━━━━━
Propuesta sujeta a negociación.`;
        }

        function generateBriefSummary(data) {
            return `Propuesta de Alianza: $${data.retainer.toLocaleString()}/mes × ${data.duration} meses | PI: ${data.ipSplit}/${100-data.ipSplit} | Total proyectado: $${data.grandTotal.toLocaleString()} MXN (~$${data.monthlyAvg.toLocaleString()}/mes)`;
        }

        async function copySummaryToClipboard() {
            const preview = document.getElementById('summaryPreview');
            const btn = document.getElementById('copyBtn');
            const btnText = document.getElementById('copyBtnText');

            try {
                await navigator.clipboard.writeText(preview.textContent);

                // Feedback visual
                btn.classList.add('copied');
                btnText.textContent = '¡Copiado!';

                setTimeout(() => {
                    btn.classList.remove('copied');
                    btnText.textContent = 'Copiar al portapapeles';
                }, 2000);
            } catch (err) {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = preview.textContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    btn.classList.add('copied');
                    btnText.textContent = '¡Copiado!';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        btnText.textContent = 'Copiar al portapapeles';
                    }, 2000);
                } catch (e) {
                    alert('No se pudo copiar. Por favor selecciona el texto manualmente.');
                }
                document.body.removeChild(textArea);
            }
        }

        function resetAll() {
            if (!confirm('¿Estás seguro de que deseas resetear toda la configuración?')) {
                return;
            }

            state.projects = [];
            state.referrals = [];
            state.retainer = 25000;
            state.ipSplit = 50;
            state.duration = 24;
            state.finderFee = 10;
            state.studioValuation = 5000000;
            state.studioFutureValue = 15000000;
            state.agencyValuation = 7500000;
            state.agencyFutureValue = 25000000;
            state.equityPercent = 3;
            state.vestingPeriod = 36;

            updateUIFromState();
            document.getElementById('vestingPeriod').value = state.vestingPeriod;

            // Resetear tipo de retainer a horas
            state.retainerType = 'hours';
            document.getElementById('toggleHours').classList.add('active');
            document.getElementById('toggleProjects').classList.remove('active');
            updateRetainerLabels();
            updateRetainerDisplay();

            updateProjectsTable();
            updateReferralsTable();
            updateAllCalculations();
        }
    </script>

    <!-- ALERTAS INTELIGENTES -->
    <button class="alerts-toggle" id="alertsToggle" onclick="toggleAlertsPanel()">
        🔔
        <span class="badge" id="alertsBadge">0</span>
    </button>

    <div class="alerts-container">
        <div class="alerts-panel" id="alertsPanel">
            <div class="alerts-panel-header">
                <h4>🔔 Alertas Inteligentes</h4>
                <button onclick="toggleAlertsPanel()" style="background:none;border:none;color:white;font-size:1.2rem;cursor:pointer;">✕</button>
            </div>
            <div class="alerts-panel-body" id="alertsPanelBody">
                <!-- Se llena con JavaScript -->
            </div>
        </div>
    </div>
</body>
</html>